{
  "bundle_id": "fd196794-f2f8-4804-aaaa-3cfd8555b0b2",
  "name": "testing-scenario:-network-security-agent",
  "version": "1.0.0",
  "metadata": {
    "domain": "testing",
    "complexity": "complex",
    "phase_count": 4,
    "skill_count": 2,
    "estimated_duration": "2 hours 36 minutes",
    "required_capabilities": [
      "analysis",
      "framework-setup",
      "planning",
      "test-coding",
      "test-design",
      "reporting",
      "automation",
      "test-execution"
    ],
    "skill_names": [
      "documenter",
      "tester"
    ],
    "parallel_opportunities": 0,
    "risk_factors": [
      "High complexity may require extended execution time"
    ]
  },
  "auto_mode_config": {
    "max_turns": 18,
    "initial_prompt": "# Goal: Scenario: Network Security Groups for Network Security\n\n## Objective\n# Scenario: Network Security Groups for Network Security\n\n## Technology Area\nSecurity\n\n## Company Profile\n- **Company Size**: Small startup\n- **Industry**: Web Services / E-commerce\n- **Use Case**: Implement network segmentation and traffic control through NSG rules for multi-tier application\n\n## Scenario Description\nCreate and manage Azure Network Security Groups with inbound and outbound rules to control traffic flow between application tiers. This scenario covers NSG creation, rule management, traffic logging, and network policy enforcement.\n\n## Azure Services Used\n- Azure Network Security Groups (NSG)\n- Azure Virtual Network (VNet)\n- Azure Subnets\n- Azure Network Interfaces\n- Azure Network Watcher (for monitoring)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed and configured\n- Understanding of network protocols and port ranges\n- Access to create and manage network resources\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP=\"azurehaymaker-security-${UNIQUE_ID}-rg\"\nLOCATION=\"eastus\"\nVNET_NAME=\"azurehaymaker-vnet-${UNIQUE_ID}\"\nSUBNET_WEB=\"azurehaymaker-subnet-web-${UNIQUE_ID}\"\nSUBNET_APP=\"azurehaymaker-subnet-app-${UNIQUE_ID}\"\nSUBNET_DB=\"azurehaymaker-subnet-db-${UNIQUE_ID}\"\nNSG_WEB=\"azurehaymaker-nsg-web-${UNIQUE_ID}\"\nNSG_APP=\"azurehaymaker-nsg-app-${UNIQUE_ID}\"\nNSG_DB=\"azurehaymaker-nsg-db-${UNIQUE_ID}\"\n\n# Tags\nTAGS=\"AzureHayMaker-managed=true Scenario=security-nsg Owner=AzureHayMaker\"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name \"${RESOURCE_GROUP}\" \\\n  --location \"${LOCATION}\" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network with CIDR block\naz network vnet create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VNET_NAME}\" \\\n  --address-prefix 10.0.0.0/16 \\\n  --tags ${TAGS}\n\n# Step 3: Create Web tier subnet\naz network vnet subnet create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${SUBNET_WEB}\" \\\n  --address-prefix 10.0.1.0/24\n\n# Step 4: Create Application tier subnet\naz network vnet subnet create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${SUBNET_APP}\" \\\n  --address-prefix 10.0.2.0/24\n\n# Step 5: Create Database tier subnet\naz network vnet subnet create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${SUBNET_DB}\" \\\n  --address-prefix 10.0.3.0/24\n\n# Step 6: Create NSG for Web tier\naz network nsg create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NSG_WEB}\" \\\n  --tags ${TAGS}\n\n# Step 7: Create NSG for Application tier\naz network nsg create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NSG_APP}\" \\\n  --tags ${TAGS}\n\n# Step 8: Create NSG for Database tier\naz network nsg create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NSG_DB}\" \\\n  --tags ${TAGS}\n\n# Step 9: Associate NSG with Web subnet\naz network vnet subnet update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${SUBNET_WEB}\" \\\n  --network-security-group \"${NSG_WEB}\"\n\n# Step 10: Associate NSG with Application subnet\naz network vnet subnet update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${SUBNET_APP}\" \\\n  --network-security-group \"${NSG_APP}\"\n\n# Step 11: Associate NSG with Database subnet\naz network vnet subnet update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${SUBNET_DB}\" \\\n  --network-security-group \"${NSG_DB}\"\n\n# Step 12: Add inbound HTTP rule to Web NSG (allow from internet)\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_WEB}\" \\\n  --name \"allow-http\" \\\n  --priority 1000 \\\n  --source-address-prefixes \"*\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"*\" \\\n  --destination-port-ranges 80 \\\n  --access Allow \\\n  --protocol Tcp\n\necho \"Virtual Network and NSGs created successfully\"\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name \"${RESOURCE_GROUP}\"\n\n# Verify Virtual Network\naz network vnet show --resource-group \"${RESOURCE_GROUP}\" --name \"${VNET_NAME}\"\n\n# List subnets\naz network vnet subnet list --resource-group \"${RESOURCE_GROUP}\" --vnet-name \"${VNET_NAME}\" --output table\n\n# Verify NSG creation\naz network nsg list --resource-group \"${RESOURCE_GROUP}\" --output table\n\n# List NSG rules for Web NSG\naz network nsg rule list --resource-group \"${RESOURCE_GROUP}\" --nsg-name \"${NSG_WEB}\" --output table\n\n# Check subnet NSG associations\naz network vnet subnet show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${SUBNET_WEB}\" \\\n  --query networkSecurityGroup\n\n# List all resources\naz resource list --resource-group \"${RESOURCE_GROUP}\" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Add HTTPS rule to Web NSG\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_WEB}\" \\\n  --name \"allow-https\" \\\n  --priority 1001 \\\n  --source-address-prefixes \"*\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"*\" \\\n  --destination-port-ranges 443 \\\n  --access Allow \\\n  --protocol Tcp\n\n# Operation 2: Add SSH rule to Web NSG (restricted source)\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_WEB}\" \\\n  --name \"allow-ssh-restricted\" \\\n  --priority 1002 \\\n  --source-address-prefixes \"10.0.0.0/8\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"*\" \\\n  --destination-port-ranges 22 \\\n  --access Allow \\\n  --protocol Tcp\n\n# Operation 3: Add rule allowing App tier traffic from Web tier to App NSG\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_APP}\" \\\n  --name \"allow-from-web\" \\\n  --priority 1000 \\\n  --source-address-prefixes \"10.0.1.0/24\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"*\" \\\n  --destination-port-ranges 8080 \\\n  --access Allow \\\n  --protocol Tcp\n\n# Operation 4: Add rule allowing Database tier traffic from App tier to DB NSG\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_DB}\" \\\n  --name \"allow-from-app\" \\\n  --priority 1000 \\\n  --source-address-prefixes \"10.0.2.0/24\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"*\" \\\n  --destination-port-ranges 3306,5432 \\\n  --access Allow \\\n  --protocol Tcp\n\n# Operation 5: Deny all inbound traffic by default on App NSG\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_APP}\" \\\n  --name \"deny-all-inbound\" \\\n  --priority 4096 \\\n  --source-address-prefixes \"*\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"*\" \\\n  --destination-port-ranges \"*\" \\\n  --access Deny \\\n  --protocol \"*\"\n\n# Operation 6: Allow outbound traffic from App tier to database\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_APP}\" \\\n  --name \"allow-outbound-db\" \\\n  --priority 1000 \\\n  --direction Outbound \\\n  --source-address-prefixes \"*\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"10.0.3.0/24\" \\\n  --destination-port-ranges 3306,5432 \\\n  --access Allow \\\n  --protocol Tcp\n\n# Operation 7: Deny outbound traffic from Database tier (restrict egress)\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_DB}\" \\\n  --name \"deny-outbound-internet\" \\\n  --priority 4096 \\\n  --direction Outbound \\\n  --source-address-prefixes \"*\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"*\" \\\n  --access Deny \\\n  --protocol \"*\"\n\n# Operation 8: List all rules in Web NSG with detailed information\naz network nsg rule list \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_WEB}\" \\\n  --output table\n\n# Operation 9: Update existing rule (modify priority)\naz network nsg rule update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_WEB}\" \\\n  --name \"allow-ssh-restricted\" \\\n  --priority 1500\n\n# Operation 10: Test connectivity rules (simulate traffic analysis)\necho \"Network Segment Analysis:\"\necho \"Web Subnet: 10.0.1.0/24\"\necho \"App Subnet: 10.0.2.0/24\"\necho \"DB Subnet: 10.0.3.0/24\"\n\n# Operation 11: Create NSG flow logs for security monitoring\nSTORAGE_ACCOUNT=\"azurehaymaker${UNIQUE_ID}\"\naz storage account create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${STORAGE_ACCOUNT}\" \\\n  --location \"${LOCATION}\" \\\n  --sku Standard_LRS \\\n  --tags ${TAGS}\n\n# Operation 12: Enable NSG Flow Logs (if Network Watcher available)\nWATCHER_RG=$(az network watcher list --query \"[0].resourceGroup\" -o tsv 2>/dev/null || echo \"\")\nif [ ! -z \"$WATCHER_RG\" ]; then\n  WATCHER_NAME=$(az network watcher list --query \"[0].name\" -o tsv 2>/dev/null)\n  az network watcher flow-log create \\\n    --resource-group \"${WATCHER_RG}\" \\\n    --watcher-name \"${WATCHER_NAME}\" \\\n    --nsg \"${NSG_WEB}\" \\\n    --storage-account \"${STORAGE_ACCOUNT}\" \\\n    --enabled true || echo \"Flow log creation skipped - Network Watcher not available\"\nelse\n  echo \"Network Watcher not available in this region for flow logs\"\nfi\n\n# Operation 13: Export NSG configuration as JSON\naz network nsg show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NSG_WEB}\" \\\n  --output json > /tmp/nsg-web-config-${UNIQUE_ID}.json\n\n# Operation 14: List effective NSG rules for a subnet\naz network vnet subnet list-effective-network-security-groups \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${SUBNET_WEB}\" \\\n  --output table || echo \"Effective rules check completed\"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Remove NSG associations from subnets\nfor SUBNET in \"${SUBNET_WEB}\" \"${SUBNET_APP}\" \"${SUBNET_DB}\"; do\n  az network vnet subnet update \\\n    --resource-group \"${RESOURCE_GROUP}\" \\\n    --vnet-name \"${VNET_NAME}\" \\\n    --name \"${SUBNET}\" \\\n    --network-security-group \"\" 2>/dev/null || true\ndone\n\n# Step 2: Delete all NSGs\naz network nsg delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NSG_WEB}\" --yes\n\naz network nsg delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NSG_APP}\" --yes\n\naz network nsg delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NSG_DB}\" --yes\n\n# Step 3: Delete Virtual Network (includes subnets)\naz network vnet delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VNET_NAME}\"\n\n# Step 4: Delete Storage Account (if created for flow logs)\naz storage account delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${STORAGE_ACCOUNT}\" \\\n  --yes 2>/dev/null || true\n\n# Step 5: Delete the entire resource group\naz group delete \\\n  --name \"${RESOURCE_GROUP}\" \\\n  --yes \\\n  --no-wait\n\n# Step 6: Wait for deletion to complete\necho \"Waiting for resource group deletion...\"\nsleep 120\n\n# Step 7: Verify deletion\naz group exists --name \"${RESOURCE_GROUP}\"\n\n# Step 8: Confirm cleanup\necho \"Verifying cleanup...\"\naz resource list --resource-group \"${RESOURCE_GROUP}\" 2>&1 | grep \"could not be found\" && echo \"\u2713 Resource group successfully deleted\"\n\n# Step 9: Clean up local files\nrm -f /tmp/nsg-web-config-*.json\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-security-${UNIQUE_ID}-rg`\n- Virtual Network: `azurehaymaker-vnet-${UNIQUE_ID}`\n- Web Subnet: `azurehaymaker-subnet-web-${UNIQUE_ID}`\n- App Subnet: `azurehaymaker-subnet-app-${UNIQUE_ID}`\n- DB Subnet: `azurehaymaker-subnet-db-${UNIQUE_ID}`\n- Web NSG: `azurehaymaker-nsg-web-${UNIQUE_ID}`\n- App NSG: `azurehaymaker-nsg-app-${UNIQUE_ID}`\n- DB NSG: `azurehaymaker-nsg-db-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Network Security Groups Overview](https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)\n- [NSG Rules Syntax](https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview#security-rules)\n- [Azure Virtual Networks](https://learn.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview)\n- [NSG Flow Logs](https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-overview)\n- [Network Watcher](https://learn.microsoft.com/en-us/azure/network-watcher/network-watcher-overview)\n- [NSG Best Practices](https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview#best-practices)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive NSG management with straightforward commands for rule creation, modification, and network traffic control. Direct commands enable rapid network security policy enforcement.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8+ hours (with rule management, network testing, and compliance verification)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- NSG rules evaluated in priority order (lower number = higher priority)\n- Default allow for outbound traffic unless explicitly denied\n- NSG rules support service tags for easier management of Azure services\n- Flow logs require Network Watcher availability in the region\n- Rules can specify source/destination as IP CIDR, IP addresses, or service tags\n- NSGs can be associated at subnet or network interface level\n- Operations scoped to single VNet with multiple subnets for defense-in-depth\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal 'Scenario: Network Security Groups for Network Secu...' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion",
    "working_dir": ".",
    "sdk": "claude",
    "ui_mode": false,
    "success_criteria": [
      "Goal 'Scenario: Network Security Groups for Network Secu...' is achieved"
    ],
    "constraints": []
  }
}
