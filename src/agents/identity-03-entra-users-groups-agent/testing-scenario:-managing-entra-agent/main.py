#!/usr/bin/env python3
"""
testing-scenario:-managing-entra-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Managing Entra ID Users and Groups\n\n## Objective\n# Scenario: Managing Entra ID Users and Groups\n\n## Technology Area\nIdentity\n\n## Company Profile\n- **Company Size**: Mid-size\n- **Industry**: Technology Consulting\n- **Use Case**: Manage corporate user identities, group memberships, and organizational structure in cloud directory\n\n## Scenario Description\nCreate and manage Entra ID (Azure AD) users and groups representing corporate organizational structure. This scenario covers user provisioning, group creation, dynamic membership rules, and lifecycle management of identities within an enterprise directory.\n\n## Azure Services Used\n- Azure Entra ID (formerly Azure AD)\n- Azure AD Groups\n- User Management\n- Azure CLI\n- Directory Services\n\n## Prerequisites\n- Azure subscription with Global Administrator or User Administrator role\n- Azure CLI installed and configured\n- Appropriate permissions to create users and groups in Entra ID\n- Optional: Custom domain configured (for realistic email scenarios)\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-users-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nTENANT_ID=$(az account show --query tenantId -o tsv)\nUSER_PREFIX="azurehaymaker-user-${UNIQUE_ID}"\nGROUP_PREFIX="azurehaymaker-group-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=identity-entra-users-groups Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group for organizational resources\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create first Entra ID user\nUSER_01=$(az ad user create \\\n  --display-name "AzureHayMaker Test User 01" \\\n  --user-principal-name "${USER_PREFIX}-01@contoso.onmicrosoft.com" \\\n  --password "TempPassword123!@#" \\\n  --force-change-password-next-sign-in false \\\n  --output json)\n\nUSER_01_ID=$(echo $USER_01 | jq -r \'.id\')\nUSER_01_UPN=$(echo $USER_01 | jq -r \'.userPrincipalName\')\n\n# Step 3: Create second Entra ID user\nUSER_02=$(az ad user create \\\n  --display-name "AzureHayMaker Test User 02" \\\n  --user-principal-name "${USER_PREFIX}-02@contoso.onmicrosoft.com" \\\n  --password "TempPassword123!@#" \\\n  --force-change-password-next-sign-in true \\\n  --output json)\n\nUSER_02_ID=$(echo $USER_02 | jq -r \'.id\')\n\n# Step 4: Create third Entra ID user\nUSER_03=$(az ad user create \\\n  --display-name "AzureHayMaker Test User 03" \\\n  --user-principal-name "${USER_PREFIX}-03@contoso.onmicrosoft.com" \\\n  --password "TempPassword123!@#" \\\n  --output json)\n\nUSER_03_ID=$(echo $USER_03 | jq -r \'.id\')\n\n# Step 5: Create security group for engineers\nENG_GROUP=$(az ad group create \\\n  --display-name "${GROUP_PREFIX}-engineers" \\\n  --mail-nickname "azurehaymaker-engineers-${UNIQUE_ID}" \\\n  --output json)\n\nENG_GROUP_ID=$(echo $ENG_GROUP | jq -r \'.id\')\n\n# Step 6: Create security group for managers\nMGR_GROUP=$(az ad group create \\\n  --display-name "${GROUP_PREFIX}-managers" \\\n  --mail-nickname "azurehaymaker-managers-${UNIQUE_ID}" \\\n  --output json)\n\nMGR_GROUP_ID=$(echo $MGR_GROUP | jq -r \'.id\')\n\n# Step 7: Create organization group\nORG_GROUP=$(az ad group create \\\n  --display-name "${GROUP_PREFIX}-organization" \\\n  --mail-nickname "azurehaymaker-org-${UNIQUE_ID}" \\\n  --output json)\n\nORG_GROUP_ID=$(echo $ORG_GROUP | jq -r \'.id\')\n\n# Step 8: Add users to groups\naz ad group member add \\\n  --group "${ENG_GROUP_ID}" \\\n  --member-id "${USER_01_ID}"\n\naz ad group member add \\\n  --group "${ENG_GROUP_ID}" \\\n  --member-id "${USER_02_ID}"\n\naz ad group member add \\\n  --group "${MGR_GROUP_ID}" \\\n  --member-id "${USER_03_ID}"\n\n# Step 9: Add groups to organization group (nested groups)\naz ad group member add \\\n  --group "${ORG_GROUP_ID}" \\\n  --member-id "${ENG_GROUP_ID}"\n\naz ad group member add \\\n  --group "${ORG_GROUP_ID}" \\\n  --member-id "${MGR_GROUP_ID}"\n\necho "User 1 ID: ${USER_01_ID} - UPN: ${USER_01_UPN}"\necho "User 2 ID: ${USER_02_ID}"\necho "User 3 ID: ${USER_03_ID}"\necho "Engineers Group ID: ${ENG_GROUP_ID}"\necho "Managers Group ID: ${MGR_GROUP_ID}"\necho "Organization Group ID: ${ORG_GROUP_ID}"\n```\n\n### Validation\n```bash\n# Verify resource group\naz group show --name "${RESOURCE_GROUP}" --output table\n\n# List all created users\naz ad user list --filter "startswith(displayName, \'AzureHayMaker\')" --output table\n\n# Get details of first user\naz ad user show --id "${USER_01_ID}" --output table\n\n# Get details of second user\naz ad user show --id "${USER_02_ID}" --output table\n\n# Get details of third user\naz ad user show --id "${USER_03_ID}" --output table\n\n# List all created groups\naz ad group list --filter "startswith(displayName, \'${GROUP_PREFIX}\')" --output table\n\n# List members of engineers group\naz ad group member list --group "${ENG_GROUP_ID}" --output table\n\n# List members of managers group\naz ad group member list --group "${MGR_GROUP_ID}" --output table\n\n# List members of organization group (nested)\naz ad group member list --group "${ORG_GROUP_ID}" --output table\n\n# Verify user properties\naz ad user list --query "[].{DisplayName:displayName, UserPrincipalName:userPrincipalName, Id:id}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Update user display name\naz ad user update \\\n  --id "${USER_01_ID}" \\\n  --display-name "AzureHayMaker Senior Engineer 01"\n\n# Operation 2: Get user account status\naz ad user show \\\n  --id "${USER_02_ID}" \\\n  --query "[displayName, accountEnabled, userPrincipalName]" \\\n  --output table\n\n# Operation 3: Disable a user account\naz ad user update \\\n  --id "${USER_03_ID}" \\\n  --account-enabled false\n\n# Operation 4: Re-enable a user account\naz ad user update \\\n  --id "${USER_03_ID}" \\\n  --account-enabled true\n\n# Operation 5: Reset user password\naz ad user update \\\n  --id "${USER_02_ID}" \\\n  --password "NewTempPassword456!@#"\n\n# Operation 6: Remove user from group\naz ad group member remove \\\n  --group "${ENG_GROUP_ID}" \\\n  --member-id "${USER_02_ID}"\n\n# Operation 7: Add user to multiple groups\naz ad group member add \\\n  --group "${ENG_GROUP_ID}" \\\n  --member-id "${USER_02_ID}"\n\naz ad group member add \\\n  --group "${MGR_GROUP_ID}" \\\n  --member-id "${USER_02_ID}"\n\n# Operation 8: List all groups a user belongs to\naz ad user get-member-groups \\\n  --id "${USER_01_ID}" \\\n  --output table\n\n# Operation 9: Query users by property\naz ad user list \\\n  --filter "startswith(displayName, \'AzureHayMaker\')" \\\n  --query "[].{Name:displayName, UPN:userPrincipalName}" \\\n  --output table\n\n# Operation 10: Count members in a group\naz ad group member list \\\n  --group "${ENG_GROUP_ID}" \\\n  --query "length([*])" \\\n  --output tsv\n\n# Operation 11: Export group membership\naz ad group member list \\\n  --group "${ORG_GROUP_ID}" \\\n  --query "[].{DisplayName:displayName, Type:objectType, Id:id}" \\\n  --output table\n\n# Operation 12: Check user properties for last sign-in and other details\naz ad user list \\\n  --filter "startswith(displayName, \'AzureHayMaker\')" \\\n  --query "[].{DisplayName:displayName, Enabled:accountEnabled}" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Remove users from all groups\naz ad group member remove \\\n  --group "${ENG_GROUP_ID}" \\\n  --member-id "${USER_01_ID}" \\\n  2>/dev/null || true\n\naz ad group member remove \\\n  --group "${ENG_GROUP_ID}" \\\n  --member-id "${USER_02_ID}" \\\n  2>/dev/null || true\n\naz ad group member remove \\\n  --group "${MGR_GROUP_ID}" \\\n  --member-id "${USER_03_ID}" \\\n  2>/dev/null || true\n\n# Step 2: Remove nested group membership\naz ad group member remove \\\n  --group "${ORG_GROUP_ID}" \\\n  --member-id "${ENG_GROUP_ID}" \\\n  2>/dev/null || true\n\naz ad group member remove \\\n  --group "${ORG_GROUP_ID}" \\\n  --member-id "${MGR_GROUP_ID}" \\\n  2>/dev/null || true\n\n# Step 3: Delete groups\naz ad group delete --group "${ENG_GROUP_ID}" 2>/dev/null || true\naz ad group delete --group "${MGR_GROUP_ID}" 2>/dev/null || true\naz ad group delete --group "${ORG_GROUP_ID}" 2>/dev/null || true\n\n# Step 4: Delete users\naz ad user delete --id "${USER_01_ID}" 2>/dev/null || true\naz ad user delete --id "${USER_02_ID}" 2>/dev/null || true\naz ad user delete --id "${USER_03_ID}" 2>/dev/null || true\n\n# Step 5: Delete resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 6: Wait for deletion\necho "Waiting for cleanup to complete..."\nsleep 60\n\n# Step 7: Verify users are deleted\naz ad user list --filter "startswith(displayName, \'AzureHayMaker\')" --output table\n\n# Step 8: Verify groups are deleted\naz ad group list --filter "startswith(displayName, \'${GROUP_PREFIX}\')" --output table\n\necho "Users and groups successfully cleaned up"\n```\n\n---\n\n## Resource Naming Convention\n- Users: `${USER_PREFIX}-[01-03]@contoso.onmicrosoft.com`\n- Engineers Group: `${GROUP_PREFIX}-engineers`\n- Managers Group: `${GROUP_PREFIX}-managers`\n- Organization Group: `${GROUP_PREFIX}-organization`\n- Resource Group: `azurehaymaker-users-${UNIQUE_ID}-rg`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Manage Users in Entra ID](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/how-to-create-delete-users-azure-ad)\n- [Manage Groups in Entra ID](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/how-to-manage-groups)\n- [Group Membership Rules](https://learn.microsoft.com/en-us/azure/active-directory/enterprise-users/groups-dynamic-membership)\n- [Azure CLI AD Commands](https://learn.microsoft.com/en-us/cli/azure/ad)\n- [Entra ID User and Group Management](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-manage-groups)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive user and group management capabilities with straightforward commands for creating, updating, and organizing identities. The CLI is ideal for bulk operations and automation of identity lifecycle management.\n\n---\n\n## Estimated Duration\n- **Deployment**: 5-10 minutes\n- **Operations Phase**: 8+ hours (user management, group membership, access reviews)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- Users are provisioned with temporary passwords that may require change at next sign-in\n- Groups support nested membership (groups within groups) for organizational hierarchy\n- Dynamic group membership rules can automatically add/remove users based on attributes\n- User account enabled/disabled status controls sign-in capabilities\n- All user and group operations are tenant-scoped\n- Bulk operations should be used for large-scale user provisioning\n- Group classification can enhance security and compliance policies\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Managing Entra ID Users and Groups...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": ["Goal 'Scenario: Managing Entra ID Users and Groups...' is achieved"],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-managing-entra-agent...")
    print("Goal: Scenario: Managing Entra ID Users and Groups")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
