#!/usr/bin/env python3
"""
automation-scenario:-creating-managing-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Creating and Managing Service Principals\n\n## Objective\n# Scenario: Creating and Managing Service Principals\n\n## Technology Area\nIdentity\n\n## Company Profile\n- **Company Size**: Mid-size\n- **Industry**: Financial Services\n- **Use Case**: Automated application authentication for microservices and CI/CD pipelines requiring programmatic Azure access\n\n## Scenario Description\nCreate and manage service principals for application authentication in Azure. This scenario covers service principal creation, credential management, role assignments, and operational tasks like credential rotation and audit logging. Service principals enable applications to authenticate to Azure services securely without human intervention.\n\n## Azure Services Used\n- Azure Entra ID (formerly Azure AD)\n- Azure Role-Based Access Control (RBAC)\n- Azure Service Principals\n- Azure CLI\n- Azure Key Vault (for credential storage reference)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed and configured\n- Appropriate permissions to create service principals in Entra ID\n- Existing resource group or permission to create one\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-identity-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nSP_NAME="azurehaymaker-sp-${UNIQUE_ID}"\nSUBSCRIPTION_ID=$(az account show --query id -o tsv)\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=identity-service-principals Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create first service principal\nSP_01=$(az ad sp create-for-rbac \\\n  --name "${SP_NAME}-01" \\\n  --role Contributor \\\n  --scopes "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}" \\\n  --output json)\n\n# Store the app ID and credentials\nSP_01_APP_ID=$(echo $SP_01 | jq -r \'.appId\')\nSP_01_TENANT=$(echo $SP_01 | jq -r \'.tenant\')\n\n# Step 3: Create second service principal with no role initially\nSP_02=$(az ad sp create-for-rbac \\\n  --name "${SP_NAME}-02" \\\n  --skip-assignment \\\n  --output json)\n\nSP_02_APP_ID=$(echo $SP_02 | jq -r \'.appId\')\n\n# Step 4: Get object ID of first service principal\nSP_01_OBJECT_ID=$(az ad sp show --id "${SP_01_APP_ID}" --query id -o tsv)\n\n# Step 5: Get object ID of second service principal\nSP_02_OBJECT_ID=$(az ad sp show --id "${SP_02_APP_ID}" --query id -o tsv)\n\n# Step 6: Create a service principal for resource read-only access\nSP_03=$(az ad sp create-for-rbac \\\n  --name "${SP_NAME}-03" \\\n  --role Reader \\\n  --scopes "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}" \\\n  --output json)\n\nSP_03_APP_ID=$(echo $SP_03 | jq -r \'.appId\')\nSP_03_OBJECT_ID=$(az ad sp show --id "${SP_03_APP_ID}" --query id -o tsv)\n\n# Step 7: Assign Reader role to second service principal\naz role assignment create \\\n  --assignee "${SP_02_OBJECT_ID}" \\\n  --role "Reader" \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}"\n\n# Step 8: Create additional credential for first service principal\nCRED=$(az ad sp credential reset \\\n  --id "${SP_01_APP_ID}" \\\n  --years 2 \\\n  --output json)\n\nCRED_ID=$(echo $CRED | jq -r \'.keyId\')\n\necho "Service Principal 1 - App ID: ${SP_01_APP_ID}"\necho "Service Principal 2 - App ID: ${SP_02_APP_ID}"\necho "Service Principal 3 - App ID: ${SP_03_APP_ID}"\necho "Credential ID: ${CRED_ID}"\n```\n\n### Validation\n```bash\n# Verify resource group\naz group show --name "${RESOURCE_GROUP}" --output table\n\n# List service principals created\naz ad sp list --filter "startswith(displayName, \'${SP_NAME}\')" --output table\n\n# Check service principal 1 details\naz ad sp show --id "${SP_01_APP_ID}" --output table\n\n# Check service principal 2 details\naz ad sp show --id "${SP_02_APP_ID}" --output table\n\n# Check service principal 3 details\naz ad sp show --id "${SP_03_APP_ID}" --output table\n\n# List all role assignments for resource group\naz role assignment list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --output table\n\n# Check credentials for first service principal\naz ad sp credential list --id "${SP_01_APP_ID}" --output table\n\n# Verify tag application\naz resource list --resource-group "${RESOURCE_GROUP}" --query "[].tags" -o json\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Update service principal display name and description\naz ad sp update \\\n  --id "${SP_01_APP_ID}" \\\n  --set displayName="azurehaymaker-sp-${UNIQUE_ID}-01-updated"\n\n# Operation 2: List all owners of service principal\naz ad sp owner list \\\n  --id "${SP_01_APP_ID}" \\\n  --output table\n\n# Operation 3: Rotate credentials for service principal (create new password)\nNEW_CRED=$(az ad sp credential reset \\\n  --id "${SP_02_APP_ID}" \\\n  --years 1 \\\n  --output json)\n\nNEW_PASSWORD=$(echo $NEW_CRED | jq -r \'.password\')\n\n# Operation 4: List all credentials (keys) for a service principal\naz ad sp credential list \\\n  --id "${SP_01_APP_ID}" \\\n  --output table\n\n# Operation 5: Add an Owner role assignment to service principal\nCURRENT_USER_ID=$(az account show --query user.objectId -o tsv)\naz role assignment create \\\n  --assignee-object-id "${SP_02_OBJECT_ID}" \\\n  --role "Owner" \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}"\n\n# Operation 6: Remove a role assignment\naz role assignment delete \\\n  --assignee "${SP_02_OBJECT_ID}" \\\n  --role "Reader" \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}"\n\n# Operation 7: Audit service principal activity - Check when password last changed\naz ad sp credential list --id "${SP_01_APP_ID}" --query "[].startDate" -o table\n\n# Operation 8: Create a federated credential for OIDC auth (simulated)\n# This demonstrates modern credential alternatives to passwords\naz identity create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "azurehaymaker-mi-${UNIQUE_ID}"\n\n# Operation 9: Assign service principal to custom role (if available)\naz role assignment create \\\n  --assignee "${SP_03_APP_ID}" \\\n  --role "Contributor" \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}"\n\n# Operation 10: Generate audit log for service principal activity\naz monitor activity-log list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --caller "${SP_01_APP_ID}" \\\n  --max-events 10 \\\n  --output table\n\n# Operation 11: Check principal type and app ownership\naz ad sp show --id "${SP_01_APP_ID}" --query "[displayName, appDisplayName, appId]" -o table\n\n# Operation 12: List all permissions granted to service principal\naz role assignment list \\\n  --assignee "${SP_01_APP_ID}" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete service principals\naz ad sp delete --id "${SP_01_APP_ID}"\naz ad sp delete --id "${SP_02_APP_ID}"\naz ad sp delete --id "${SP_03_APP_ID}"\n\n# Step 2: Remove role assignments\naz role assignment delete \\\n  --assignee "${SP_03_APP_ID}" \\\n  --role "Contributor" \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}" \\\n  2>/dev/null || true\n\n# Step 3: Delete managed identity\naz identity delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "azurehaymaker-mi-${UNIQUE_ID}"\n\n# Step 4: Delete resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 5: Wait for deletion\necho "Waiting for cleanup to complete..."\nsleep 60\n\n# Step 6: Verify deletion\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 7: Confirm service principals are deleted\naz ad sp list --filter "startswith(displayName, \'${SP_NAME}\')" --output table\n\necho "Service principals and resources successfully cleaned up"\n```\n\n---\n\n## Resource Naming Convention\n- Service Principal: `azurehaymaker-sp-${UNIQUE_ID}-[01-03]`\n- Managed Identity: `azurehaymaker-mi-${UNIQUE_ID}`\n- Resource Group: `azurehaymaker-identity-${UNIQUE_ID}-rg`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Service Principals Overview](https://learn.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals)\n- [Create Service Principal with Azure CLI](https://learn.microsoft.com/en-us/cli/azure/ad/sp)\n- [Azure RBAC Role Assignments](https://learn.microsoft.com/en-us/azure/role-based-access-control/role-assignments-cli)\n- [Service Principal Credentials and Secrets](https://learn.microsoft.com/en-us/azure/active-directory/develop/active-directory-certificate-credentials)\n- [Managed Identities for Azure Resources](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive service principal management capabilities with straightforward commands for creation, credential rotation, and RBAC assignment. The CLI is ideal for automation and scripting identity workflows.\n\n---\n\n## Estimated Duration\n- **Deployment**: 5-10 minutes\n- **Operations Phase**: 8+ hours (monitoring, audit logging, credential management)\n- **Cleanup**: 3-5 minutes\n\n---\n\n## Notes\n- Service principals are application objects used for programmatic authentication\n- Multiple credentials can be managed for a single service principal for rotation\n- Always store credentials securely (e.g., in Azure Key Vault)\n- RBAC assignments control what resources the service principal can access\n- Service principal deletion is immediate; dependent resources may need cleanup\n- Activity logs track all operations performed by service principals\n- Federated credentials offer modern alternatives to password-based authentication\n\n\n## Execution Plan\n\n### Phase 1: Setup\nConfigure automation environment\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: configuration, initialization\n\n### Phase 2: Workflow Design\nDesign automation workflow\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: workflow-design, orchestration\n**Dependencies**: Setup\n\n### Phase 3: Execution\nExecute automated tasks\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: task-execution, monitoring\n**Dependencies**: Workflow Design\n\n### Phase 4: Validation\nValidate results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: validation, quality-check\n**Dependencies**: Execution\n\n## Success Criteria\n- Goal \'Scenario: Creating and Managing Service Principals...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Creating and Managing Service Principals...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting automation-scenario:-creating-managing-agent...")
    print("Goal: Scenario: Creating and Managing Service Principals")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
