#!/usr/bin/env python3
"""
testing-scenario:-azure-container-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 6,
        "initial_prompt": '# Goal: Scenario: Azure Container Instances\n\n## Objective\n# Scenario: Azure Container Instances\n\n## Technology Area\nContainers\n\n## Company Profile\n- **Company Size**: Small to mid-size startup\n- **Industry**: Technology / DevOps\n- **Use Case**: Run containerized jobs and microservices without managing infrastructure\n\n## Scenario Description\nDeploy serverless containers using Azure Container Instances. Create container groups, manage environment variables, implement startup hooks, and configure monitoring without provisioning VMs or orchestration platforms.\n\n## Azure Services Used\n- Azure Container Instances\n- Azure Container Registry (image storage)\n- Azure Storage Account (volume mounting)\n- Azure Log Analytics (monitoring)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed\n- Docker installed (for building images)\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-containers-aci-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nACR_REGISTRY="azmkraci${UNIQUE_ID}"\nSTORAGE_ACCOUNT="azmkraci${UNIQUE_ID}"\nLOG_ANALYTICS="azurehaymaker-logs-${UNIQUE_ID}"\nCONTAINER_GROUP="azurehaymaker-aci-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=containers-aci Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Azure Container Registry\naz acr create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${ACR_REGISTRY}" \\\n  --sku Basic \\\n  --admin-enabled true \\\n  --tags ${TAGS}\n\n# Step 3: Build and push container image\ncat > /tmp/Dockerfile <<EOF\nFROM alpine:latest\nRUN apk add --no-cache curl\nENTRYPOINT ["sh"]\nCMD ["-c", "while true; do echo \'Container Instance running...\'; sleep 30; done"]\nEOF\n\naz acr build \\\n  --registry "${ACR_REGISTRY}" \\\n  --image "aci-sample:v1" \\\n  --file /tmp/Dockerfile \\\n  /tmp/\n\n# Step 4: Create Storage Account for volume mounting\naz storage account create \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --sku Standard_LRS \\\n  --kind StorageV2 \\\n  --tags ${TAGS}\n\n# Step 5: Create file share\nSTORAGE_KEY=$(az storage account keys list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --query \'[0].value\' -o tsv)\n\naz storage share create \\\n  --name "container-share" \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}" \\\n  --quota 1\n\n# Step 6: Create Log Analytics Workspace\naz monitor log-analytics workspace create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --workspace-name "${LOG_ANALYTICS}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\nLOG_ANALYTICS_ID=$(az monitor log-analytics workspace show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --workspace-name "${LOG_ANALYTICS}" \\\n  --query customerId -o tsv)\n\nLOG_ANALYTICS_KEY=$(az monitor log-analytics workspace get-shared-keys \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --workspace-name "${LOG_ANALYTICS}" \\\n  --query primarySharedKey -o tsv)\n\n# Step 7: Get ACR credentials\nACR_USERNAME=$(az acr credential show \\\n  --name "${ACR_REGISTRY}" \\\n  --query username -o tsv)\n\nACR_PASSWORD=$(az acr credential show \\\n  --name "${ACR_REGISTRY}" \\\n  --query passwords[0].value -o tsv)\n\nACR_LOGIN_SERVER=$(az acr show \\\n  --name "${ACR_REGISTRY}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query loginServer -o tsv)\n\n# Step 8: Create container group YAML\ncat > /tmp/container_group.yaml <<EOF\napiVersion: \'2021-09-01\'\nname: ${CONTAINER_GROUP}\nproperties:\n  containers:\n  - name: sample-container\n    properties:\n      image: ${ACR_LOGIN_SERVER}/aci-sample:v1\n      resources:\n        requests:\n          cpu: 0.5\n          memoryInGB: 0.5\n      environmentVariables:\n      - name: ENVIRONMENT\n        value: production\n      - name: LOG_LEVEL\n        value: INFO\n  imageRegistryCredentials:\n  - server: ${ACR_LOGIN_SERVER}\n    username: ${ACR_USERNAME}\n    password: ${ACR_PASSWORD}\n  osType: Linux\n  restartPolicy: Always\nEOF\n\n# Step 9: Create container instance\naz container create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}" \\\n  --image "${ACR_LOGIN_SERVER}/aci-sample:v1" \\\n  --cpu 1 \\\n  --memory 1.5 \\\n  --registry-login-server "${ACR_LOGIN_SERVER}" \\\n  --registry-username "${ACR_USERNAME}" \\\n  --registry-password "${ACR_PASSWORD}" \\\n  --environment-variables ENVIRONMENT=production LOG_LEVEL=INFO \\\n  --restart-policy Always \\\n  --tags ${TAGS}\n\n# Step 10: Create multi-container group with YAML\naz container create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --file /tmp/container_group.yaml\n\necho ""\necho "=========================================="\necho "Container Instance Created: ${CONTAINER_GROUP}"\necho "Registry: ${ACR_LOGIN_SERVER}"\necho "=========================================="\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Show container instance\naz container show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}"\n\n# Check container status\naz container show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}" \\\n  --query "instanceView.state" -o tsv\n\n# Get container logs\naz container logs \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}"\n\n# List containers\naz container list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --output table\n\n# Verify ACR\naz acr show \\\n  --name "${ACR_REGISTRY}" \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# List repositories\naz acr repository list \\\n  --name "${ACR_REGISTRY}" \\\n  --output table\n\n# Verify storage\naz storage share list \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}" \\\n  --output table\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Check container events\naz container attach \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}" \\\n  --output table\n\n# Operation 2: Execute command in container\naz container exec \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}" \\\n  --exec-command "echo \'Running command in container\'"\n\n# Operation 3: Stop container\naz container stop \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}"\n\n# Operation 4: Start container\naz container start \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}"\n\n# Operation 5: Restart container\naz container restart \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}"\n\n# Operation 6: Update container image\naz acr build \\\n  --registry "${ACR_REGISTRY}" \\\n  --image "aci-sample:v2" \\\n  --file /tmp/Dockerfile \\\n  /tmp/\n\n# Operation 7: Create another container instance\naz container create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "aci-backup-${UNIQUE_ID}" \\\n  --image "${ACR_LOGIN_SERVER}/aci-sample:v2" \\\n  --cpu 0.5 \\\n  --memory 0.5 \\\n  --registry-login-server "${ACR_LOGIN_SERVER}" \\\n  --registry-username "${ACR_USERNAME}" \\\n  --registry-password "${ACR_PASSWORD}" \\\n  --tags ${TAGS}\n\n# Operation 8: Monitor container metrics\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.ContainerInstance/containerGroups/${CONTAINER_GROUP}" \\\n  --metric "CPU%" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 9: Export container logs\naz container logs \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}" \\\n  > /tmp/container_logs.txt\n\n# Operation 10: List all container instances\naz container list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "[].{Name:name, State:instanceView.state, Image:containers[0].properties.image}" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete all container instances\naz container delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_GROUP}" \\\n  --yes\n\n# Step 2: Delete backup container\naz container delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "aci-backup-${UNIQUE_ID}" \\\n  --yes 2>/dev/null || true\n\n# Step 3: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 4: Verify deletion\nsleep 120\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 5: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n\n# Step 6: Clean up local files\nrm -rf /tmp/Dockerfile /tmp/container_group.yaml /tmp/container_logs.txt\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-containers-aci-${UNIQUE_ID}-rg`\n- Container Group: `azurehaymaker-aci-${UNIQUE_ID}`\n- ACR Registry: `azmkraci${UNIQUE_ID}`\n- Storage Account: `azmkraci${UNIQUE_ID}`\n- Log Analytics: `azurehaymaker-logs-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Container Instances Overview](https://learn.microsoft.com/en-us/azure/container-instances/container-instances-overview)\n- [Quick start: Create container instance](https://learn.microsoft.com/en-us/azure/container-instances/container-instances-quickstart)\n- [Mount Azure file share](https://learn.microsoft.com/en-us/azure/container-instances/container-instances-mount-azure-files-volume)\n- [Container Instances Pricing](https://learn.microsoft.com/en-us/azure/container-instances/container-instances-pricing)\n- [Container Instances CLI Reference](https://learn.microsoft.com/en-us/cli/azure/container)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides excellent support for Container Instances with straightforward commands. No orchestration platform required, making this ideal for simple containerized workloads.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8 hours (with container management and monitoring)\n- **Cleanup**: 5 minutes\n\n---\n\n## Notes\n- No VM management required - fully serverless\n- Pay-per-second billing for actual container runtime\n- Supports Linux and Windows containers\n- Can mount Azure file shares for persistent storage\n- Environment variables enable configuration management\n- All operations scoped to single tenant and subscription\n- Ideal for batch jobs, microservices, and testing\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Azure Container Instances...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": ["Goal 'Scenario: Azure Container Instances...' is achieved"],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-azure-container-agent...")
    print("Goal: Scenario: Azure Container Instances")
    print("Estimated duration: 22 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
