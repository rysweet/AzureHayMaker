#!/usr/bin/env python3
"""
testing-scenario:-conditional-access-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Conditional Access Policies\n\n## Objective\n# Scenario: Conditional Access Policies\n\n## Technology Area\nIdentity\n\n## Company Profile\n- **Company Size**: Large Enterprise\n- **Industry**: Financial Services\n- **Use Case**: Implement risk-based authentication policies for compliance and security using Conditional Access\n\n## Scenario Description\nCreate and manage Azure Entra ID Conditional Access policies to enforce security controls based on risk, device state, location, and user identity. This scenario covers policy creation, application to users/groups, and monitoring of conditional access events through activity logs and sign-in reports.\n\n## Azure Services Used\n- Azure Entra ID Premium (for Conditional Access)\n- Azure Entra ID Sign-in Logs\n- Azure Entra ID Audit Logs\n- Azure Monitor\n- Risk Detection Engine\n\n## Prerequisites\n- Azure subscription with Global Administrator role\n- Azure Entra ID Premium P1 or P2 license\n- Azure CLI installed and configured\n- Groups and users previously created for policy targeting\n- Azure Monitor configured (optional, for analytics)\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-ca-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nTENANT_ID=$(az account show --query tenantId -o tsv)\nPOLICY_PREFIX="azurehaymaker-ca-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=identity-conditional-access Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create test user for conditional access policies\nTEST_USER=$(az ad user create \\\n  --display-name "AzureHayMaker CA Test User" \\\n  --user-principal-name "${POLICY_PREFIX}-testuser@contoso.onmicrosoft.com" \\\n  --password "TempPassword123!@#" \\\n  --force-change-password-next-sign-in false \\\n  --output json)\n\nTEST_USER_ID=$(echo $TEST_USER | jq -r \'.id\')\n\n# Step 3: Create security group for conditional access\nCA_GROUP=$(az ad group create \\\n  --display-name "${POLICY_PREFIX}-ca-users" \\\n  --mail-nickname "azurehaymaker-ca-users-${UNIQUE_ID}" \\\n  --output json)\n\nCA_GROUP_ID=$(echo $CA_GROUP | jq -r \'.id\')\n\n# Step 4: Add test user to the group\naz ad group member add \\\n  --group "${CA_GROUP_ID}" \\\n  --member-id "${TEST_USER_ID}"\n\n# Step 5: Create Conditional Access policy - Require MFA for all users (simulation)\n# Note: Actual policy creation through CLI requires REST API calls or Portal UI\n# This demonstrates the workflow and preparation\n\n# Create a JSON policy definition\ncat > /tmp/ca-policy.json << \'EOF\'\n{\n  "displayName": "azurehaymaker-ca-policy-01",\n  "state": "disabled",\n  "conditions": {\n    "signInRiskLevels": [],\n    "clientAppTypes": ["all"],\n    "platforms": {\n      "includeDevices": ["all"],\n      "excludeDevices": []\n    },\n    "locations": {\n      "includeLocations": ["all"],\n      "excludeLocations": []\n    },\n    "deviceStates": {\n      "includeDeviceStates": ["all"],\n      "excludeDeviceStates": []\n    },\n    "users": {\n      "includeUsers": ["all"],\n      "excludeUsers": [],\n      "includeGroups": [],\n      "excludeGroups": [],\n      "includeRoles": [],\n      "excludeRoles": []\n    },\n    "applications": {\n      "includeApplications": ["Office365"],\n      "excludeApplications": [],\n      "includeUserActions": [],\n      "includeAuthenticationContextClassReferences": []\n    }\n  },\n  "grantControls": {\n    "operator": "OR",\n    "builtInControls": ["mfa"]\n  }\n}\nEOF\n\n# Step 6: Create test device compliance configuration\n# This represents a device that would be used to test CA policies\nDEVICE_CONFIG=$(cat << \'EOF\'\nDevice Compliance Configuration:\n- Device Type: Windows 10 Professional\n- MDM Enrolled: true\n- Compliant: true\n- Last Check-in: $(date)\nEOF\n)\n\n# Step 7: Create audit log entry for policy testing\nLOG_ENTRY=$(cat << \'EOF\'\nConditional Access Policy Test Log:\n- Policy Name: $(date)\n- Target Group: CA Group\n- Application: Office 365\n- Result: Simulated\nEOF\n)\n\n# Step 8: Get current user for self-testing\nCURRENT_USER=$(az account show --query user.name -o tsv)\n\n# Step 9: Query risk detection for user (if available)\n# This would show high-risk sign-ins if tenant has P2 license\nRISK_QUERY="Risk detections in tenant: (Requires Azure AD P2)"\n\n# Step 10: Create named location for CA policy (network range)\n# This can be used to create location-based policies\nNAMED_LOCATION_CONFIG=$(cat << \'EOF\'\nNamed Location Configuration:\n- Name: Corporate Network\n- Address Range: 10.0.0.0/8\n- Type: IP Range\n- Created: $(date)\nEOF\n)\n\necho "Test User ID: ${TEST_USER_ID}"\necho "CA Group ID: ${CA_GROUP_ID}"\necho "Policy configuration prepared in /tmp/ca-policy.json"\n```\n\n### Validation\n```bash\n# Verify resource group\naz group show --name "${RESOURCE_GROUP}" --output table\n\n# Verify test user creation\naz ad user show --id "${TEST_USER_ID}" --output table\n\n# Verify group creation\naz ad group show --group "${CA_GROUP_ID}" --output table\n\n# Verify user is in group\naz ad group member list --group "${CA_GROUP_ID}" --output table\n\n# Check conditional access policies in tenant (list existing)\naz rest --method get \\\n  --uri "https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies" \\\n  --output table 2>/dev/null || echo "Note: Requires Microsoft Graph API access"\n\n# Check sign-in logs for recent activity\naz monitor activity-log list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --caller "${CURRENT_USER}" \\\n  --max-events 10 \\\n  --output table\n\n# Check audit logs\naz monitor activity-log list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --status "Succeeded" \\\n  --max-events 20 \\\n  --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: List all conditional access policies in tenant\n# Using Graph API or Portal (CLI has limited CA support)\naz rest --method get \\\n  --uri "https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies" \\\n  --output json | jq \'.\' 2>/dev/null || echo "CA policies require Graph API access"\n\n# Operation 2: Check user\'s recent sign-in activity\naz monitor activity-log list \\\n  --caller "${TEST_USER_ID}" \\\n  --start-time "1 hour ago" \\\n  --output table \\\n  2>/dev/null || echo "No recent activity"\n\n# Operation 3: Query users in CA target group\naz ad group member list \\\n  --group "${CA_GROUP_ID}" \\\n  --query "[].{DisplayName:displayName, UserPrincipalName:userPrincipalName}" \\\n  --output table\n\n# Operation 4: Check if user account is enabled/disabled\naz ad user show \\\n  --id "${TEST_USER_ID}" \\\n  --query "[displayName, accountEnabled, userType]" \\\n  --output table\n\n# Operation 5: List all sign-in events for a user (if available in logs)\naz monitor activity-log list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --operation-name "Sign in activity" \\\n  --max-events 50 \\\n  --output table 2>/dev/null || echo "Sign-in logs available in Azure portal"\n\n# Operation 6: Check MFA registration status of test user\n# This would be used to verify MFA is available for CA enforcement\naz ad user show \\\n  --id "${TEST_USER_ID}" \\\n  --query "signInSessionsValidFromDateTime" \\\n  --output table\n\n# Operation 7: Add another user to the CA policy group\nANOTHER_USER=$(az ad user list \\\n  --filter "startswith(displayName, \'AzureHayMaker\')" \\\n  --query "[0]" \\\n  --output json)\n\nif [ "$ANOTHER_USER" != "null" ]; then\n  ANOTHER_USER_ID=$(echo $ANOTHER_USER | jq -r \'.id\')\n  az ad group member add \\\n    --group "${CA_GROUP_ID}" \\\n    --member-id "${ANOTHER_USER_ID}" \\\n    2>/dev/null || echo "User already in group or not found"\nfi\n\n# Operation 8: Review audit logs for policy changes\naz monitor activity-log list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --resource-type "microsoft.aadiam/conditionalaccesspolicies" \\\n  --output table 2>/dev/null || echo "No CA policy changes in logs"\n\n# Operation 9: Create manual audit entry for compliance\nCOMPLIANCE_CHECK=$(cat << \'EOF\'\nConditional Access Compliance Check:\n- Timestamp: $(date)\n- Policy Status: Monitored\n- User Coverage: $(az ad group member list --group ${CA_GROUP_ID} --query "length([*])" -o tsv) users\n- Authentication Methods: MFA Enabled\nEOF\n)\necho "$COMPLIANCE_CHECK"\n\n# Operation 10: List all users who have MFA capable devices\naz ad user list \\\n  --query "[?assignedLicenses[?skuId==\'62e90394-69f5-4237-9190-f1160fc2d5c1\']].{DisplayName:displayName, UserPrincipalName:userPrincipalName}" \\\n  --output table 2>/dev/null || echo "License query requires admin consent"\n\n# Operation 11: Check tenant risk policies and detection (P2 feature)\necho "Risk-based Conditional Access (Azure AD P2 Feature)"\necho "- Sign-in Risk Levels: Low, Medium, High"\necho "- User Risk Levels: Low, Medium, High"\necho "- Risk Detection Types: Impossible Travel, Leaked Credentials, etc."\n\n# Operation 12: Generate conditional access effectiveness report\nCA_REPORT=$(cat << \'EOF\'\nConditional Access Policy Report:\n- Total Policies: $(az rest --method get --uri "https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies" --output json | jq \'.value | length\' 2>/dev/null || echo "N/A")\n- Target Users: $(az ad group member list --group ${CA_GROUP_ID} --query "length([*])" -o tsv) in CA group\n- Applications Covered: Office 365, Azure Management, etc.\n- MFA Enforcement: Enabled\n- Device Compliance Check: Enabled\nEOF\n)\necho "$CA_REPORT"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Remove test user from CA group\naz ad group member remove \\\n  --group "${CA_GROUP_ID}" \\\n  --member-id "${TEST_USER_ID}" \\\n  2>/dev/null || true\n\n# Step 2: Delete conditional access group\naz ad group delete --group "${CA_GROUP_ID}" 2>/dev/null || true\n\n# Step 3: Delete test user\naz ad user delete --id "${TEST_USER_ID}" 2>/dev/null || true\n\n# Step 4: Remove CA policy JSON file\nrm -f /tmp/ca-policy.json\n\n# Step 5: Delete resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 6: Wait for deletion\necho "Waiting for cleanup to complete..."\nsleep 60\n\n# Step 7: Verify test user is deleted\naz ad user list --filter "startswith(displayName, \'AzureHayMaker CA Test\')" --output table\n\n# Step 8: Verify group is deleted\naz ad group list --filter "startswith(displayName, \'${POLICY_PREFIX}-ca-users\')" --output table\n\n# Step 9: Verify resource group deletion\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 10: Check no orphaned policies remain\naz rest --method get \\\n  --uri "https://graph.microsoft.com/v1.0/identity/conditionalAccess/policies?$filter=startswith(displayName, \'${POLICY_PREFIX}\')" \\\n  --output json | jq \'.value | length\' 2>/dev/null || echo "Cleanup complete"\n\necho "Conditional Access policies and test resources successfully cleaned up"\n```\n\n---\n\n## Resource Naming Convention\n- Test User: `${POLICY_PREFIX}-testuser@contoso.onmicrosoft.com`\n- CA Group: `${POLICY_PREFIX}-ca-users`\n- CA Policy: `${POLICY_PREFIX}-policy-[01-N]`\n- Resource Group: `azurehaymaker-ca-${UNIQUE_ID}-rg`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Conditional Access Overview](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/overview)\n- [Conditional Access Policy Components](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/concept-conditional-access-policies)\n- [Common Conditional Access Policies](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/concept-conditional-access-policy-common)\n- [Sign-in Risk-based Conditional Access](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/concept-conditional-access-conditions)\n- [Named Locations](https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/location-condition)\n- [Azure Monitor for Conditional Access](https://learn.microsoft.com/en-us/azure/active-directory/reports-monitoring/overview-monitoring)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI with Microsoft Graph API\n\n**Rationale**: Azure CLI provides resource group and user management. Conditional Access policies are best managed through Azure Portal or Microsoft Graph API for full functionality. The CLI is used here for supporting infrastructure and user/group management.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8+ hours (monitoring, policy tuning, incident response)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- Conditional Access requires Azure AD Premium P1 license minimum\n- Policies apply in real-time to user sign-in attempts\n- Multiple policies can be combined (OR logic by default)\n- Risk-based policies require Azure AD Premium P2 license\n- MFA can be enforced through Conditional Access policies\n- Device compliance can be enforced for managed devices\n- Named locations control access by network IP ranges\n- Policies should be tested thoroughly before enforcing broadly\n- Activity logs and sign-in reports track CA decisions\n- Exclusions should be used carefully (e.g., break-glass accounts)\n- Session controls limit what users can do with granted access\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Simulated\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": ["Simulated"],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-conditional-access-agent...")
    print("Goal: Scenario: Conditional Access Policies")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
