#!/usr/bin/env python3
"""
testing-scenario:-azure-stack-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Azure Stack HCI Setup and Management\n\n## Objective\n# Scenario: Azure Stack HCI Setup and Management\n\n## Technology Area\nHybrid+Multicloud\n\n## Company Profile\n- **Company Size**: Large enterprise\n- **Industry**: Manufacturing\n- **Use Case**: Run Azure services on-premises with Azure Stack HCI\n\n## Scenario Description\nDeploy and configure Azure Stack HCI for running VMs and containers on-premises while maintaining consistency with Azure. Set up cluster, configure storage, and enable hybrid management.\n\n## Azure Services Used\n- Azure Stack HCI (on-premises hyperconverged infrastructure)\n- Azure Arc (hybrid management)\n- Azure Storage (cloud integration)\n- Azure Monitor (monitoring)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-hybrid-stack-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nSTACK_CLUSTER_NAME="azurehaymaker-hci-${UNIQUE_ID}"\nSTORAGE_ACCOUNT="azmkrstack${UNIQUE_ID}"\nKEYVAULT="azurehaymaker-kv-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=hybrid-azure-stack Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Key Vault\naz keyvault create \\\n  --name "${KEYVAULT}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 3: Create Storage Account for cloud integration\naz storage account create \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --sku Standard_LRS \\\n  --kind StorageV2 \\\n  --tags ${TAGS}\n\n# Step 4: Create containers for VM images and backups\nSTORAGE_KEY=$(az storage account keys list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --query \'[0].value\' -o tsv)\n\naz storage container create \\\n  --name "hci-images" \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}"\n\naz storage container create \\\n  --name "hci-backups" \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}"\n\n# Step 5: Create Azure Stack HCI cluster registration info\ncat > /tmp/hci_cluster_config.json <<EOF\n{\n  "clusterName": "${STACK_CLUSTER_NAME}",\n  "location": "${LOCATION}",\n  "resourceGroup": "${RESOURCE_GROUP}",\n  "arcSettings": {\n    "enabled": true,\n    "authority": "https://management.azure.com",\n    "principalObjectId": "user-object-id-placeholder"\n  },\n  "nodes": [\n    {\n      "hostName": "hcinode1.contoso.local",\n      "ipAddress": "192.168.1.10",\n      "status": "Active"\n    },\n    {\n      "hostName": "hcinode2.contoso.local",\n      "ipAddress": "192.168.1.11",\n      "status": "Active"\n    },\n    {\n      "hostName": "hcinode3.contoso.local",\n      "ipAddress": "192.168.1.12",\n      "status": "Active"\n    }\n  ],\n  "storage": {\n    "poolName": "S2D-Pool",\n    "capacity": 48,\n    "mediaType": "SSD"\n  }\n}\nEOF\n\n# Step 6: Create sample HCI cluster metadata resource\ncat > /tmp/hci_deployment.json <<EOF\n{\n  "\\$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",\n  "contentVersion": "1.0.0.0",\n  "resources": [\n    {\n      "type": "Microsoft.AzureStackHCI/clusters",\n      "apiVersion": "2021-09-01-preview",\n      "name": "${STACK_CLUSTER_NAME}",\n      "location": "${LOCATION}",\n      "properties": {\n        "desiredProperties": {\n          "clusterVersion": "20.04",\n          "diagnosticLevel": "Basic",\n          "globalWitnessShare": "\\\\\\\\witness.contoso.local\\\\witness"\n        }\n      },\n      "tags": {\n        "AzureHayMaker-managed": "true"\n      }\n    }\n  ]\n}\nEOF\n\n# Deploy HCI cluster resource\naz deployment group create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --template-file /tmp/hci_deployment.json\n\n# Step 7: Create arc connectivity for HCI cluster\ncat > /tmp/hci_arc_onboard.sh <<EOF\n#!/bin/bash\n\n# Azure Stack HCI Arc Onboarding Script\n\n# This script registers an Azure Stack HCI cluster with Azure Arc\n\nRESOURCE_GROUP="${RESOURCE_GROUP}"\nCLUSTER_NAME="${STACK_CLUSTER_NAME}"\nLOCATION="${LOCATION}"\n\n# Download and execute Azure Stack HCI registration\n# In production, this would be run on the HCI cluster\n\necho "Preparing Azure Stack HCI for Arc registration..."\necho "Cluster: \\${CLUSTER_NAME}"\necho "Resource Group: \\${RESOURCE_GROUP}"\necho "Location: \\${LOCATION}"\n\n# Create app registration for cluster\nCLIENT_ID=\\$(az ad app create --display-name "\\${CLUSTER_NAME}-arc" --query appId -o tsv)\necho "App Registration ID: \\${CLIENT_ID}"\n\n# Generate certificate for authentication\nopenssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes -subj "/CN=\\${CLUSTER_NAME}"\n\necho "HCI registration preparation complete"\nEOF\n\nchmod +x /tmp/hci_arc_onboard.sh\n\n# Step 8: Create storage pool configuration\ncat > /tmp/storage_config.json <<EOF\n{\n  "storagePoolConfiguration": {\n    "name": "S2D-Pool",\n    "mediaType": "SSD",\n    "nodeCount": 3,\n    "totalCapacity": 48,\n    "availableCapacity": 40,\n    "volumes": [\n      {\n        "name": "VM-Storage",\n        "size": 30,\n        "resiliency": "Mirror",\n        "type": "VirtualDiskVolume"\n      },\n      {\n        "name": "Infrastructure-Reserve",\n        "size": 10,\n        "resiliency": "Mirror",\n        "type": "VirtualDiskVolume"\n      }\n    ]\n  }\n}\nEOF\n\n# Step 9: Store HCI configuration in Key Vault\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "hci-cluster-config" \\\n  --value @/tmp/hci_cluster_config.json\n\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "hci-storage-config" \\\n  --value @/tmp/storage_config.json\n\n# Step 10: Create monitoring setup\naz monitor diagnostic-settings create \\\n  --name "hci-diagnostics" \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.AzureStackHCI/clusters/${STACK_CLUSTER_NAME}" \\\n  --logs \'[{"category":"Audit","enabled":true}]\' \\\n  --metrics \'[{"category":"AllMetrics","enabled":true}]\' 2>/dev/null || echo "Diagnostics setup will be available after cluster registration"\n\necho ""\necho "=========================================="\necho "Azure Stack HCI Setup Created"\necho "Cluster Name: ${STACK_CLUSTER_NAME}"\necho "Resource Group: ${RESOURCE_GROUP}"\necho "Storage Account: ${STORAGE_ACCOUNT}"\necho "=========================================="\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# List HCI clusters\naz azurestackhci cluster list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --output table 2>/dev/null || echo "No HCI clusters yet"\n\n# Show cluster details\naz azurestackhci cluster show \\\n  --name "${STACK_CLUSTER_NAME}" \\\n  --resource-group "${RESOURCE_GROUP}" 2>/dev/null || echo "Cluster not yet registered"\n\n# Verify Storage Account\naz storage account show \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# List storage containers\naz storage container list \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}" \\\n  --output table\n\n# Check Key Vault\naz keyvault show --name "${KEYVAULT}"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Update cluster properties\naz azurestackhci cluster update \\\n  --name "${STACK_CLUSTER_NAME}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --tags Environment=production 2>/dev/null || echo "Update not available for unregistered cluster"\n\n# Operation 2: Monitor cluster health\necho "To monitor cluster health:"\necho "Check via: Get-ClusterNode -Cluster ${STACK_CLUSTER_NAME} | Get-ClusterResourceStatus"\n\n# Operation 3: Upload VM image to HCI storage\ncat > /tmp/upload_image.sh <<EOF\n#!/bin/bash\n\n# Upload sample VM image to HCI storage\nIMAGE_NAME="ubuntu-22.04.vhdx"\nSTORAGE_ACCOUNT="${STORAGE_ACCOUNT}"\nCONTAINER="hci-images"\n\necho "Uploading VM image to HCI storage..."\necho "Image: \\${IMAGE_NAME}"\necho "Container: \\${CONTAINER}"\n\n# In production, this would upload actual VHDX image\necho "Image upload configuration prepared"\nEOF\n\nchmod +x /tmp/upload_image.sh\n\n# Operation 4: Create virtual machine configuration\ncat > /tmp/hci_vm_config.json <<EOF\n{\n  "vmName": "hci-workload-vm-1",\n  "cpuCount": 4,\n  "memoryGB": 8,\n  "storageGB": 50,\n  "networkAdapter": "Virtual Switch 1",\n  "imageName": "ubuntu-22.04.vhdx"\n}\nEOF\n\n# Operation 5: Monitor HCI storage metrics\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.AzureStackHCI/clusters/${STACK_CLUSTER_NAME}" \\\n  --metric "AvailableMemory" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\') 2>/dev/null || echo "Metrics not yet available"\n\n# Operation 6: Create Arc connection for management\necho "To connect HCI cluster to Azure Arc:"\necho "Run Arc onboarding script on cluster nodes to enable Azure management"\n\n# Operation 7: Configure backup to cloud storage\ncat > /tmp/backup_policy.json <<EOF\n{\n  "backupPolicy": {\n    "frequency": "Daily",\n    "time": "02:00",\n    "retention": 30,\n    "destination": "azurehaymaker-stack${UNIQUE_ID}/hci-backups"\n  }\n}\nEOF\n\n# Operation 8: Update cluster settings\necho "Common HCI cluster updates:"\necho "- Firmware updates via: Update-ClusterAwareUpdateClusterRoleStatus"\necho "- Storage pool updates via: Update-StoragePool"\necho "- Network configuration via: Set-NetAdapter"\n\n# Operation 9: List cluster nodes status\necho "Cluster nodes configuration:"\necho "Node 1: hcinode1.contoso.local - CPU: 28, RAM: 256GB, Storage: 8TB"\necho "Node 2: hcinode2.contoso.local - CPU: 28, RAM: 256GB, Storage: 8TB"\necho "Node 3: hcinode3.contoso.local - CPU: 28, RAM: 256GB, Storage: 8TB"\n\n# Operation 10: Review HCI activity logs\naz monitor activity-log list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "[?contains(resourceType, \'AzureStackHCI\')].{Time:eventTimestamp, Event:operationName.localizedValue}" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete HCI cluster\naz azurestackhci cluster delete \\\n  --name "${STACK_CLUSTER_NAME}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --yes 2>/dev/null || echo "Cluster not found"\n\n# Step 2: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 3: Verify deletion\nsleep 60\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 4: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n\n# Step 5: Clean up local files\nrm -rf /tmp/hci_* /tmp/storage_config.json /tmp/backup_policy.json /tmp/upload_image.sh\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-hybrid-stack-${UNIQUE_ID}-rg`\n- HCI Cluster: `azurehaymaker-hci-${UNIQUE_ID}`\n- Storage Account: `azmkrstack${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Stack HCI Overview](https://learn.microsoft.com/en-us/azure-stack/hci/overview)\n- [HCI Architecture](https://learn.microsoft.com/en-us/azure-stack/hci/concepts/architecture)\n- [Storage Spaces Direct](https://learn.microsoft.com/en-us/windows-server/storage/storage-spaces/storage-spaces-direct-overview)\n- [Azure Arc Integration](https://learn.microsoft.com/en-us/azure-stack/hci/deploy/register-hci-system)\n- [HCI CLI Reference](https://learn.microsoft.com/en-us/cli/azure/azurestackhci)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI + PowerShell\n\n**Rationale**: Azure CLI manages cloud-side resources while PowerShell handles on-premises HCI cluster management and configuration.\n\n---\n\n## Estimated Duration\n- **Deployment**: 20-30 minutes (cluster registration takes time)\n- **Operations Phase**: 8 hours (with VM management and monitoring)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- HCI converges compute, storage, and networking on-premises\n- Storage Spaces Direct provides software-defined storage\n- 3-16 nodes per cluster for scalability\n- Arc integration enables Azure management portal view\n- All operations scoped to single tenant and subscription\n- Suitable for edge computing and disconnected operations\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Azure Stack HCI Setup and Management...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Azure Stack HCI Setup and Management...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-azure-stack-agent...")
    print("Goal: Scenario: Azure Stack HCI Setup and Management")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
