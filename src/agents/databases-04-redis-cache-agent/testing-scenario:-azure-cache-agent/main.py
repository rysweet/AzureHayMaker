#!/usr/bin/env python3
"""
testing-scenario:-azure-cache-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Azure Cache for Redis\n\n## Objective\n# Scenario: Azure Cache for Redis\n\n## Technology Area\nDatabases\n\n## Company Profile\n- **Company Size**: Mid-size e-commerce company\n- **Industry**: Retail / E-commerce\n- **Use Case**: High-performance session storage and data caching layer\n\n## Scenario Description\nDeploy Azure Cache for Redis to provide low-latency caching for application data and sessions. Configure clustering, implement eviction policies, set up persistence options, and demonstrate cache operations.\n\n## Azure Services Used\n- Azure Cache for Redis\n- Azure Virtual Network (network isolation)\n- Azure Key Vault (connection strings)\n- Azure Monitor (monitoring and diagnostics)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-db-redis-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nREDIS_CACHE="azurehaymaker-redis-${UNIQUE_ID}"\nVNET_NAME="azurehaymaker-vnet-${UNIQUE_ID}"\nKEYVAULT="azurehaymaker-kv-${UNIQUE_ID}"\nLOG_ANALYTICS="azurehaymaker-logs-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=databases-redis-cache Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network\naz network vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VNET_NAME}" \\\n  --address-prefix "10.0.0.0/16" \\\n  --subnet-name "redis-subnet" \\\n  --subnet-prefixes "10.0.0.0/24" \\\n  --tags ${TAGS}\n\nSUBNET_ID=$(az network vnet subnet show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --name "redis-subnet" \\\n  --query id -o tsv)\n\n# Step 3: Create Key Vault\naz keyvault create \\\n  --name "${KEYVAULT}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 4: Create Log Analytics Workspace\naz monitor log-analytics workspace create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --workspace-name "${LOG_ANALYTICS}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 5: Create Azure Cache for Redis\naz redis create \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --sku Standard \\\n  --vm-size c1 \\\n  --enable-non-ssl-port false \\\n  --minimum-tls-version "1.2" \\\n  --zones 1 2 \\\n  --tags ${TAGS}\n\n# Step 6: Get connection information\nREDIS_ENDPOINT=$(az redis show \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "hostName" -o tsv)\n\nREDIS_PORT=$(az redis show \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "sslPort" -o tsv)\n\nREDIS_PRIMARY_KEY=$(az redis list-keys \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "primaryKey" -o tsv)\n\nREDIS_SECONDARY_KEY=$(az redis list-keys \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "secondaryKey" -o tsv)\n\n# Store connection string in Key Vault\nREDIS_CONNECTION_STRING="${REDIS_ENDPOINT}:${REDIS_PORT},password=${REDIS_PRIMARY_KEY},ssl=True"\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "redis-connection-string" \\\n  --value "${REDIS_CONNECTION_STRING}"\n\n# Step 7: Configure firewall rules\naz redis firewall-rules create \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --rule-name "AllowVNet" \\\n  --start-ip "10.0.0.1" \\\n  --end-ip "10.0.255.254"\n\n# Step 8: Enable diagnostics\naz monitor diagnostic-settings create \\\n  --name "redis-diagnostics" \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Cache/redis/${REDIS_CACHE}" \\\n  --workspace "${LOG_ANALYTICS}" \\\n  --logs \'[{"category":"ConnectedClientList","enabled":true},{"category":"AllLogs","enabled":true}]\' \\\n  --metrics \'[{"category":"AllMetrics","enabled":true}]\'\n\n# Step 9: Update Redis configuration for session storage\naz redis update \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --set config=\'{"maxmemory-policy":"allkeys-lru"}\'\n\n# Step 10: Create diagnostic test data\ncat > /tmp/redis_test.json <<EOF\n{\n  "endpoint": "${REDIS_ENDPOINT}",\n  "port": ${REDIS_PORT},\n  "test_keys": [\n    "session:user:123",\n    "cache:product:456",\n    "queue:notifications"\n  ]\n}\nEOF\n\necho ""\necho "=========================================="\necho "Redis Cache Created: ${REDIS_CACHE}"\necho "Endpoint: ${REDIS_ENDPOINT}"\necho "Port: ${REDIS_PORT}"\necho "Connection String stored in Key Vault"\necho "=========================================="\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify Redis Cache\naz redis show \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# Check cache status\naz redis show \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "provisioningState" -o tsv\n\n# Get cache configuration\naz redis show \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "minimumTlsVersion" -o tsv\n\n# List firewall rules\naz redis firewall-rules list \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --output table\n\n# Check cache size and memory\naz redis show \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "replicasPerMaster" -o tsv\n\n# Verify Key Vault\naz keyvault show --name "${KEYVAULT}"\n\n# List secrets\naz keyvault secret list --vault-name "${KEYVAULT}" --output table\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Scale Redis cache to Premium tier\naz redis update \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --sku Premium \\\n  --vm-size p1\n\n# Operation 2: Enable persistence (RDB)\naz redis patch-schedule create \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --schedule-entries \'{\\"scheduleEntries\\":[{\\"dayOfWeek\\":\\"Daily\\",\\"maintenanceWindow\\":\\"PT5H\\",\\"startHourUtc\\":2,\\"rdbBackupFrequency\\":\\"60\\"}]}\'\n\n# Operation 3: Monitor cache metrics\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Cache/redis/${REDIS_CACHE}" \\\n  --metric "CacheHits" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 4: Get cache statistics\naz redis show \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "{Sku:sku.name, Size:sku.capacity, Family:sku.family}" -o table\n\n# Operation 5: Check connected clients\necho "To check connected clients, query Redis directly with:"\necho "redis-cli -h ${REDIS_ENDPOINT} -p ${REDIS_PORT} -a ${REDIS_PRIMARY_KEY} --tls CLIENT LIST"\n\n# Operation 6: Regenerate access keys\naz redis regenerate-keys \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --key-type Primary\n\n# Operation 7: Export cache for backup\necho "To export cache data:"\necho "Redis export is available in Premium tier with RDB snapshots"\n\n# Operation 8: Monitor memory usage\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Cache/redis/${REDIS_CACHE}" \\\n  --metric "UsedMemory" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 9: Check eviction policy\naz redis show \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "config.maxmemory_policy" -o tsv\n\n# Operation 10: List all backups (Premium tier)\naz redis backup list \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --output table 2>/dev/null || echo "Backups only available in Premium tier"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete Redis cache\naz redis delete \\\n  --name "${REDIS_CACHE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --yes\n\n# Step 2: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 3: Verify deletion\nsleep 120\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 4: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n\n# Step 5: Clean up local files\nrm -rf /tmp/redis_test.json\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-db-redis-${UNIQUE_ID}-rg`\n- Redis Cache: `azurehaymaker-redis-${UNIQUE_ID}`\n- Virtual Network: `azurehaymaker-vnet-${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n- Log Analytics: `azurehaymaker-logs-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Cache for Redis Overview](https://learn.microsoft.com/en-us/azure/azure-cache-for-redis/cache-overview)\n- [Redis Tiers and Sizing](https://learn.microsoft.com/en-us/azure/azure-cache-for-redis/cache-planning-faq)\n- [Persistence in Redis](https://learn.microsoft.com/en-us/azure/azure-cache-for-redis/cache-persistence)\n- [Redis Security](https://learn.microsoft.com/en-us/azure/azure-cache-for-redis/cache-authentication)\n- [Redis CLI Reference](https://redis.io/docs/manual/client-side-caching/)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI handles Redis cache provisioning and configuration effectively. Direct Redis commands can be used for operational tasks via redis-cli.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8 hours (with scaling, monitoring, and key management)\n- **Cleanup**: 5 minutes\n\n---\n\n## Notes\n- Standard tier is cost-effective for session and cache storage\n- Premium tier adds persistence and clustering\n- Data encryption in transit with TLS\n- Multi-zone redundancy for high availability\n- All operations scoped to single tenant and subscription\n- Supports LRU and LFU eviction policies\n- Connection pooling recommended for application use\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Azure Cache for Redis...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": ["Goal 'Scenario: Azure Cache for Redis...' is achieved"],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-azure-cache-agent...")
    print("Goal: Scenario: Azure Cache for Redis")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
