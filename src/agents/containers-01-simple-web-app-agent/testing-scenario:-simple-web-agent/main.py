#!/usr/bin/env python3
"""
testing-scenario:-simple-web-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 6,
        "initial_prompt": '# Goal: Scenario: Simple Web Application on Azure Container Apps\n\n## Objective\n# Scenario: Simple Web Application on Azure Container Apps\n\n## Technology Area\nContainers\n\n## Company Profile\n- **Company Size**: Small software company\n- **Industry**: Technology / SaaS\n- **Use Case**: Deploy a containerized web application with automatic scaling and HTTPS\n\n## Scenario Description\nDeploy a simple containerized web application (nginx) to Azure Container Apps with automatic HTTPS certificates, environment-based configuration, and the ability to scale based on HTTP traffic.\n\n## Azure Services Used\n- Azure Container Apps\n- Azure Container Registry\n- Azure Log Analytics Workspace\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed with containerapp extension (`az extension add --name containerapp`)\n- Docker installed (for building container image)\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-containers-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nCONTAINER_REGISTRY="azmkracr${UNIQUE_ID}"\nCONTAINER_APP_ENV="azurehaymaker-env-${UNIQUE_ID}"\nCONTAINER_APP="azurehaymaker-webapp-${UNIQUE_ID}"\nLOG_ANALYTICS="azurehaymaker-logs-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=containers-simple-webapp Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Azure Container Registry\naz acr create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${CONTAINER_REGISTRY}" \\\n  --sku Basic \\\n  --admin-enabled true \\\n  --tags ${TAGS}\n\n# Step 3: Build and push a simple container image\ncat > /tmp/Dockerfile <<EOF\nFROM nginx:alpine\nRUN echo \'<html><body><h1>Azure HayMaker Test App</h1><p>Scenario: containers-simple-webapp</p></body></html>\' > /usr/share/nginx/html/index.html\nEOF\n\naz acr build \\\n  --registry "${CONTAINER_REGISTRY}" \\\n  --image "haymaker-webapp:v1" \\\n  --file /tmp/Dockerfile \\\n  /tmp/\n\n# Step 4: Create Log Analytics Workspace for monitoring\naz monitor log-analytics workspace create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --workspace-name "${LOG_ANALYTICS}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\nLOG_ANALYTICS_ID=$(az monitor log-analytics workspace show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --workspace-name "${LOG_ANALYTICS}" \\\n  --query customerId -o tsv)\n\nLOG_ANALYTICS_KEY=$(az monitor log-analytics workspace get-shared-keys \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --workspace-name "${LOG_ANALYTICS}" \\\n  --query primarySharedKey -o tsv)\n\n# Step 5: Create Container Apps Environment\naz containerapp env create \\\n  --name "${CONTAINER_APP_ENV}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --logs-workspace-id "${LOG_ANALYTICS_ID}" \\\n  --logs-workspace-key "${LOG_ANALYTICS_KEY}" \\\n  --tags ${TAGS}\n\n# Step 6: Get ACR credentials\nACR_SERVER="${CONTAINER_REGISTRY}.azurecr.io"\nACR_USERNAME=$(az acr credential show --name "${CONTAINER_REGISTRY}" --query username -o tsv)\nACR_PASSWORD=$(az acr credential show --name "${CONTAINER_REGISTRY}" --query passwords[0].value -o tsv)\n\n# Step 7: Deploy Container App\naz containerapp create \\\n  --name "${CONTAINER_APP}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --environment "${CONTAINER_APP_ENV}" \\\n  --image "${ACR_SERVER}/haymaker-webapp:v1" \\\n  --registry-server "${ACR_SERVER}" \\\n  --registry-username "${ACR_USERNAME}" \\\n  --registry-password "${ACR_PASSWORD}" \\\n  --target-port 80 \\\n  --ingress external \\\n  --min-replicas 1 \\\n  --max-replicas 5 \\\n  --cpu 0.25 \\\n  --memory 0.5Gi \\\n  --tags ${TAGS}\n\n# Step 8: Get the app URL\nAPP_URL=$(az containerapp show \\\n  --name "${CONTAINER_APP}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query properties.configuration.ingress.fqdn -o tsv)\n\necho "Application URL: https://${APP_URL}"\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify Container Registry\naz acr show --name "${CONTAINER_REGISTRY}"\n\n# Verify Container App Environment\naz containerapp env show --name "${CONTAINER_APP_ENV}" --resource-group "${RESOURCE_GROUP}"\n\n# Verify Container App is running\naz containerapp show --name "${CONTAINER_APP}" --resource-group "${RESOURCE_GROUP}" --query "properties.runningStatus"\n\n# Test the application endpoint\ncurl -k "https://${APP_URL}"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Update container image\ncat > /tmp/Dockerfile.v2 <<EOF\nFROM nginx:alpine\nRUN echo \'<html><body><h1>Azure HayMaker Test App - Updated!</h1><p>Version 2</p><p>Updated at $(date)</p></body></html>\' > /usr/share/nginx/html/index.html\nEOF\n\naz acr build \\\n  --registry "${CONTAINER_REGISTRY}" \\\n  --image "haymaker-webapp:v2" \\\n  --file /tmp/Dockerfile.v2 \\\n  /tmp/\n\n# Operation 2: Update Container App to use new image\naz containerapp update \\\n  --name "${CONTAINER_APP}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --image "${ACR_SERVER}/haymaker-webapp:v2"\n\n# Operation 3: Scale up replicas manually\naz containerapp update \\\n  --name "${CONTAINER_APP}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --min-replicas 2 \\\n  --max-replicas 10\n\n# Operation 4: View application logs\naz containerapp logs show \\\n  --name "${CONTAINER_APP}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --tail 50\n\n# Operation 5: Check replica count\naz containerapp replica list \\\n  --name "${CONTAINER_APP}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --output table\n\n# Operation 6: Monitor HTTP requests\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.App/containerApps/${CONTAINER_APP}" \\\n  --metric "Requests" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 7: Restart the application\naz containerapp revision restart \\\n  --name "${CONTAINER_APP}" \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# Operation 8: List all revisions\naz containerapp revision list \\\n  --name "${CONTAINER_APP}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 2: Verify deletion\nsleep 60\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 3: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-containers-${UNIQUE_ID}-rg`\n- Container Registry: `azmkracr${UNIQUE_ID}`\n- Container App Environment: `azurehaymaker-env-${UNIQUE_ID}`\n- Container App: `azurehaymaker-webapp-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Container Apps Overview](https://learn.microsoft.com/en-us/azure/container-apps/overview)\n- [Deploy to Azure Container Apps](https://learn.microsoft.com/en-us/azure/container-apps/deploy-visual-studio-code)\n- [Azure Container Registry](https://learn.microsoft.com/en-us/azure/container-registry/)\n- [Container Apps CLI Reference](https://learn.microsoft.com/en-us/cli/azure/containerapp)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure Container Apps has excellent Azure CLI support with straightforward commands. While Bicep/Terraform are options, Azure CLI is fastest for this scenario\'s simplicity level.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8 hours (with periodic updates and monitoring)\n- **Cleanup**: 5 minutes\n\n---\n\n## Notes\n- Container Apps automatically provides HTTPS certificates\n- Automatic scaling based on HTTP requests (0-10 replicas in this example)\n- Log Analytics integration for monitoring and diagnostics\n- Container Registry admin account used for simplicity (use managed identity in production)\n- All operations scoped to single tenant and subscription\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Simple Web Application on Azure Containe...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Simple Web Application on Azure Containe...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-simple-web-agent...")
    print("Goal: Scenario: Simple Web Application on Azure Container Apps")
    print("Estimated duration: 22 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
