#!/usr/bin/env python3
"""
testing-scenario:-azure-static-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Azure Static Web Apps\n\n## Objective\n# Scenario: Azure Static Web Apps\n\n## Technology Area\nWeb Apps\n\n## Company Profile\n- **Company Size**: Small startup\n- **Industry**: Technology / Digital Agency\n- **Use Case**: Host JAMstack applications with serverless backend API\n\n## Scenario Description\nDeploy modern web applications using Azure Static Web Apps with integrated serverless functions, automatic Git deployment, and global CDN distribution.\n\n## Azure Services Used\n- Azure Static Web Apps\n- Azure Functions (serverless API)\n- Azure API Management (optional)\n- Git repository integration\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed\n- Git installed\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-webapp-static-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nSTATIC_WEB_APP="azurehaymaker-swa-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=webapps-static-web-apps Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create sample web application structure\nmkdir -p /tmp/static-app\ncd /tmp/static-app\n\nmkdir -p app\nmkdir -p api\n\n# Step 3: Create HTML frontend\ncat > /tmp/static-app/app/index.html <<EOF\n<!DOCTYPE html>\n<html lang="en">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Azure HayMaker - Static Web App</title>\n    <link rel="stylesheet" href="styles.css">\n</head>\n<body>\n    <header>\n        <h1>Azure HayMaker Static Web App</h1>\n        <p>Scenario: webapps-static-web-apps</p>\n    </header>\n    <main>\n        <section>\n            <h2>Welcome to Static Web Apps</h2>\n            <p>This is a JAMstack application hosted on Azure Static Web Apps.</p>\n            <button onclick="callApi()">Call API Function</button>\n            <div id="result"></div>\n        </section>\n    </main>\n    <script src="app.js"></script>\n</body>\n</html>\nEOF\n\ncat > /tmp/static-app/app/styles.css <<EOF\n* { margin: 0; padding: 0; box-sizing: border-box; }\nbody {\n    font-family: Arial, sans-serif;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    min-height: 100vh;\n    display: flex;\n    flex-direction: column;\n}\nheader {\n    background-color: rgba(0, 0, 0, 0.3);\n    color: white;\n    padding: 2rem;\n    text-align: center;\n}\nmain {\n    flex: 1;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    padding: 2rem;\n}\nsection {\n    background: white;\n    padding: 3rem;\n    border-radius: 10px;\n    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\n    max-width: 600px;\n    text-align: center;\n}\nbutton {\n    background-color: #667eea;\n    color: white;\n    border: none;\n    padding: 10px 20px;\n    border-radius: 5px;\n    cursor: pointer;\n    font-size: 16px;\n    margin-top: 20px;\n}\nbutton:hover { background-color: #764ba2; }\n#result {\n    margin-top: 20px;\n    padding: 10px;\n    background-color: #f0f0f0;\n    border-radius: 5px;\n    min-height: 20px;\n}\nEOF\n\ncat > /tmp/static-app/app/app.js <<EOF\nfunction callApi() {\n    fetch(\'/api/message\')\n        .then(response => response.json())\n        .then(data => {\n            document.getElementById(\'result\').textContent =\n                \'API Response: \' + JSON.stringify(data, null, 2);\n        })\n        .catch(error => {\n            document.getElementById(\'result\').textContent =\n                \'Error: \' + error.message;\n        });\n}\n\n// Call API on page load\nwindow.addEventListener(\'load\', () => {\n    fetch(\'/api/info\')\n        .then(response => response.json())\n        .then(data => console.log(\'App Info:\', data));\n});\nEOF\n\n# Step 4: Create Azure Functions API\ncat > /tmp/static-app/api/message/function.json <<EOF\n{\n  "scriptFile": "index.js",\n  "bindings": [\n    {\n      "authLevel": "anonymous",\n      "type": "httpTrigger",\n      "direction": "in",\n      "name": "req",\n      "methods": ["get", "post"]\n    },\n    {\n      "type": "http",\n      "direction": "out",\n      "name": "\\$return"\n    }\n  ]\n}\nEOF\n\ncat > /tmp/static-app/api/message/index.js <<EOF\nmodule.exports = async function (context, req) {\n    context.res = {\n        body: {\n            message: "Hello from Azure Static Web Apps",\n            timestamp: new Date().toISOString(),\n            scenario: "webapps-static-web-apps"\n        }\n    };\n};\nEOF\n\ncat > /tmp/static-app/api/info/function.json <<EOF\n{\n  "scriptFile": "index.js",\n  "bindings": [\n    {\n      "authLevel": "anonymous",\n      "type": "httpTrigger",\n      "direction": "in",\n      "name": "req",\n      "methods": ["get"]\n    },\n    {\n      "type": "http",\n      "direction": "out",\n      "name": "\\$return"\n    }\n  ]\n}\nEOF\n\ncat > /tmp/static-app/api/info/index.js <<EOF\nmodule.exports = async function (context, req) {\n    context.res = {\n        body: {\n            app: "Azure Static Web App",\n            version: "1.0.0",\n            platform: "Azure Static Web Apps",\n            uptime: process.uptime()\n        }\n    };\n};\nEOF\n\n# Step 5: Create package.json for functions\ncat > /tmp/static-app/api/package.json <<EOF\n{\n  "name": "static-web-app-api",\n  "version": "1.0.0",\n  "description": "Serverless API for Static Web App",\n  "main": "index.js",\n  "scripts": {\n    "test": "echo \\"Error: no test specified\\" && exit 1"\n  }\n}\nEOF\n\n# Step 6: Create staticwebapp.config.json\ncat > /tmp/static-app/staticwebapp.config.json <<EOF\n{\n  "routes": [\n    {\n      "route": "/api/*",\n      "allowedRoles": ["anonymous"]\n    },\n    {\n      "route": "/*",\n      "serve": "/index.html",\n      "statusCode": 200\n    }\n  ],\n  "navigationFallback": {\n    "rewrite": "index.html",\n    "exclude": ["/images/*", "/css/*"]\n  },\n  "responseOverrides": {\n    "404": {\n      "rewrite": "index.html",\n      "statusCode": 200\n    }\n  }\n}\nEOF\n\n# Step 7: Create Static Web App using managed mode\naz staticwebapp create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}" \\\n  --source "/tmp/static-app" \\\n  --location "${LOCATION}" \\\n  --build-folder "app" \\\n  --api-location "api" \\\n  --output-location "" \\\n  --tags ${TAGS}\n\n# Wait for deployment\nsleep 30\n\n# Step 8: Get Static Web App details\nSTATIC_WEB_APP_URL=$(az staticwebapp show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}" \\\n  --query "defaultDomain" -o tsv)\n\necho ""\necho "=========================================="\necho "Static Web App Created: ${STATIC_WEB_APP}"\necho "URL: https://${STATIC_WEB_APP_URL}"\necho "=========================================="\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify Static Web App\naz staticwebapp show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}"\n\n# Get deployment status\naz staticwebapp show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}" \\\n  --query "buildProperties" -o table\n\n# Get app URL\nSTATIC_WEB_APP_URL=$(az staticwebapp show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}" \\\n  --query "defaultDomain" -o tsv)\n\necho "App URL: https://${STATIC_WEB_APP_URL}"\n\n# Test application\ncurl -s "https://${STATIC_WEB_APP_URL}/" | grep "Azure HayMaker"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Create deployment slot\naz staticwebapp environment create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}" \\\n  --environment-name "staging"\n\n# Operation 2: Add custom domain (requires DNS verification)\necho "To add custom domain:"\necho "az staticwebapp hostname set --resource-group ${RESOURCE_GROUP} --name ${STATIC_WEB_APP} --hostname www.example.com"\n\n# Operation 3: Configure authentication\naz staticwebapp auth create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}" \\\n  --auth-provider "github" \\\n  --redirect-url "/.auth/login/github/callback" \\\n  --logout-url "/logout"\n\n# Operation 4: Enable custom domain HTTPS\necho "HTTPS is automatically enabled for Static Web Apps"\n\n# Operation 5: Monitor traffic and performance\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Web/staticSites/${STATIC_WEB_APP}" \\\n  --metric "Requests" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 6: View build logs\naz staticwebapp builds list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}" \\\n  --output table\n\n# Operation 7: Check API functions\necho "API Functions available at:"\necho "GET /api/message"\necho "GET /api/info"\n\n# Operation 8: Rollback to previous deployment\n# Gets list of previous deployments\naz staticwebapp builds list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}" \\\n  --query "[].id" -o tsv | head -1\n\n# Operation 9: Configure routing rules\necho "Routing configured in staticwebapp.config.json"\n\n# Operation 10: Review app configuration\naz staticwebapp config show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete Static Web App\naz staticwebapp delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STATIC_WEB_APP}" \\\n  --yes\n\n# Step 2: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 3: Verify deletion\nsleep 60\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 4: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n\n# Step 5: Clean up local files\nrm -rf /tmp/static-app\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-webapp-static-${UNIQUE_ID}-rg`\n- Static Web App: `azurehaymaker-swa-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Static Web Apps Overview](https://learn.microsoft.com/en-us/azure/static-web-apps/overview)\n- [Static Web Apps Configuration](https://learn.microsoft.com/en-us/azure/static-web-apps/configuration)\n- [Serverless Functions](https://learn.microsoft.com/en-us/azure/static-web-apps/add-api)\n- [Authentication and Authorization](https://learn.microsoft.com/en-us/azure/static-web-apps/authentication-authorization)\n- [Static Web Apps CLI Reference](https://learn.microsoft.com/en-us/cli/azure/staticwebapp)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI handles Static Web App provisioning and lifecycle management. Git integration typically handled via GitHub Actions or Azure DevOps.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8 hours (with updates and monitoring)\n- **Cleanup**: 5 minutes\n\n---\n\n## Notes\n- Automatic HTTPS with free certificates\n- Global CDN for static content distribution\n- Integrated serverless functions with no cold starts\n- JAMstack architecture support\n- All operations scoped to single tenant and subscription\n- Automatic builds and deployments from Git\n- Preview deployments for pull requests\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Azure Static Web Apps...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": ["Goal 'Scenario: Azure Static Web Apps...' is achieved"],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-azure-static-agent...")
    print("Goal: Scenario: Azure Static Web Apps")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
