#!/usr/bin/env python3
"""
testing-scenario:-computer-vision-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 6,
        "initial_prompt": '# Goal: Scenario: Computer Vision API for Image Analysis\n\n## Objective\n# Scenario: Computer Vision API for Image Analysis\n\n## Technology Area\nAI & ML\n\n## Company Profile\n- **Company Size**: Small startup\n- **Industry**: E-commerce / Product Management\n- **Use Case**: Automated product image analysis and categorization for catalog management and quality control\n\n## Scenario Description\nDeploy Azure Cognitive Services Computer Vision API to automatically analyze product images, extract object information, and generate descriptions. This scenario covers resource provisioning, image analysis operations, and management of AI service metrics and performance.\n\n## Azure Services Used\n- Azure Cognitive Services (Computer Vision)\n- Azure Storage Account (for image storage)\n- Azure Key Vault (for API credentials)\n- Azure Application Insights (for monitoring)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed and configured\n- Sample images for testing (or we\'ll create them)\n- cURL or similar tool for API calls\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-vision-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nVISION_RESOURCE="azurehaymaker-vision-${UNIQUE_ID}"\nSTORAGE_ACCOUNT="azhmakvision${UNIQUE_ID}"\nKEYVAULT="azurehaymaker-kv-${UNIQUE_ID}"\nINSIGHTS_NAME="azurehaymaker-insights-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=ai-ml-vision Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Azure Cognitive Services Computer Vision\naz cognitiveservices account create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VISION_RESOURCE}" \\\n  --kind ComputerVision \\\n  --sku S0 \\\n  --location "${LOCATION}" \\\n  --custom-domain "${VISION_RESOURCE}" \\\n  --tags ${TAGS}\n\n# Step 3: Get Computer Vision endpoint and key\nVISION_ENDPOINT=$(az cognitiveservices account show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VISION_RESOURCE}" \\\n  --query "properties.endpoint" -o tsv)\n\nVISION_KEY=$(az cognitiveservices account keys list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VISION_RESOURCE}" \\\n  --query "key1" -o tsv)\n\necho "Vision Endpoint: ${VISION_ENDPOINT}"\necho "Vision Key: ${VISION_KEY}"\n\n# Step 4: Create Storage Account for image storage\naz storage account create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --location "${LOCATION}" \\\n  --sku Standard_LRS \\\n  --kind StorageV2 \\\n  --tags ${TAGS}\n\n# Step 5: Create storage container for images\nSTORAGE_KEY=$(az storage account keys list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --query \'[0].value\' -o tsv)\n\naz storage container create \\\n  --name "product-images" \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}" \\\n  --public-access off\n\n# Step 6: Create Key Vault for credentials\naz keyvault create \\\n  --name "${KEYVAULT}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 7: Store Vision credentials in Key Vault\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "vision-endpoint" \\\n  --value "${VISION_ENDPOINT}"\n\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "vision-key" \\\n  --value "${VISION_KEY}"\n\n# Step 8: Create Application Insights for monitoring\naz monitor app-insights component create \\\n  --app "${INSIGHTS_NAME}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --kind web \\\n  --tags ${TAGS}\n\n# Step 9: Get Application Insights instrumentation key\nINSIGHTS_KEY=$(az monitor app-insights component show \\\n  --app "${INSIGHTS_NAME}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "instrumentationKey" -o tsv)\n\necho "Application Insights Key: ${INSIGHTS_KEY}"\n\n# Step 10: Create a test image file (simple PNG placeholder)\ncat > /tmp/test-image.txt << EOF\nThis is a test image file reference\nUsed for demonstrating Computer Vision API\nEOF\n\naz storage blob upload \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}" \\\n  --container-name "product-images" \\\n  --name "test-product-001.txt" \\\n  --file /tmp/test-image.txt\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify Computer Vision Resource\naz cognitiveservices account show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VISION_RESOURCE}"\n\n# Verify Storage Account\naz storage account show \\\n  --name "${STORAGE_ACCOUNT}"\n\n# Verify Storage Container\naz storage container exists \\\n  --name "product-images" \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}"\n\n# Verify Key Vault\naz keyvault show --name "${KEYVAULT}"\n\n# Verify Application Insights\naz monitor app-insights component show \\\n  --app "${INSIGHTS_NAME}" \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n\n# Test Computer Vision API connectivity\ncurl -I -X GET "${VISION_ENDPOINT}computervision/models?api-version=2024-02-01" \\\n  -H "Ocp-Apim-Subscription-Key: ${VISION_KEY}"\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Analyze an image using Computer Vision (using a public URL)\nTEST_IMAGE_URL="https://learn.microsoft.com/en-us/azure/cognitive-services/computer-vision/media/quickstarts/presentation.png"\n\ncurl -X POST "${VISION_ENDPOINT}vision/v3.2/analyze?visualFeatures=Categories,Description,Color,Objects&language=en" \\\n  -H "Ocp-Apim-Subscription-Key: ${VISION_KEY}" \\\n  -H "Content-Type: application/json" \\\n  -d "{\\"url\\":\\"${TEST_IMAGE_URL}\\"}" \\\n  | jq \'.\' > /tmp/vision-analysis-result.json\n\ncat /tmp/vision-analysis-result.json\n\n# Operation 2: Extract text from an image using OCR\ncurl -X POST "${VISION_ENDPOINT}vision/v3.2/read/analyze" \\\n  -H "Ocp-Apim-Subscription-Key: ${VISION_KEY}" \\\n  -H "Content-Type: application/json" \\\n  -d "{\\"url\\":\\"${TEST_IMAGE_URL}\\"}" \\\n  | jq \'.\'\n\n# Operation 3: Get Computer Vision account details and quota\naz cognitiveservices account show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VISION_RESOURCE}" \\\n  --query "{Name: name, Kind: kind, Sku: sku.name, Endpoint: properties.endpoint, ProvisioningState: properties.provisioningState}"\n\n# Operation 4: List all images in storage container\naz storage blob list \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}" \\\n  --container-name "product-images" \\\n  --output table\n\n# Operation 5: Monitor Computer Vision account metrics\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.CognitiveServices/accounts/${VISION_RESOURCE}" \\\n  --metric "SuccessfulRequests" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 6: Check Application Insights performance metrics\naz monitor app-insights metrics show \\\n  --app "${INSIGHTS_NAME}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --metric "performanceCounters/processCpuTime"\n\n# Operation 7: Upload additional test images\nfor i in {1..3}; do\n  cat > /tmp/test-image-${i}.txt << EOF\nTest product image ${i}\nEOF\n  az storage blob upload \\\n    --account-name "${STORAGE_ACCOUNT}" \\\n    --account-key "${STORAGE_KEY}" \\\n    --container-name "product-images" \\\n    --name "product-batch-${i}.txt" \\\n    --file /tmp/test-image-${i}.txt \\\n    --overwrite\ndone\n\n# Operation 8: Batch tag computation (list and review stored results)\naz storage blob list \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --account-key "${STORAGE_KEY}" \\\n  --container-name "product-images" \\\n  --num-results 10\n\n# Operation 9: Retrieve stored analysis results\naz keyvault secret list --vault-name "${KEYVAULT}" --output table\n\n# Operation 10: Check Computer Vision API availability and health\naz cognitiveservices account identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VISION_RESOURCE}"\n\n# Operation 11: Monitor API throttling status\ncurl -X GET "${VISION_ENDPOINT}computervision/models?api-version=2024-02-01" \\\n  -H "Ocp-Apim-Subscription-Key: ${VISION_KEY}" \\\n  -w "\\n%{http_code}\\n" \\\n  -D /tmp/vision-headers.txt\n\ncat /tmp/vision-headers.txt | grep -i "apim"\n\n# Operation 12: List all stored credentials and configuration\naz keyvault secret list --vault-name "${KEYVAULT}"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete the entire resource group (includes all resources)\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 2: Wait for deletion to complete\necho "Waiting for resource group deletion..."\nsleep 120\n\n# Step 3: Verify deletion\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 4: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-vision-${UNIQUE_ID}-rg`\n- Computer Vision: `azurehaymaker-vision-${UNIQUE_ID}`\n- Storage Account: `azhmakvision${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n- App Insights: `azurehaymaker-insights-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Computer Vision Documentation](https://learn.microsoft.com/en-us/azure/cognitive-services/computer-vision/)\n- [Computer Vision API Reference](https://learn.microsoft.com/en-us/azure/cognitive-services/computer-vision/reference)\n- [Analyze Images with Computer Vision](https://learn.microsoft.com/en-us/azure/cognitive-services/computer-vision/concept-analyzing-images)\n- [Azure Cognitive Services CLI Reference](https://learn.microsoft.com/en-us/cli/azure/cognitiveservices)\n- [Azure Storage Blobs](https://learn.microsoft.com/en-us/azure/storage/blobs/)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides straightforward commands for provisioning and managing Cognitive Services resources. The REST API calls can be made directly with curl, making this a flexible and scriptable approach for AI service operations.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8+ hours (with multiple analyses, monitoring, and batch operations)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- Computer Vision API uses pay-per-call or subscription-based billing\n- Images can be analyzed from public URLs or uploaded to storage\n- OCR supports multiple languages\n- Results are returned in JSON format with confidence scores\n- All operations scoped to single tenant and subscription\n- Storage account provides persistent image storage for batch operations\n- Key Vault securely stores API credentials\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Computer Vision API for Image Analysis...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Computer Vision API for Image Analysis...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-computer-vision-agent...")
    print("Goal: Scenario: Computer Vision API for Image Analysis")
    print("Estimated duration: 22 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
