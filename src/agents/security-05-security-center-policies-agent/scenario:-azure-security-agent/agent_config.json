{
  "bundle_id": "1217c3d6-f68d-4d8a-9ce2-edd14ec66adc",
  "name": "scenario:-azure-security-agent",
  "version": "1.0.0",
  "metadata": {
    "domain": "security-analysis",
    "complexity": "complex",
    "phase_count": 4,
    "skill_count": 2,
    "estimated_duration": "2 hours 36 minutes",
    "required_capabilities": [
      "documentation",
      "scanning",
      "enumeration",
      "scoring",
      "vulnerability-scanning",
      "reporting",
      "analysis",
      "risk-analysis"
    ],
    "skill_names": [
      "security-analyzer",
      "documenter"
    ],
    "parallel_opportunities": 0,
    "risk_factors": [
      "High complexity may require extended execution time",
      "Scan may identify critical vulnerabilities requiring immediate action"
    ]
  },
  "auto_mode_config": {
    "max_turns": 18,
    "initial_prompt": "# Goal: Scenario: Azure Security Center Policies and Recommendations\n\n## Objective\n# Scenario: Azure Security Center Policies and Recommendations\n\n## Technology Area\nSecurity\n\n## Company Profile\n- **Company Size**: Mid-size enterprise\n- **Industry**: Financial Services\n- **Use Case**: Implement comprehensive security monitoring and compliance policies through Azure Security Center\n\n## Scenario Description\nConfigure Azure Security Center (Defender for Cloud) with custom security policies, initiate compliance scanning, and apply security recommendations across resources. This scenario covers policy configuration, threat detection setup, compliance monitoring, and remediation workflows.\n\n## Azure Services Used\n- Azure Defender for Cloud (Security Center)\n- Azure Policy\n- Azure Monitor\n- Azure Log Analytics\n- Azure Security Recommendations\n- Azure Compliance Manager\n\n## Prerequisites\n- Azure subscription with Owner or Security Admin role\n- Azure CLI installed and configured (version 2.50+)\n- Azure Defender license (or free tier)\n- Access to enable diagnostic settings and monitoring\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP=\"azurehaymaker-security-${UNIQUE_ID}-rg\"\nLOCATION=\"eastus\"\nKEY_VAULT_NAME=\"azurehaymaker-kv-${UNIQUE_ID}\"\nSTORAGE_ACCOUNT=\"azurehaymaker${UNIQUE_ID}\"\nLOG_ANALYTICS_NAME=\"azurehaymaker-logs-${UNIQUE_ID}\"\nVM_NAME=\"azurehaymaker-vm-${UNIQUE_ID}\"\nAPP_SERVICE_PLAN=\"azurehaymaker-asp-${UNIQUE_ID}\"\nWEB_APP_NAME=\"azurehaymaker-app-${UNIQUE_ID}\"\nSUBSCRIPTION_ID=$(az account show --query id -o tsv)\n\n# Tags\nTAGS=\"AzureHayMaker-managed=true Scenario=security-center-policies Owner=AzureHayMaker\"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name \"${RESOURCE_GROUP}\" \\\n  --location \"${LOCATION}\" \\\n  --tags ${TAGS}\n\n# Step 2: Create Log Analytics Workspace for monitoring\nLOG_ANALYTICS_ID=$(az monitor log-analytics workspace create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --workspace-name \"${LOG_ANALYTICS_NAME}\" \\\n  --location \"${LOCATION}\" \\\n  --tags ${TAGS} \\\n  --query id -o tsv)\n\n# Step 3: Create Key Vault for compliance testing\naz keyvault create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${KEY_VAULT_NAME}\" \\\n  --location \"${LOCATION}\" \\\n  --enable-rbac-authorization \\\n  --tags ${TAGS}\n\n# Step 4: Create Storage Account for compliance testing\naz storage account create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${STORAGE_ACCOUNT}\" \\\n  --location \"${LOCATION}\" \\\n  --sku Standard_LRS \\\n  --tags ${TAGS}\n\n# Step 5: Enable encryption for Storage Account\naz storage account update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${STORAGE_ACCOUNT}\" \\\n  --require-infrastructure-encryption true\n\n# Step 6: Create SSH key for VM\naz sshkey create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"azurehaymaker-key-${UNIQUE_ID}\" \\\n  --tags ${TAGS}\n\n# Step 7: Create Virtual Machine for security monitoring\naz vm create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VM_NAME}\" \\\n  --image UbuntuLTS \\\n  --size Standard_B1s \\\n  --admin-username azureuser \\\n  --ssh-key-name \"azurehaymaker-key-${UNIQUE_ID}\" \\\n  --tags ${TAGS}\n\n# Step 8: Create App Service Plan\naz appservice plan create \\\n  --name \"${APP_SERVICE_PLAN}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --sku B1 \\\n  --is-linux \\\n  --tags ${TAGS}\n\n# Step 9: Create Web App\naz webapp create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --plan \"${APP_SERVICE_PLAN}\" \\\n  --name \"${WEB_APP_NAME}\" \\\n  --runtime \"PYTHON|3.9\" \\\n  --tags ${TAGS}\n\n# Step 10: Enable HTTPS only for Web App\naz webapp update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${WEB_APP_NAME}\" \\\n  --set httpsOnly=true\n\n# Step 11: Create diagnostic settings for Storage Account\naz monitor diagnostic-settings create \\\n  --name \"storage-diagnostics-${UNIQUE_ID}\" \\\n  --resource \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Storage/storageAccounts/${STORAGE_ACCOUNT}\" \\\n  --workspace \"${LOG_ANALYTICS_ID}\" \\\n  --logs '[{\"category\": \"StorageRead\", \"enabled\": true}, {\"category\": \"StorageWrite\", \"enabled\": true}, {\"category\": \"StorageDelete\", \"enabled\": true}]' || echo \"Storage diagnostics note: may require additional configuration\"\n\n# Step 12: Get current subscription ID for policy assignment\necho \"Subscription ID: ${SUBSCRIPTION_ID}\"\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name \"${RESOURCE_GROUP}\"\n\n# Verify Log Analytics Workspace\naz monitor log-analytics workspace show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --workspace-name \"${LOG_ANALYTICS_NAME}\"\n\n# Verify Key Vault\naz keyvault show --resource-group \"${RESOURCE_GROUP}\" --name \"${KEY_VAULT_NAME}\"\n\n# Verify Storage Account encryption\naz storage account show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${STORAGE_ACCOUNT}\" \\\n  --query \"{encryption: encryption, httpsTrafficOnlyEnabled: supportsHttpsTrafficOnly}\"\n\n# Verify Virtual Machine\naz vm show --resource-group \"${RESOURCE_GROUP}\" --name \"${VM_NAME}\"\n\n# Verify Web App HTTPS setting\naz webapp show --resource-group \"${RESOURCE_GROUP}\" --name \"${WEB_APP_NAME}\" --query httpsOnly\n\n# List all resources\naz resource list --resource-group \"${RESOURCE_GROUP}\" --output table\n\n# Check Defender for Cloud status\naz security auto-provisioning-setting list 2>/dev/null || echo \"Defender for Cloud listing may require additional permissions\"\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Create custom policy definition for encryption\ncat > /tmp/policy-${UNIQUE_ID}.json <<'EOF'\n{\n  \"mode\": \"Indexed\",\n  \"policyRule\": {\n    \"if\": {\n      \"field\": \"type\",\n      \"equals\": \"Microsoft.Storage/storageAccounts\"\n    },\n    \"then\": {\n      \"effect\": \"audit\",\n      \"details\": {\n        \"field\": \"Microsoft.Storage/storageAccounts/encryption.services.blob.enabled\",\n        \"equals\": \"true\"\n      }\n    }\n  },\n  \"parameters\": {}\n}\nEOF\n\n# Operation 2: Create policy definition\nPOLICY_DEF_ID=$(az policy definition create \\\n  --name \"azurehaymaker-storage-encryption-policy-${UNIQUE_ID}\" \\\n  --display-name \"Audit storage account encryption\" \\\n  --rules /tmp/policy-${UNIQUE_ID}.json \\\n  --query id -o tsv)\n\necho \"Policy Definition ID: ${POLICY_DEF_ID}\"\n\n# Operation 3: Assign the custom policy to resource group\naz policy assignment create \\\n  --name \"azurehaymaker-storage-audit-${UNIQUE_ID}\" \\\n  --policy \"${POLICY_DEF_ID}\" \\\n  --scope \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}\" || echo \"Policy assignment may require owner permissions\"\n\n# Operation 4: List built-in security policies\naz policy definition list \\\n  --query \"[?contains(displayName, 'security') || contains(displayName, 'encryption')].{name:name, displayName:displayName}\" \\\n  --output table | head -20\n\n# Operation 5: Enable MFA requirement policy\naz policy assignment create \\\n  --name \"audit-mfa-${UNIQUE_ID}\" \\\n  --display-name \"Audit accounts without multi-factor authentication\" \\\n  --policy \"40658b76-0a34-4ab9-a084-17f3dada1146\" \\\n  --scope \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}\" 2>/dev/null || echo \"MFA policy assignment may require specific conditions\"\n\n# Operation 6: View security recommendations for resources\naz security assessment list --resource-group \"${RESOURCE_GROUP}\" --output table 2>/dev/null || echo \"Assessments may require Defender for Cloud subscription\"\n\n# Operation 7: Check vulnerability assessments on VM\naz security vm-metadata list 2>/dev/null || echo \"VM metadata scanning may require Defender for Cloud\"\n\n# Operation 8: Create Azure Policy for NSG rules\ncat > /tmp/nsg-policy-${UNIQUE_ID}.json <<'EOF'\n{\n  \"mode\": \"All\",\n  \"policyRule\": {\n    \"if\": {\n      \"field\": \"type\",\n      \"equals\": \"Microsoft.Network/networkSecurityGroups/securityRules\"\n    },\n    \"then\": {\n      \"effect\": \"audit\",\n      \"details\": {\n        \"field\": \"Microsoft.Network/networkSecurityGroups/securityRules/access\",\n        \"notEquals\": \"Allow\"\n      }\n    }\n  },\n  \"parameters\": {}\n}\nEOF\n\n# Operation 9: Enable threat detection on Storage\naz storage account threat-protection update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${STORAGE_ACCOUNT}\" \\\n  --enable true 2>/dev/null || echo \"Threat detection requires additional configuration\"\n\n# Operation 10: List compliance information\naz policy assignment list --scope \"/subscriptions/${SUBSCRIPTION_ID}\" --query \"[].{displayName:displayName, policyDefinitionId:policyDefinitionId}\" --output table | head -10\n\n# Operation 11: Create auto-remediation policy\naz policy assignment create \\\n  --name \"auto-remediate-logging-${UNIQUE_ID}\" \\\n  --policy \"e4b3d4d5-6e3f-4d7d-8e3f-3d3f3d3f3d3f\" \\\n  --scope \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}\" \\\n  --enforce 2>/dev/null || echo \"Auto-remediation assignment noted\"\n\n# Operation 12: Check Key Vault diagnostics settings\naz monitor diagnostic-settings list \\\n  --resource \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.KeyVault/vaults/${KEY_VAULT_NAME}\" \\\n  --query \"[].{name:name, workspaceId:workspaceId}\" 2>/dev/null || echo \"Diagnostics listing in progress\"\n\n# Operation 13: Export security posture summary\necho \"Security Posture Report - $(date)\" > /tmp/security-report-${UNIQUE_ID}.txt\necho \"Resource Group: ${RESOURCE_GROUP}\" >> /tmp/security-report-${UNIQUE_ID}.txt\necho \"Subscription: ${SUBSCRIPTION_ID}\" >> /tmp/security-report-${UNIQUE_ID}.txt\necho \"Resources in scope:\" >> /tmp/security-report-${UNIQUE_ID}.txt\naz resource list --resource-group \"${RESOURCE_GROUP}\" --query \"[].{name:name, type:type}\" --output table >> /tmp/security-report-${UNIQUE_ID}.txt\n\n# Operation 14: Configure allowed resource types policy\naz policy assignment create \\\n  --name \"allowed-resources-${UNIQUE_ID}\" \\\n  --display-name \"Allowed resource types\" \\\n  --policy \"a08f37ab-19e9-468e-a74f-08088bb1141a\" \\\n  --scope \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}\" \\\n  --params '{\"listOfResourceTypesAllowed\": [\"Microsoft.Compute/virtualMachines\", \"Microsoft.Storage/storageAccounts\", \"Microsoft.Web/sites\"]}' \\\n  --enforce 2>/dev/null || echo \"Allowed resources policy assignment noted\"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete all policy assignments\nfor ASSIGNMENT in $(az policy assignment list --scope \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}\" --query \"[].name\" -o tsv); do\n  az policy assignment delete --name \"${ASSIGNMENT}\" --scope \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}\" --yes 2>/dev/null || true\ndone\n\n# Step 2: Delete custom policy definitions\naz policy definition delete \\\n  --name \"azurehaymaker-storage-encryption-policy-${UNIQUE_ID}\" \\\n  --yes 2>/dev/null || true\n\n# Step 3: Delete diagnostic settings\nfor DIAGNOSTIC in $(az monitor diagnostic-settings list --resource \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}\" --query \"[].name\" -o tsv 2>/dev/null); do\n  az monitor diagnostic-settings delete \\\n    --name \"${DIAGNOSTIC}\" \\\n    --resource \"/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}\" \\\n    --yes 2>/dev/null || true\ndone\n\n# Step 4: Delete the entire resource group (includes all resources)\naz group delete \\\n  --name \"${RESOURCE_GROUP}\" \\\n  --yes \\\n  --no-wait\n\n# Step 5: Wait for deletion to complete\necho \"Waiting for resource group deletion...\"\nsleep 120\n\n# Step 6: Verify deletion\naz group exists --name \"${RESOURCE_GROUP}\"\n\n# Step 7: Confirm cleanup\necho \"Verifying cleanup...\"\naz resource list --resource-group \"${RESOURCE_GROUP}\" 2>&1 | grep \"could not be found\" && echo \"\u2713 Resource group successfully deleted\"\n\n# Step 8: Clean up local files\nrm -f /tmp/policy-${UNIQUE_ID}.json\nrm -f /tmp/nsg-policy-${UNIQUE_ID}.json\nrm -f /tmp/security-report-${UNIQUE_ID}.txt\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-security-${UNIQUE_ID}-rg`\n- Virtual Machine: `azurehaymaker-vm-${UNIQUE_ID}`\n- App Service Plan: `azurehaymaker-asp-${UNIQUE_ID}`\n- Web App: `azurehaymaker-app-${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n- Storage Account: `azurehaymaker${UNIQUE_ID}`\n- Log Analytics: `azurehaymaker-logs-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Defender for Cloud Overview](https://learn.microsoft.com/en-us/azure/defender-for-cloud/defender-for-cloud-introduction)\n- [Azure Policy Overview](https://learn.microsoft.com/en-us/azure/governance/policy/overview)\n- [Security Center Recommendations](https://learn.microsoft.com/en-us/azure/defender-for-cloud/recommendations-reference)\n- [Azure Compliance Manager](https://learn.microsoft.com/en-us/compliance/compliance-manager/compliance-manager-overview)\n- [Azure Policy Built-in Policies](https://learn.microsoft.com/en-us/azure/governance/policy/samples/built-in-policies)\n- [Security Best Practices](https://learn.microsoft.com/en-us/azure/security/fundamentals/best-practices-and-patterns)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI with Azure Policy\n\n**Rationale**: Azure CLI provides comprehensive security monitoring and policy management capabilities. Direct commands enable rapid security posture assessment and policy enforcement across resources.\n\n---\n\n## Estimated Duration\n- **Deployment**: 15-20 minutes\n- **Operations Phase**: 8+ hours (with policy monitoring, compliance scanning, and security recommendations review)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- Azure Defender for Cloud provides threat detection and vulnerability scanning\n- Azure Policy enables compliance and governance at scale\n- Security recommendations provide actionable guidance for remediation\n- Policies can be enforced or audit-only for compliance monitoring\n- Log Analytics integration enables comprehensive security monitoring\n- All resources benefit from continuous security assessment\n- Operations scoped to single subscription with resource group isolation\n- Compliance frameworks include CIS, PCI-DSS, HIPAA, and more\n\n\n## Execution Plan\n\n### Phase 1: Reconnaissance\nScan and identify targets\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: scanning, enumeration\n\n### Phase 2: Vulnerability Detection\nDetect potential vulnerabilities\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: vulnerability-scanning, analysis\n**Dependencies**: Reconnaissance\n\n### Phase 3: Risk Assessment\nAssess and prioritize risks\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: risk-analysis, scoring\n**Dependencies**: Vulnerability Detection\n\n### Phase 4: Reporting\nGenerate security report\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: reporting, documentation\n**Dependencies**: Risk Assessment\n\n## Success Criteria\n- Goal 'Scenario: Azure Security Center Policies and Recom...' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion",
    "working_dir": ".",
    "sdk": "claude",
    "ui_mode": false,
    "success_criteria": [
      "Goal 'Scenario: Azure Security Center Policies and Recom...' is achieved"
    ],
    "constraints": []
  }
}
