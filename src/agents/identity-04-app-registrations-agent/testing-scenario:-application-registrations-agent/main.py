#!/usr/bin/env python3
"""
testing-scenario:-application-registrations-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Application Registrations and Permissions\n\n## Objective\n# Scenario: Application Registrations and Permissions\n\n## Technology Area\nIdentity\n\n## Company Profile\n- **Company Size**: Mid-size\n- **Industry**: SaaS Platform\n- **Use Case**: Register cloud applications with Entra ID and manage API permissions for multi-tenant scenarios\n\n## Scenario Description\nRegister applications with Entra ID to enable secure authentication and authorization. This scenario covers creating app registrations, managing client secrets, configuring API permissions, and setting up application roles for delegated and application-based access patterns.\n\n## Azure Services Used\n- Azure Entra ID (formerly Azure AD)\n- Application Registrations\n- API Permissions\n- Client Secrets\n- Azure AD Graph API\n- Microsoft Graph API\n\n## Prerequisites\n- Azure subscription with Application Administrator role\n- Azure CLI installed and configured\n- Appropriate permissions to register applications in Entra ID\n- Understanding of OAuth 2.0 and API permission scopes\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-apps-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nTENANT_ID=$(az account show --query tenantId -o tsv)\nAPP_PREFIX="azurehaymaker-app-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=identity-app-registrations Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create first application registration (Web app)\nAPP_01=$(az ad app create \\\n  --display-name "${APP_PREFIX}-webapp-01" \\\n  --sign-in-audience AzureADMyOrg \\\n  --web-redirect-uris "https://localhost:3000/auth/callback" "https://localhost:8080/callback" \\\n  --output json)\n\nAPP_01_ID=$(echo $APP_01 | jq -r \'.id\')\nAPP_01_APPID=$(echo $APP_01 | jq -r \'.appId\')\n\n# Step 3: Create second application registration (API)\nAPP_02=$(az ad app create \\\n  --display-name "${APP_PREFIX}-api-02" \\\n  --sign-in-audience AzureADMultipleOrgs \\\n  --output json)\n\nAPP_02_ID=$(echo $APP_02 | jq -r \'.id\')\nAPP_02_APPID=$(echo $APP_02 | jq -r \'.appId\')\n\n# Step 4: Create third application registration (Mobile app)\nAPP_03=$(az ad app create \\\n  --display-name "${APP_PREFIX}-mobile-03" \\\n  --public-client-redirect-uris "msal${APP_PREFIX}://auth" \\\n  --sign-in-audience AzureADMyOrg \\\n  --output json)\n\nAPP_03_ID=$(echo $APP_03 | jq -r \'.id\')\nAPP_03_APPID=$(echo $APP_03 | jq -r \'.appId\')\n\n# Step 5: Add client secret to first application\nSECRET_01=$(az ad app credential reset \\\n  --id "${APP_01_ID}" \\\n  --years 1 \\\n  --output json)\n\nSECRET_01_VALUE=$(echo $SECRET_01 | jq -r \'.password\')\n\n# Step 6: Add client secret to second application\nSECRET_02=$(az ad app credential reset \\\n  --id "${APP_02_ID}" \\\n  --years 2 \\\n  --output json)\n\nSECRET_02_ID=$(echo $SECRET_02 | jq -r \'.keyId\')\n\n# Step 7: Create service principal for first app\nSP_01=$(az ad sp create \\\n  --id "${APP_01_APPID}" \\\n  --output json)\n\nSP_01_OBJECT_ID=$(echo $SP_01 | jq -r \'.id\')\n\n# Step 8: Create service principal for second app\nSP_02=$(az ad sp create \\\n  --id "${APP_02_APPID}" \\\n  --output json)\n\nSP_02_OBJECT_ID=$(echo $SP_02 | jq -r \'.id\')\n\n# Step 9: Create service principal for third app\nSP_03=$(az ad sp create \\\n  --id "${APP_03_APPID}" \\\n  --output json)\n\nSP_03_OBJECT_ID=$(echo $SP_03 | jq -r \'.id\')\n\necho "App 1 ID: ${APP_01_APPID}"\necho "App 2 ID: ${APP_02_APPID}"\necho "App 3 ID: ${APP_03_APPID}"\necho "Secret stored securely (use Key Vault in production)"\n```\n\n### Validation\n```bash\n# Verify resource group\naz group show --name "${RESOURCE_GROUP}" --output table\n\n# List all created app registrations\naz ad app list --filter "startswith(displayName, \'${APP_PREFIX}\')" --output table\n\n# Get details of first app\naz ad app show --id "${APP_01_APPID}" --output table\n\n# Get details of second app\naz ad app show --id "${APP_02_APPID}" --output table\n\n# Get details of third app\naz ad app show --id "${APP_03_APPID}" --output table\n\n# List service principals\naz ad sp list --filter "startswith(displayName, \'${APP_PREFIX}\')" --output table\n\n# Check client secrets for app 1\naz ad app credential list --id "${APP_01_ID}" --output table\n\n# Check credentials for app 2\naz ad app credential list --id "${APP_02_ID}" --output table\n\n# Verify redirect URIs\naz ad app show --id "${APP_01_APPID}" --query "web.redirectUris" --output json\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Add additional redirect URI to application\naz ad app update \\\n  --id "${APP_01_ID}" \\\n  --web-redirect-uris "https://localhost:3000/auth/callback" "https://localhost:8080/callback" "https://prod.example.com/callback"\n\n# Operation 2: Update application display name\naz ad app update \\\n  --id "${APP_01_ID}" \\\n  --display-name "${APP_PREFIX}-webapp-01-updated"\n\n# Operation 3: List all credentials for an application\naz ad app credential list \\\n  --id "${APP_01_ID}" \\\n  --output table\n\n# Operation 4: Create additional client secret\nNEW_SECRET=$(az ad app credential reset \\\n  --id "${APP_02_ID}" \\\n  --years 1 \\\n  --output json)\n\nNEW_SECRET_ID=$(echo $NEW_SECRET | jq -r \'.keyId\')\n\n# Operation 5: Delete specific credential by ID\n# Note: Use with caution - this will revoke access for clients using this credential\n# az ad app credential delete --id "${APP_01_ID}" --key-id <key-id>\n\n# Operation 6: Add API permissions to application (Microsoft Graph API)\naz ad app permission add \\\n  --id "${APP_01_APPID}" \\\n  --api 00000003-0000-0000-c000-000000000000 \\\n  --api-permissions e1fe6dd8-ba31-4d61-89e7-88639da4683d=Scope\n\n# Operation 7: List existing API permissions\naz ad app permission list \\\n  --id "${APP_01_APPID}" \\\n  --output table\n\n# Operation 8: Grant admin consent for API permissions (simulated)\n# In production, use: az ad app permission admin-consent --id <app-id>\naz ad app permission list --id "${APP_01_APPID}" --query "[].{resourceAppId:resourceAppId, id:id}" --output table\n\n# Operation 9: Update application properties\naz ad app update \\\n  --id "${APP_02_ID}" \\\n  --set "description=API application for data processing"\n\n# Operation 10: Assign role to service principal\naz role assignment create \\\n  --assignee-object-id "${SP_01_OBJECT_ID}" \\\n  --role "Reader" \\\n  --scope "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}"\n\n# Operation 11: Check service principal properties\naz ad sp show \\\n  --id "${SP_01_OBJECT_ID}" \\\n  --query "[displayName, appId, accountEnabled]" \\\n  --output table\n\n# Operation 12: Generate JWT token (simulated - for testing client credentials flow)\n# In production: az account get-access-token --resource-id <app-id>\naz ad app show \\\n  --id "${APP_02_APPID}" \\\n  --query "[appId, id, displayName]" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Remove role assignments from service principals\naz role assignment delete \\\n  --assignee-object-id "${SP_01_OBJECT_ID}" \\\n  --role "Reader" \\\n  --scope "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}" \\\n  2>/dev/null || true\n\n# Step 2: Delete service principals\naz ad sp delete --id "${SP_01_OBJECT_ID}" 2>/dev/null || true\naz ad sp delete --id "${SP_02_OBJECT_ID}" 2>/dev/null || true\naz ad sp delete --id "${SP_03_OBJECT_ID}" 2>/dev/null || true\n\n# Step 3: Delete application registrations\naz ad app delete --id "${APP_01_ID}" 2>/dev/null || true\naz ad app delete --id "${APP_02_ID}" 2>/dev/null || true\naz ad app delete --id "${APP_03_ID}" 2>/dev/null || true\n\n# Step 4: Delete resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 5: Wait for deletion\necho "Waiting for cleanup to complete..."\nsleep 60\n\n# Step 6: Verify applications are deleted\naz ad app list --filter "startswith(displayName, \'${APP_PREFIX}\')" --output table\n\n# Step 7: Verify service principals are deleted\naz ad sp list --filter "startswith(displayName, \'${APP_PREFIX}\')" --output table\n\n# Step 8: Verify resource group deletion\naz group exists --name "${RESOURCE_GROUP}"\n\necho "Applications, service principals, and resources successfully cleaned up"\n```\n\n---\n\n## Resource Naming Convention\n- Web App: `${APP_PREFIX}-webapp-01`\n- API App: `${APP_PREFIX}-api-02`\n- Mobile App: `${APP_PREFIX}-mobile-03`\n- Resource Group: `azurehaymaker-apps-${UNIQUE_ID}-rg`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Application Registration in Entra ID](https://learn.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals)\n- [Register an Application](https://learn.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app)\n- [Client Credentials Grant Flow](https://learn.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-client-creds-grant-flow)\n- [API Permissions and Consent](https://learn.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent)\n- [Azure CLI AD App Commands](https://learn.microsoft.com/en-us/cli/azure/ad/app)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive application registration management with commands for creating apps, managing secrets, and configuring permissions. The CLI is ideal for automating application lifecycle and authentication workflows.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8+ hours (credential rotation, permission management, testing)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- Application registrations represent your application in Entra ID\n- Service principals are the runtime instance of the app registration\n- Client secrets should be stored securely in Azure Key Vault\n- API permissions define what resources the app can access\n- Redirect URIs are validated during OAuth 2.0 flows\n- Multi-tenant apps can be used across multiple Entra ID tenants\n- Admin consent is required for certain sensitive permissions\n- Credential rotation should be performed regularly for security\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Application Registrations and Permission...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Application Registrations and Permission...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-application-registrations-agent...")
    print("Goal: Scenario: Application Registrations and Permissions")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
