{
  "bundle_id": "9acd01de-4f39-44f2-b680-16f77972138c",
  "name": "testing-scenario:-application-gateway-agent",
  "version": "1.0.0",
  "metadata": {
    "domain": "testing",
    "complexity": "complex",
    "phase_count": 4,
    "skill_count": 2,
    "estimated_duration": "2 hours 36 minutes",
    "required_capabilities": [
      "planning",
      "test-execution",
      "automation",
      "reporting",
      "analysis",
      "test-coding",
      "test-design",
      "framework-setup"
    ],
    "skill_names": [
      "tester",
      "documenter"
    ],
    "parallel_opportunities": 0,
    "risk_factors": [
      "High complexity may require extended execution time"
    ]
  },
  "auto_mode_config": {
    "max_turns": 18,
    "initial_prompt": "# Goal: Scenario: Application Gateway with Web Application Firewall\n\n## Objective\n# Scenario: Application Gateway with Web Application Firewall\n\n## Technology Area\nNetworking\n\n## Company Profile\n- **Company Size**: Mid-size to large enterprise\n- **Industry**: Finance / Healthcare / E-commerce\n- **Use Case**: Secure application delivery with advanced routing, SSL/TLS termination, and threat protection\n\n## Scenario Description\nDeploy an Azure Application Gateway configured with Web Application Firewall (WAF), backend pools with multiple instances, path-based routing rules, and HTTPS listener configuration. This scenario covers gateway provisioning, WAF policies, health probes, routing rules, and SSL/TLS management.\n\n## Azure Services Used\n- Azure Application Gateway with WAF\n- Azure Virtual Network\n- Azure Public IP\n- Azure Virtual Machines\n- Azure Network Security Groups\n- Azure Key Vault (optional for certificates)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed and configured\n- Understanding of HTTP/HTTPS routing and firewall concepts\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP=\"azurehaymaker-appgw-${UNIQUE_ID}-rg\"\nLOCATION=\"eastus\"\nVNET_NAME=\"azurehaymaker-vnet-${UNIQUE_ID}\"\nGATEWAY_SUBNET=\"azurehaymaker-gateway-${UNIQUE_ID}\"\nBACKEND_SUBNET=\"azurehaymaker-backend-${UNIQUE_ID}\"\nAPP_GW_NAME=\"azurehaymaker-appgw-${UNIQUE_ID}\"\nAPP_GW_IP=\"azurehaymaker-appgw-pip-${UNIQUE_ID}\"\nBACKEND_POOL=\"azurehaymaker-backend-pool-${UNIQUE_ID}\"\nHEALTH_PROBE=\"azurehaymaker-health-probe-${UNIQUE_ID}\"\nHTTP_SETTINGS=\"azurehaymaker-http-settings-${UNIQUE_ID}\"\nLISTENER_HTTP=\"azurehaymaker-listener-http-${UNIQUE_ID}\"\nROUTING_RULE=\"azurehaymaker-routing-rule-${UNIQUE_ID}\"\nWAF_POLICY=\"azurehaymaker-waf-policy-${UNIQUE_ID}\"\nNSG_NAME=\"azurehaymaker-appgw-nsg-${UNIQUE_ID}\"\n\n# Tags\nTAGS=\"AzureHayMaker-managed=true Scenario=networking-application-gateway Owner=AzureHayMaker\"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name \"${RESOURCE_GROUP}\" \\\n  --location \"${LOCATION}\" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network\naz network vnet create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VNET_NAME}\" \\\n  --address-prefix 10.0.0.0/16 \\\n  --tags ${TAGS}\n\n# Step 3: Create Gateway Subnet (required for Application Gateway)\naz network vnet subnet create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${GATEWAY_SUBNET}\" \\\n  --address-prefix 10.0.1.0/24\n\n# Step 4: Create Backend Subnet for virtual machines\naz network vnet subnet create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${BACKEND_SUBNET}\" \\\n  --address-prefix 10.0.2.0/24\n\n# Step 5: Create Network Security Group for gateway\naz network nsg create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NSG_NAME}\" \\\n  --tags ${TAGS}\n\n# Step 6: Add NSG rules for Application Gateway\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_NAME}\" \\\n  --name \"allow-gatewaymanager\" \\\n  --priority 1000 \\\n  --source-address-prefixes \"GatewayManager\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"*\" \\\n  --destination-port-ranges \"65200-65535\" \\\n  --access Allow \\\n  --protocol Tcp\n\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_NAME}\" \\\n  --name \"allow-http-https\" \\\n  --priority 1001 \\\n  --source-address-prefixes \"*\" \\\n  --source-port-ranges \"*\" \\\n  --destination-address-prefixes \"*\" \\\n  --destination-port-ranges 80 443 \\\n  --access Allow \\\n  --protocol Tcp\n\n# Step 7: Associate NSG with gateway subnet\naz network vnet subnet update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"${GATEWAY_SUBNET}\" \\\n  --network-security-group \"${NSG_NAME}\"\n\n# Step 8: Create public IP for Application Gateway\naz network public-ip create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${APP_GW_IP}\" \\\n  --allocation-method Static \\\n  --sku Standard \\\n  --tags ${TAGS}\n\n# Step 9: Create Application Gateway\naz network application-gateway create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${APP_GW_NAME}\" \\\n  --location \"${LOCATION}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --subnet \"${GATEWAY_SUBNET}\" \\\n  --public-ip-address \"${APP_GW_IP}\" \\\n  --http-settings-cookie-based-affinity Enabled \\\n  --sku WAF_v2 \\\n  --capacity 2 \\\n  --tags ${TAGS}\n\n# Step 10: Create Web Application Firewall policy\naz network application-gateway waf-policy create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${WAF_POLICY}\" \\\n  --type OWASP \\\n  --version 3.1 \\\n  --tags ${TAGS}\n\n# Step 11: Associate WAF policy with Application Gateway\naz network application-gateway update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${APP_GW_NAME}\" \\\n  --waf-policy \"${WAF_POLICY}\"\n\n# Step 12: Create backend pool\naz network application-gateway address-pool create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --name \"${BACKEND_POOL}\" \\\n  --servers 10.0.2.4 10.0.2.5\n\n# Step 13: Create HTTP settings\naz network application-gateway http-settings create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --name \"${HTTP_SETTINGS}\" \\\n  --port 80 \\\n  --protocol Http \\\n  --cookie-based-affinity Enabled \\\n  --request-timeout 20\n\n# Step 14: Create health probe\naz network application-gateway probe create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --name \"${HEALTH_PROBE}\" \\\n  --protocol http \\\n  --host-name \"localhost\" \\\n  --path \"/\" \\\n  --port 80 \\\n  --match-status-codes 200-399\n\n# Step 15: Update HTTP settings to use health probe\naz network application-gateway http-settings update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --name \"${HTTP_SETTINGS}\" \\\n  --probe \"${HEALTH_PROBE}\"\n\n# Step 16: Create HTTP listener\naz network application-gateway http-listener create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --name \"${LISTENER_HTTP}\" \\\n  --frontend-ip \"appGatewayFrontendIP\" \\\n  --frontend-port \"appGatewayFrontendPort\" \\\n  --host-name \"*.example.com\"\n\n# Step 17: Create routing rule\naz network application-gateway rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --name \"${ROUTING_RULE}\" \\\n  --http-listener \"${LISTENER_HTTP}\" \\\n  --rule-type Basic \\\n  --address-pool \"${BACKEND_POOL}\" \\\n  --http-settings \"${HTTP_SETTINGS}\"\n\n# Step 18: Create SSH key for VMs\nSSH_KEY_NAME=\"azurehaymaker-key-${UNIQUE_ID}\"\naz sshkey create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${SSH_KEY_NAME}\" \\\n  --tags ${TAGS}\n\n# Step 19: Create backend VMs (simplified - using network interface only)\nVM1_NAME=\"azurehaymaker-vm1-${UNIQUE_ID}\"\nVM2_NAME=\"azurehaymaker-vm2-${UNIQUE_ID}\"\nNIC1_NAME=\"azurehaymaker-nic1-${UNIQUE_ID}\"\nNIC2_NAME=\"azurehaymaker-nic2-${UNIQUE_ID}\"\n\naz network nic create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NIC1_NAME}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --subnet \"${BACKEND_SUBNET}\" \\\n  --private-ip-address \"10.0.2.4\" \\\n  --tags ${TAGS}\n\naz network nic create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NIC2_NAME}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --subnet \"${BACKEND_SUBNET}\" \\\n  --private-ip-address \"10.0.2.5\" \\\n  --tags ${TAGS}\n\n# Step 20: Create VMs\naz vm create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VM1_NAME}\" \\\n  --nics \"${NIC1_NAME}\" \\\n  --image UbuntuLTS \\\n  --size Standard_B1s \\\n  --admin-username azureuser \\\n  --ssh-key-name \"${SSH_KEY_NAME}\" \\\n  --os-disk-name \"azurehaymaker-osdisk1-${UNIQUE_ID}\" \\\n  --tags ${TAGS}\n\naz vm create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VM2_NAME}\" \\\n  --nics \"${NIC2_NAME}\" \\\n  --image UbuntuLTS \\\n  --size Standard_B1s \\\n  --admin-username azureuser \\\n  --ssh-key-name \"${SSH_KEY_NAME}\" \\\n  --os-disk-name \"azurehaymaker-osdisk2-${UNIQUE_ID}\" \\\n  --tags ${TAGS}\n\n# Step 21: Install web server on VMs\naz vm run-command invoke \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VM1_NAME}\" \\\n  --command-id RunShellScript \\\n  --scripts \"sudo apt-get update && sudo apt-get install -y nginx && sudo systemctl start nginx && sudo systemctl enable nginx\"\n\naz vm run-command invoke \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VM2_NAME}\" \\\n  --command-id RunShellScript \\\n  --scripts \"sudo apt-get update && sudo apt-get install -y nginx && sudo systemctl start nginx && sudo systemctl enable nginx\"\n\n# Step 22: Get Application Gateway public IP\nAPP_GW_IP_ADDR=$(az network public-ip show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${APP_GW_IP}\" \\\n  --query ipAddress -o tsv)\n\necho \"Application Gateway Public IP: ${APP_GW_IP_ADDR}\"\n```\n\n### Validation\n```bash\n# Verify Application Gateway\naz network application-gateway show --resource-group \"${RESOURCE_GROUP}\" --name \"${APP_GW_NAME}\"\n\n# Verify WAF policy\naz network application-gateway waf-policy show --resource-group \"${RESOURCE_GROUP}\" --name \"${WAF_POLICY}\"\n\n# Verify backend pool\naz network application-gateway address-pool show --resource-group \"${RESOURCE_GROUP}\" --gateway-name \"${APP_GW_NAME}\" --name \"${BACKEND_POOL}\"\n\n# Verify health probe\naz network application-gateway probe show --resource-group \"${RESOURCE_GROUP}\" --gateway-name \"${APP_GW_NAME}\" --name \"${HEALTH_PROBE}\"\n\n# Verify routing rules\naz network application-gateway rule list --resource-group \"${RESOURCE_GROUP}\" --gateway-name \"${APP_GW_NAME}\" --output table\n\n# Check VM states\naz vm list --resource-group \"${RESOURCE_GROUP}\" --output table\n\n# Test HTTP connectivity\necho \"Testing Application Gateway connectivity...\"\ncurl -I \"http://${APP_GW_IP_ADDR}/\" || echo \"Note: May need to wait for VMs to initialize\"\n\n# List all resources\naz resource list --resource-group \"${RESOURCE_GROUP}\" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: View Application Gateway configuration\naz network application-gateway show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${APP_GW_NAME}\" \\\n  --query \"{name: name, skuName: sku.name, capacity: sku.capacity, operationalState: operationalState}\"\n\n# Operation 2: Check backend health status\naz network application-gateway show-backend-health \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${APP_GW_NAME}\"\n\n# Operation 3: Monitor Application Gateway metrics - throughput\naz monitor metrics list \\\n  --resource \"/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Network/applicationGateways/${APP_GW_NAME}\" \\\n  --metric \"BytesReceived BytesSent\" \\\n  --start-time $(date -u -d '1 hour ago' '+%Y-%m-%dT%H:%M:%SZ') \\\n  --end-time $(date -u '+%Y-%m-%dT%H:%M:%SZ')\n\n# Operation 4: Monitor Application Gateway metrics - request count\naz monitor metrics list \\\n  --resource \"/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Network/applicationGateways/${APP_GW_NAME}\" \\\n  --metric \"RequestCount\" \\\n  --start-time $(date -u -d '1 hour ago' '+%Y-%m-%dT%H:%M:%SZ') \\\n  --end-time $(date -u '+%Y-%m-%dT%H:%M:%SZ')\n\n# Operation 5: Create additional routing rule for path-based routing\nPATH_RULE=\"azurehaymaker-path-rule-${UNIQUE_ID}\"\naz network application-gateway rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --name \"${PATH_RULE}\" \\\n  --http-listener \"${LISTENER_HTTP}\" \\\n  --rule-type PathBasedRouting \\\n  --address-pool \"${BACKEND_POOL}\" \\\n  --http-settings \"${HTTP_SETTINGS}\" \\\n  --paths \"/api/*\" \"/health/*\"\n\n# Operation 6: Update WAF policy to enable managed rules\naz network application-gateway waf-policy managed-rules add \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${WAF_POLICY}\" \\\n  --rules-group-name \"GeoBlocking\"\n\n# Operation 7: List all HTTP listeners\naz network application-gateway http-listener list \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --output table\n\n# Operation 8: Update backend pool with additional servers\naz network application-gateway address-pool update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --name \"${BACKEND_POOL}\" \\\n  --servers 10.0.2.4 10.0.2.5 10.0.2.6\n\n# Operation 9: Update VM1 with custom web content\naz vm run-command invoke \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VM1_NAME}\" \\\n  --command-id RunShellScript \\\n  --scripts \"sudo tee /var/www/html/index.html > /dev/null <<'EOF'\n<!DOCTYPE html>\n<html>\n<head><title>AppGW Test</title></head>\n<body><h1>Azure Application Gateway - Backend Server 1</h1><p>Protected by WAF</p></body>\n</html>\nEOF\"\n\n# Operation 10: Update VM2 with custom web content\naz vm run-command invoke \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VM2_NAME}\" \\\n  --command-id RunShellScript \\\n  --scripts \"sudo tee /var/www/html/index.html > /dev/null <<'EOF'\n<!DOCTYPE html>\n<html>\n<head><title>AppGW Test</title></head>\n<body><h1>Azure Application Gateway - Backend Server 2</h1><p>Protected by WAF</p></body>\n</html>\nEOF\"\n\n# Operation 11: Monitor WAF-blocked requests\naz monitor log-analytics query \\\n  --workspace \"workspace-name\" \\\n  --analytics-query \"AzureDiagnostics | where ResourceType == 'APPLICATIONGATEWAYS' and Message contains 'Matched'\"\n\n# Operation 12: Verify HTTP settings configuration\naz network application-gateway http-settings show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --gateway-name \"${APP_GW_NAME}\" \\\n  --name \"${HTTP_SETTINGS}\"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete the entire resource group\naz group delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --yes \\\n  --no-wait\n\n# Step 2: Wait for deletion to complete\necho \"Waiting for resource group deletion...\"\nsleep 180\n\n# Step 3: Verify deletion\naz group exists --name \"${RESOURCE_GROUP}\"\n\n# Step 4: Confirm cleanup\necho \"Verifying cleanup...\"\naz resource list --resource-group \"${RESOURCE_GROUP}\" 2>&1 | grep \"could not be found\" && echo \"\u2713 Resource group successfully deleted\"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-appgw-${UNIQUE_ID}-rg`\n- Application Gateway: `azurehaymaker-appgw-${UNIQUE_ID}`\n- Application Gateway Public IP: `azurehaymaker-appgw-pip-${UNIQUE_ID}`\n- WAF Policy: `azurehaymaker-waf-policy-${UNIQUE_ID}`\n- Backend Pool: `azurehaymaker-backend-pool-${UNIQUE_ID}`\n- Health Probe: `azurehaymaker-health-probe-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Application Gateway Overview](https://learn.microsoft.com/en-us/azure/application-gateway/overview)\n- [Web Application Firewall (WAF)](https://learn.microsoft.com/en-us/azure/web-application-firewall/ag/ag-overview)\n- [Create Application Gateway with CLI](https://learn.microsoft.com/en-us/azure/application-gateway/quick-create-cli)\n- [Path-Based Routing](https://learn.microsoft.com/en-us/azure/application-gateway/url-route-overview)\n- [Application Gateway CLI Reference](https://learn.microsoft.com/en-us/cli/azure/network/application-gateway)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive application gateway management with commands for WAF policy configuration, routing rules, and backend pool management. Direct CLI commands enable fine-grained control over security and routing policies.\n\n---\n\n## Estimated Duration\n- **Deployment**: 20-25 minutes (includes gateway and VM provisioning)\n- **Operations Phase**: 8+ hours (with monitoring, policy updates, and traffic analysis)\n- **Cleanup**: 15-20 minutes\n\n---\n\n## Notes\n- Application Gateway uses WAF v2 SKU for advanced threat protection\n- Web Application Firewall provides OWASP ModSecurity rules (version 3.1)\n- Health probe monitors backend instances; unhealthy instances are removed from rotation\n- Path-based routing enables different backend pools based on URL paths\n- Cookie-based affinity maintains client sessions within backend instances\n- All operations scoped to single tenant and subscription\n- Gateway requires dedicated subnet (GatewaySubnet)\n- Standard SKU public IP required for high availability\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal 'Scenario: Application Gateway with Web Application...' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion",
    "working_dir": ".",
    "sdk": "claude",
    "ui_mode": false,
    "success_criteria": [
      "Goal 'Scenario: Application Gateway with Web Application...' is achieved"
    ],
    "constraints": []
  }
}
