#!/usr/bin/env python3
"""
testing-scenario:-azure-api-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Azure API Management Gateway\n\n## Objective\n# Scenario: Azure API Management Gateway\n\n## Technology Area\nWeb Apps\n\n## Company Profile\n- **Company Size**: Large enterprise\n- **Industry**: Technology / SaaS\n- **Use Case**: Centralize API management, security, and analytics across microservices\n\n## Scenario Description\nDeploy Azure API Management to manage, protect, and monitor APIs. Configure API policies, implement rate limiting, set up developer portal, and integrate with backend services.\n\n## Azure Services Used\n- Azure API Management\n- Azure Virtual Network (network integration)\n- Azure Key Vault (secrets)\n- Azure Application Insights (analytics)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-webapp-apim-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nAPIM_SERVICE="azurehaymaker-apim-${UNIQUE_ID}"\nAPIM_ADMIN_EMAIL="admin@example.com"\nVNET_NAME="azurehaymaker-vnet-${UNIQUE_ID}"\nKEYVAULT="azurehaymaker-kv-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=webapps-api-management Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network\naz network vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VNET_NAME}" \\\n  --address-prefix "10.0.0.0/16" \\\n  --subnet-name "apim-subnet" \\\n  --subnet-prefixes "10.0.0.0/24" \\\n  --tags ${TAGS}\n\nSUBNET_ID=$(az network vnet subnet show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --name "apim-subnet" \\\n  --query id -o tsv)\n\n# Step 3: Create Key Vault\naz keyvault create \\\n  --name "${KEYVAULT}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 4: Store backend URLs in Key Vault\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "backend-url-products" \\\n  --value "https://api.example.com/products"\n\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "backend-url-orders" \\\n  --value "https://api.example.com/orders"\n\n# Step 5: Create API Management service\naz apim create \\\n  --name "${APIM_SERVICE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --publisher-name "Azure HayMaker" \\\n  --publisher-email "${APIM_ADMIN_EMAIL}" \\\n  --sku-name Developer \\\n  --enable-client-certificate false \\\n  --enable-managed-identity true \\\n  --tags ${TAGS}\n\n# Step 6: Create API in APIM\naz apim api create \\\n  --api-id "products-api" \\\n  --api-type "http" \\\n  --display-name "Products API" \\\n  --path "products" \\\n  --protocols "https" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --service-url "https://api.example.com/products"\n\n# Step 7: Add API operations\naz apim api operation create \\\n  --api-id "products-api" \\\n  --operation-id "get-all-products" \\\n  --display-name "Get All Products" \\\n  --method "GET" \\\n  --url-template "/" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}"\n\naz apim api operation create \\\n  --api-id "products-api" \\\n  --operation-id "get-product" \\\n  --display-name "Get Product by ID" \\\n  --method "GET" \\\n  --url-template "/{id}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}"\n\naz apim api operation create \\\n  --api-id "products-api" \\\n  --operation-id "create-product" \\\n  --display-name "Create Product" \\\n  --method "POST" \\\n  --url-template "/" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}"\n\n# Step 8: Create subscription (access key)\naz apim subscription create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --subscription-id "subscription-1" \\\n  --display-name "Developer Subscription"\n\n# Step 9: Create product\naz apim product create \\\n  --product-id "basic-product" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --display-name "Basic Product" \\\n  --description "Basic API product with rate limiting" \\\n  --subscription-required true \\\n  --approval-required false \\\n  --state "published"\n\n# Step 10: Add API to product\naz apim product api add \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --product-id "basic-product" \\\n  --api-id "products-api"\n\necho ""\necho "=========================================="\necho "API Management Created: ${APIM_SERVICE}"\necho "Gateway URL: https://${APIM_SERVICE}.azure-api.net"\necho "Developer Portal: https://${APIM_SERVICE}.developer.azure-api.net"\necho "=========================================="\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify APIM service\naz apim show \\\n  --name "${APIM_SERVICE}" \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# Check APIM status\naz apim show \\\n  --name "${APIM_SERVICE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "provisioningState" -o tsv\n\n# Get gateway URL\nAPIM_GATEWAY_URL=$(az apim show \\\n  --name "${APIM_SERVICE}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "gatewayUrl" -o tsv)\n\necho "Gateway URL: ${APIM_GATEWAY_URL}"\n\n# List APIs\naz apim api list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --output table\n\n# List API operations\naz apim api operation list \\\n  --api-id "products-api" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --output table\n\n# List products\naz apim product list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --output table\n\n# List subscriptions\naz apim subscription list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --output table\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Add rate limiting policy\ncat > /tmp/rate-limit-policy.xml <<EOF\n<policies>\n  <inbound>\n    <rate-limit calls="10" renewal-period="60" />\n  </inbound>\n</policies>\nEOF\n\naz apim api operation policy create-or-update \\\n  --api-id "products-api" \\\n  --operation-id "get-all-products" \\\n  --policy-id "policy" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --value @/tmp/rate-limit-policy.xml\n\n# Operation 2: Create another API\naz apim api create \\\n  --api-id "orders-api" \\\n  --api-type "http" \\\n  --display-name "Orders API" \\\n  --path "orders" \\\n  --protocols "https" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --service-url "https://api.example.com/orders"\n\n# Operation 3: Add operations to Orders API\naz apim api operation create \\\n  --api-id "orders-api" \\\n  --operation-id "get-orders" \\\n  --display-name "Get Orders" \\\n  --method "GET" \\\n  --url-template "/" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}"\n\n# Operation 4: Monitor API calls\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.ApiManagement/service/${APIM_SERVICE}" \\\n  --metric "Requests" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 5: Check API analytics\necho "API Analytics available in Azure Portal"\n\n# Operation 6: Enable logging\naz apim logger create \\\n  --logger-id "app-insights-logger" \\\n  --name "AppInsights" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --logger-type "applicationInsights" \\\n  --is-buffered false\n\n# Operation 7: Create diagnostic setting\naz apim diagnostic create-or-update \\\n  --diagnostic-id "applicationinsights" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --logger-id "app-insights-logger" \\\n  --always-log-errors true\n\n# Operation 8: Test API operation\necho "Testing API endpoint:"\necho "curl -i -X GET \\"${APIM_GATEWAY_URL}/products\\" -H \\"Ocp-Apim-Subscription-Key: <subscription-key>\\""\n\n# Operation 9: Create API version\naz apim api create \\\n  --api-id "products-api-v2" \\\n  --api-type "http" \\\n  --display-name "Products API v2" \\\n  --path "products" \\\n  --protocols "https" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --service-url "https://api.example.com/v2/products" \\\n  --api-version "v2"\n\n# Operation 10: List all backends\naz apim backend list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete products\naz apim product delete \\\n  --product-id "basic-product" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --yes\n\n# Step 2: Delete APIs\naz apim api delete \\\n  --api-id "products-api" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --yes\n\naz apim api delete \\\n  --api-id "orders-api" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --yes 2>/dev/null || true\n\naz apim api delete \\\n  --api-id "products-api-v2" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --service-name "${APIM_SERVICE}" \\\n  --yes 2>/dev/null || true\n\n# Step 3: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 4: Verify deletion\nsleep 120\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 5: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n\n# Step 6: Clean up local files\nrm -rf /tmp/rate-limit-policy.xml\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-webapp-apim-${UNIQUE_ID}-rg`\n- API Management: `azurehaymaker-apim-${UNIQUE_ID}`\n- Virtual Network: `azurehaymaker-vnet-${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure API Management Overview](https://learn.microsoft.com/en-us/azure/api-management/api-management-overview)\n- [API Management Policies](https://learn.microsoft.com/en-us/azure/api-management/api-management-policies)\n- [API Management Security](https://learn.microsoft.com/en-us/azure/api-management/api-management-security-controls)\n- [Developer Portal](https://learn.microsoft.com/en-us/azure/api-management/api-management-customize-styles)\n- [APIM CLI Reference](https://learn.microsoft.com/en-us/cli/azure/apim)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI handles API Management operations effectively. Policy files are XML-based and can be managed separately.\n\n---\n\n## Estimated Duration\n- **Deployment**: 20-30 minutes (APIM provisioning takes time)\n- **Operations Phase**: 8 hours (with API management and monitoring)\n- **Cleanup**: 10-15 minutes\n\n---\n\n## Notes\n- Developer SKU is suitable for development and testing\n- Rate limiting protects backends from overload\n- API versioning enables backward compatibility\n- Policies enable traffic management and security\n- All operations scoped to single tenant and subscription\n- Analytics provide insights into API usage\n- Built-in developer portal for API documentation\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Azure API Management Gateway...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": ["Goal 'Scenario: Azure API Management Gateway...' is achieved"],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-azure-api-agent...")
    print("Goal: Scenario: Azure API Management Gateway")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
