{
  "bundle_id": "1332bb97-abad-468d-bdf1-781c38321307",
  "name": "automation-scenario:-azure-sql-agent",
  "version": "1.0.0",
  "metadata": {
    "domain": "automation",
    "complexity": "complex",
    "phase_count": 4,
    "skill_count": 1,
    "estimated_duration": "2 hours 36 minutes",
    "required_capabilities": [
      "workflow-design",
      "quality-check",
      "validation",
      "initialization",
      "orchestration",
      "configuration",
      "task-execution",
      "monitoring"
    ],
    "skill_names": [
      "monitor"
    ],
    "parallel_opportunities": 0,
    "risk_factors": [
      "High complexity may require extended execution time",
      "Automated changes may have unintended side effects"
    ]
  },
  "auto_mode_config": {
    "max_turns": 18,
    "initial_prompt": "# Goal: Scenario: Azure SQL Managed Instance\n\n## Objective\n# Scenario: Azure SQL Managed Instance\n\n## Technology Area\nDatabases\n\n## Company Profile\n- **Company Size**: Large enterprise\n- **Industry**: Financial Services\n- **Use Case**: Lift-and-shift SQL Server databases with minimal changes\n\n## Scenario Description\nDeploy Azure SQL Managed Instance for SQL Server workload migration. Configure high availability, implement database backups, set up user-defined routes, and demonstrate failover capabilities.\n\n## Azure Services Used\n- Azure SQL Managed Instance\n- Azure Virtual Network (network integration)\n- Azure Key Vault (credentials storage)\n- Azure Storage (backups)\n- Azure Monitor (monitoring)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP=\"azurehaymaker-db-sqlmi-${UNIQUE_ID}-rg\"\nLOCATION=\"eastus\"\nSQL_MI=\"azurehaymaker-sqlmi-${UNIQUE_ID}\"\nVNET_NAME=\"azurehaymaker-vnet-${UNIQUE_ID}\"\nNSG_NAME=\"azurehaymaker-nsg-${UNIQUE_ID}\"\nKEYVAULT=\"azurehaymaker-kv-${UNIQUE_ID}\"\nSTORAGE_ACCOUNT=\"azmkrsqlmi${UNIQUE_ID}\"\nSQL_ADMIN_USER=\"sqladmin\"\nSQL_ADMIN_PASSWORD=\"P@ssw0rd!${UNIQUE_ID}\"\n\n# Tags\nTAGS=\"AzureHayMaker-managed=true Scenario=databases-sql-managed-instance Owner=AzureHayMaker\"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name \"${RESOURCE_GROUP}\" \\\n  --location \"${LOCATION}\" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network\naz network vnet create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VNET_NAME}\" \\\n  --address-prefix \"10.0.0.0/16\" \\\n  --subnet-name \"mi-subnet\" \\\n  --subnet-prefixes \"10.0.0.0/24\" \\\n  --tags ${TAGS}\n\n# Step 3: Create Network Security Group\naz network nsg create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${NSG_NAME}\" \\\n  --tags ${TAGS}\n\n# Step 4: Add NSG rules for SQL MI\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_NAME}\" \\\n  --name \"AllowManagementSubnetInbound\" \\\n  --priority 100 \\\n  --direction Inbound \\\n  --access Allow \\\n  --protocol \"*\" \\\n  --source-address-prefixes \"*\" \\\n  --destination-address-prefixes \"10.0.0.0/24\" \\\n  --source-port-ranges \"*\" \\\n  --destination-port-ranges \"*\"\n\naz network nsg rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_NAME}\" \\\n  --name \"AllowRedirectRuleInbound\" \\\n  --priority 101 \\\n  --direction Inbound \\\n  --access Allow \\\n  --protocol \"Tcp\" \\\n  --source-address-prefixes \"*\" \\\n  --destination-address-prefixes \"10.0.0.0/24\" \\\n  --source-port-ranges \"*\" \\\n  --destination-port-ranges \"11000-11999\"\n\n# Step 5: Associate NSG with subnet\naz network vnet subnet update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"mi-subnet\" \\\n  --network-security-group \"${NSG_NAME}\"\n\nSUBNET_ID=$(az network vnet subnet show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"mi-subnet\" \\\n  --query id -o tsv)\n\n# Step 6: Create Storage Account for backups\naz storage account create \\\n  --name \"${STORAGE_ACCOUNT}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --location \"${LOCATION}\" \\\n  --sku Standard_LRS \\\n  --kind StorageV2 \\\n  --tags ${TAGS}\n\n# Step 7: Create Key Vault\naz keyvault create \\\n  --name \"${KEYVAULT}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --location \"${LOCATION}\" \\\n  --tags ${TAGS}\n\n# Store credentials in Key Vault\naz keyvault secret set \\\n  --vault-name \"${KEYVAULT}\" \\\n  --name \"sqlmi-admin-user\" \\\n  --value \"${SQL_ADMIN_USER}\"\n\naz keyvault secret set \\\n  --vault-name \"${KEYVAULT}\" \\\n  --name \"sqlmi-admin-password\" \\\n  --value \"${SQL_ADMIN_PASSWORD}\"\n\n# Step 8: Create SQL Managed Instance\naz sql mi create \\\n  --name \"${SQL_MI}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --admin-user \"${SQL_ADMIN_USER}\" \\\n  --admin-password \"${SQL_ADMIN_PASSWORD}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --subnet \"mi-subnet\" \\\n  --location \"${LOCATION}\" \\\n  --sku-name \"GP_Gen5\" \\\n  --v-core-count 4 \\\n  --storage-size-gb 128 \\\n  --collation \"SQL_Latin1_General_CP1_CI_AS\" \\\n  --license-type LicenseIncluded \\\n  --backup-redundancy \"Local\" \\\n  --public-data-endpoint-enabled true \\\n  --enable-auto-failover false \\\n  --tags ${TAGS}\n\n# Step 9: Create managed instance database\naz sql midb create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --mi-name \"${SQL_MI}\" \\\n  --name \"productiondb\" \\\n  --collation \"SQL_Latin1_General_CP1_CI_AS\"\n\naz sql midb create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --mi-name \"${SQL_MI}\" \\\n  --name \"stagingdb\" \\\n  --collation \"SQL_Latin1_General_CP1_CI_AS\"\n\n# Step 10: Configure backup retention\naz sql mi update \\\n  --name \"${SQL_MI}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --backup-retention \"7\" \\\n  --backup-storage-redundancy \"Local\"\n\necho \"\"\necho \"==========================================\"\necho \"SQL Managed Instance Created: ${SQL_MI}\"\necho \"Databases: productiondb, stagingdb\"\necho \"Location: ${LOCATION}\"\necho \"==========================================\"\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name \"${RESOURCE_GROUP}\"\n\n# Verify SQL Managed Instance\naz sql mi show \\\n  --name \"${SQL_MI}\" \\\n  --resource-group \"${RESOURCE_GROUP}\"\n\n# Check instance status\naz sql mi show \\\n  --name \"${SQL_MI}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --query \"state\" -o tsv\n\n# List databases\naz sql midb list \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --mi-name \"${SQL_MI}\" \\\n  --output table\n\n# Get instance properties\naz sql mi show \\\n  --name \"${SQL_MI}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --query \"{Name:name, VCores:vCores, StorageGB:storageSizeGB, PublicEndpoint:publicDataEndpointEnabled}\" -o table\n\n# List NSG rules\naz network nsg rule list \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --nsg-name \"${NSG_NAME}\" \\\n  --output table\n\n# Verify storage account\naz storage account show \\\n  --name \"${STORAGE_ACCOUNT}\" \\\n  --resource-group \"${RESOURCE_GROUP}\"\n\n# List all resources\naz resource list --resource-group \"${RESOURCE_GROUP}\" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Create database backup\naz sql midb backup-long-term-retention-policy set \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --mi-name \"${SQL_MI}\" \\\n  --database \"productiondb\" \\\n  --weekly-retention \"P4W\" \\\n  --monthly-retention \"P12M\" \\\n  --yearly-retention \"P5Y\"\n\n# Operation 2: Trigger manual backup\necho \"Manual backups are automatically managed by Azure for Managed Instance\"\n\n# Operation 3: Monitor instance metrics\naz monitor metrics list \\\n  --resource \"/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Sql/managedInstances/${SQL_MI}\" \\\n  --metric \"CPU%\" \\\n  --start-time $(date -u -d '1 hour ago' '+%Y-%m-%dT%H:%M:%SZ') \\\n  --end-time $(date -u '+%Y-%m-%dT%H:%M:%SZ')\n\n# Operation 4: Check storage usage\naz monitor metrics list \\\n  --resource \"/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Sql/managedInstances/${SQL_MI}\" \\\n  --metric \"StorageUsed\" \\\n  --start-time $(date -u -d '1 hour ago' '+%Y-%m-%dT%H:%M:%SZ') \\\n  --end-time $(date -u '+%Y-%m-%dT%H:%M:%SZ')\n\n# Operation 5: Scale instance (change vCores)\n# Note: This operation takes time\naz sql mi update \\\n  --name \"${SQL_MI}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --v-core-count 8\n\n# Operation 6: Restore database from backup\necho \"To restore a database from backup:\"\necho \"az sql midb restore --resource-group \\\"${RESOURCE_GROUP}\\\" --mi-name \\\"${SQL_MI}\\\" --name \\\"productiondb-restored\\\" --restore-point-in-time $(date -u '+%Y-%m-%dT%H:%M:%SZ')\"\n\n# Operation 7: Create additional database user (for testing)\necho \"User management requires SQL connection\"\n\n# Operation 8: Monitor failed logins\naz sql audit-policy show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${SQL_MI}\" \\\n  --managed-instance\n\n# Operation 9: Update maintenance window\naz sql mi update \\\n  --name \"${SQL_MI}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --maintenance-configuration-id \"/subscriptions/$(az account show --query id -o tsv)/providers/Microsoft.Maintenance/maintenanceConfigurations/SQL_Default\"\n\n# Operation 10: Check instance connectivity\necho \"Instance endpoint: ${SQL_MI}.public.${LOCATION}.database.windows.net\"\necho \"Connection string: Server=tcp:${SQL_MI}.public.${LOCATION}.database.windows.net,3342;Database=productiondb;User ID=${SQL_ADMIN_USER};Password=<password>;Encrypt=true;Connection Timeout=30;\"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete databases\naz sql midb delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --mi-name \"${SQL_MI}\" \\\n  --name \"productiondb\" \\\n  --yes\n\naz sql midb delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --mi-name \"${SQL_MI}\" \\\n  --name \"stagingdb\" \\\n  --yes\n\n# Step 2: Delete SQL Managed Instance\naz sql mi delete \\\n  --name \"${SQL_MI}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --yes \\\n  --no-wait\n\n# Step 3: Wait for instance deletion\nsleep 300\n\n# Step 4: Delete the entire resource group\naz group delete \\\n  --name \"${RESOURCE_GROUP}\" \\\n  --yes \\\n  --no-wait\n\n# Step 5: Verify deletion\nsleep 120\naz group exists --name \"${RESOURCE_GROUP}\"\n\n# Step 6: Confirm cleanup\necho \"Verifying cleanup...\"\naz resource list --resource-group \"${RESOURCE_GROUP}\" 2>&1 | grep \"could not be found\" && echo \"\u2713 Resource group successfully deleted\"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-db-sqlmi-${UNIQUE_ID}-rg`\n- SQL Managed Instance: `azurehaymaker-sqlmi-${UNIQUE_ID}`\n- Virtual Network: `azurehaymaker-vnet-${UNIQUE_ID}`\n- Network Security Group: `azurehaymaker-nsg-${UNIQUE_ID}`\n- Storage Account: `azmkrsqlmi${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [SQL Managed Instance Overview](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/sql-managed-instance-paas-overview)\n- [Managed Instance Features](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/features-comparison)\n- [Networking Configuration](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/connectivity-architecture-overview)\n- [Backup and Restore](https://learn.microsoft.com/en-us/azure/azure-sql/managed-instance/automated-backups-overview)\n- [SQL MI CLI Reference](https://learn.microsoft.com/en-us/cli/azure/sql/mi)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive Managed Instance management. T-SQL operations are typically handled separately via SQL Server Management Studio or sqlcmd.\n\n---\n\n## Estimated Duration\n- **Deployment**: 30-45 minutes (MI provisioning takes significant time)\n- **Operations Phase**: 8 hours (with scaling and monitoring)\n- **Cleanup**: 20-30 minutes (MI deletion is lengthy)\n\n---\n\n## Notes\n- Fully managed SQL Server instance with automatic updates and patching\n- Multiple database support with up to 100 instances per subscription\n- Automatic backups with point-in-time restore capability\n- Public endpoint for remote access (optional)\n- Private endpoint support for private networks\n- All operations scoped to single tenant and subscription\n- Suitable for lift-and-shift SQL Server migrations\n- Instance-level operations available with T-SQL\n\n\n## Execution Plan\n\n### Phase 1: Setup\nConfigure automation environment\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: configuration, initialization\n\n### Phase 2: Workflow Design\nDesign automation workflow\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: workflow-design, orchestration\n**Dependencies**: Setup\n\n### Phase 3: Execution\nExecute automated tasks\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: task-execution, monitoring\n**Dependencies**: Workflow Design\n\n### Phase 4: Validation\nValidate results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: validation, quality-check\n**Dependencies**: Execution\n\n## Success Criteria\n- Goal 'Scenario: Azure SQL Managed Instance...' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion",
    "working_dir": ".",
    "sdk": "claude",
    "ui_mode": false,
    "success_criteria": [
      "Goal 'Scenario: Azure SQL Managed Instance...' is achieved"
    ],
    "constraints": []
  }
}
