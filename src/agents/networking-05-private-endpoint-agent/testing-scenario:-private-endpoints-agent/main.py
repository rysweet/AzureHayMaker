#!/usr/bin/env python3
"""
testing-scenario:-private-endpoints-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 6,
        "initial_prompt": '# Goal: Scenario: Private Endpoints for Azure Services\n\n## Objective\n# Scenario: Private Endpoints for Azure Services\n\n## Technology Area\nNetworking\n\n## Company Profile\n- **Company Size**: Enterprise\n- **Industry**: Banking / Healthcare / Government\n- **Use Case**: Secure connectivity to Azure services with private IP addresses and eliminate exposure to public internet\n\n## Scenario Description\nDeploy Azure Private Endpoints to provide private IP addresses for Azure services (Storage Account, SQL Database, Azure Key Vault) within a virtual network. This scenario covers private endpoint provisioning, DNS zone configuration, network policies, and private link services.\n\n## Azure Services Used\n- Azure Private Endpoints\n- Azure Private Link\n- Azure Virtual Network\n- Azure Storage Account\n- Azure SQL Database\n- Azure Key Vault\n- Azure Private DNS Zones\n- Azure Network Interface\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed and configured\n- Understanding of private networking and DNS concepts\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-pe-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nVNET_NAME="azurehaymaker-vnet-${UNIQUE_ID}"\nPRIVATE_SUBNET="azurehaymaker-private-${UNIQUE_ID}"\nSTORAGE_ACCOUNT="azmkstorage${UNIQUE_ID}"\nKEYVAULT_NAME="azurehaymaker-kv${UNIQUE_ID}"\nSQL_SERVER="azurehaymaker-sql-${UNIQUE_ID}"\nSQL_DB="azurehaymaker-sqldb-${UNIQUE_ID}"\nSTORAGE_PE="azurehaymaker-storage-pe-${UNIQUE_ID}"\nKEYVAULT_PE="azurehaymaker-kv-pe-${UNIQUE_ID}"\nSQL_PE="azurehaymaker-sql-pe-${UNIQUE_ID}"\nPRIVATE_DNS_STORAGE="privatelink.blob.core.windows.net"\nPRIVATE_DNS_KV="privatelink.vaultcore.azure.net"\nPRIVATE_DNS_SQL="privatelink.database.windows.net"\nNSG_NAME="azurehaymaker-pe-nsg-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=networking-private-endpoint Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network\naz network vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VNET_NAME}" \\\n  --address-prefix 10.0.0.0/16 \\\n  --tags ${TAGS}\n\n# Step 3: Create Private Subnet\naz network vnet subnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --name "${PRIVATE_SUBNET}" \\\n  --address-prefix 10.0.1.0/24\n\n# Step 4: Disable private endpoint network policies (required)\naz network vnet subnet update \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --name "${PRIVATE_SUBNET}" \\\n  --disable-private-endpoint-network-policies true\n\n# Step 5: Create Storage Account\naz storage account create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --location "${LOCATION}" \\\n  --sku Standard_LRS \\\n  --kind StorageV2 \\\n  --tags ${TAGS}\n\n# Step 6: Restrict Storage Account access to private endpoint only\nSTORAGE_ID=$(az storage account show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --query id -o tsv)\n\naz storage account update \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --default-action Deny\n\n# Step 7: Create Private Endpoint for Storage Account\naz network private-endpoint create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_PE}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --subnet "${PRIVATE_SUBNET}" \\\n  --private-connection-resource-id "${STORAGE_ID}" \\\n  --group-ids blob \\\n  --connection-name "azurehaymaker-storage-connection-${UNIQUE_ID}" \\\n  --tags ${TAGS}\n\n# Step 8: Create Private DNS Zone for Storage\naz network private-dns zone create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PRIVATE_DNS_STORAGE}" \\\n  --tags ${TAGS}\n\n# Step 9: Link Private DNS Zone to VNet for Storage\naz network private-dns link vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_STORAGE}" \\\n  --name "azurehaymaker-storage-link-${UNIQUE_ID}" \\\n  --virtual-network "${VNET_NAME}" \\\n  --registration-enabled false\n\n# Step 10: Create DNS A record for Storage\nSTORAGE_PE_IP=$(az network private-endpoint show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_PE}" \\\n  --query "customDnsConfigs[0].ipAddresses[0]" -o tsv)\n\naz network private-dns record-set a create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_STORAGE}" \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --ttl 300\n\naz network private-dns record-set a add-record \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_STORAGE}" \\\n  --record-set-name "${STORAGE_ACCOUNT}" \\\n  --ipv4-address "${STORAGE_PE_IP}"\n\n# Step 11: Create Key Vault\naz keyvault create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEYVAULT_NAME}" \\\n  --location "${LOCATION}" \\\n  --sku standard \\\n  --tags ${TAGS}\n\n# Step 12: Get Key Vault resource ID\nKEYVAULT_ID=$(az keyvault show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEYVAULT_NAME}" \\\n  --query id -o tsv)\n\n# Step 13: Create Private Endpoint for Key Vault\naz network private-endpoint create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEYVAULT_PE}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --subnet "${PRIVATE_SUBNET}" \\\n  --private-connection-resource-id "${KEYVAULT_ID}" \\\n  --group-ids vault \\\n  --connection-name "azurehaymaker-kv-connection-${UNIQUE_ID}" \\\n  --tags ${TAGS}\n\n# Step 14: Create Private DNS Zone for Key Vault\naz network private-dns zone create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PRIVATE_DNS_KV}" \\\n  --tags ${TAGS}\n\n# Step 15: Link Private DNS Zone to VNet for Key Vault\naz network private-dns link vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_KV}" \\\n  --name "azurehaymaker-kv-link-${UNIQUE_ID}" \\\n  --virtual-network "${VNET_NAME}" \\\n  --registration-enabled false\n\n# Step 16: Create DNS A record for Key Vault\nKEYVAULT_PE_IP=$(az network private-endpoint show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEYVAULT_PE}" \\\n  --query "customDnsConfigs[0].ipAddresses[0]" -o tsv)\n\naz network private-dns record-set a create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_KV}" \\\n  --name "${KEYVAULT_NAME}" \\\n  --ttl 300\n\naz network private-dns record-set a add-record \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_KV}" \\\n  --record-set-name "${KEYVAULT_NAME}" \\\n  --ipv4-address "${KEYVAULT_PE_IP}"\n\n# Step 17: Create Azure SQL Server\naz sql server create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${SQL_SERVER}" \\\n  --location "${LOCATION}" \\\n  --admin-user azureuser \\\n  --admin-password "P@ssw0rd1234567!" \\\n  --tags ${TAGS}\n\n# Step 18: Create Azure SQL Database\naz sql db create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --server "${SQL_SERVER}" \\\n  --name "${SQL_DB}" \\\n  --service-objective Basic \\\n  --tags ${TAGS}\n\n# Step 19: Get SQL Server resource ID\nSQL_SERVER_ID=$(az sql server show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${SQL_SERVER}" \\\n  --query id -o tsv)\n\n# Step 20: Create Private Endpoint for SQL Database\naz network private-endpoint create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${SQL_PE}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --subnet "${PRIVATE_SUBNET}" \\\n  --private-connection-resource-id "${SQL_SERVER_ID}" \\\n  --group-ids sqlServer \\\n  --connection-name "azurehaymaker-sql-connection-${UNIQUE_ID}" \\\n  --tags ${TAGS}\n\n# Step 21: Create Private DNS Zone for SQL\naz network private-dns zone create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PRIVATE_DNS_SQL}" \\\n  --tags ${TAGS}\n\n# Step 22: Link Private DNS Zone to VNet for SQL\naz network private-dns link vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_SQL}" \\\n  --name "azurehaymaker-sql-link-${UNIQUE_ID}" \\\n  --virtual-network "${VNET_NAME}" \\\n  --registration-enabled false\n\n# Step 23: Create DNS A record for SQL\nSQL_PE_IP=$(az network private-endpoint show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${SQL_PE}" \\\n  --query "customDnsConfigs[0].ipAddresses[0]" -o tsv)\n\naz network private-dns record-set a create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_SQL}" \\\n  --name "${SQL_SERVER}" \\\n  --ttl 300\n\naz network private-dns record-set a add-record \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_SQL}" \\\n  --record-set-name "${SQL_SERVER}" \\\n  --ipv4-address "${SQL_PE_IP}"\n```\n\n### Validation\n```bash\n# Verify Virtual Network and Subnet\naz network vnet show --resource-group "${RESOURCE_GROUP}" --name "${VNET_NAME}"\n\n# Verify Storage Account\naz storage account show --resource-group "${RESOURCE_GROUP}" --name "${STORAGE_ACCOUNT}" --query "{name: name, accessTier: accessTier, minimumTlsVersion: minimumTlsVersion}"\n\n# Verify Storage Private Endpoint\naz network private-endpoint show --resource-group "${RESOURCE_GROUP}" --name "${STORAGE_PE}"\n\n# Verify Key Vault\naz keyvault show --resource-group "${RESOURCE_GROUP}" --name "${KEYVAULT_NAME}"\n\n# Verify Key Vault Private Endpoint\naz network private-endpoint show --resource-group "${RESOURCE_GROUP}" --name "${KEYVAULT_PE}"\n\n# Verify SQL Server and Database\naz sql server show --resource-group "${RESOURCE_GROUP}" --name "${SQL_SERVER}"\n\n# Verify SQL Private Endpoint\naz network private-endpoint show --resource-group "${RESOURCE_GROUP}" --name "${SQL_PE}"\n\n# List all Private Endpoints\naz network private-endpoint list --resource-group "${RESOURCE_GROUP}" --output table\n\n# Verify Private DNS Zones\naz network private-dns zone list --resource-group "${RESOURCE_GROUP}" --output table\n\n# Verify DNS records\naz network private-dns record-set a list --resource-group "${RESOURCE_GROUP}" --zone-name "${PRIVATE_DNS_STORAGE}"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Get Storage Account network rules\naz storage account show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --query "networkRuleSet"\n\n# Operation 2: Allow specific VNet access to Storage Account\naz storage account network-rule add \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --subnet-name "${PRIVATE_SUBNET}"\n\n# Operation 3: Get Key Vault access policies\naz keyvault show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEYVAULT_NAME}" \\\n  --query "properties.accessPolicies"\n\n# Operation 4: Create storage account blob container\naz storage container create \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --name "azurehaymaker-container-${UNIQUE_ID}" \\\n  --auth-mode login\n\n# Operation 5: Upload test file to storage\necho "Test data for private endpoint" > /tmp/test-file.txt\naz storage blob upload \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --container-name "azurehaymaker-container-${UNIQUE_ID}" \\\n  --name "test-file.txt" \\\n  --file "/tmp/test-file.txt" \\\n  --auth-mode login\n\n# Operation 6: Store secret in Key Vault\naz keyvault secret set \\\n  --vault-name "${KEYVAULT_NAME}" \\\n  --name "azurehaymaker-secret" \\\n  --value "MySecureSecretValue123!"\n\n# Operation 7: List all private endpoint connections for Storage\naz network private-endpoint-connection list \\\n  --id "${STORAGE_ID}" \\\n  --output table\n\n# Operation 8: List all private endpoint connections for Key Vault\naz network private-endpoint-connection list \\\n  --id "${KEYVAULT_ID}" \\\n  --output table\n\n# Operation 9: Get SQL Server firewall rules\naz sql server firewall-rule list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --server "${SQL_SERVER}" \\\n  --output table\n\n# Operation 10: Monitor private endpoint connection status\naz network private-endpoint show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_PE}" \\\n  --query "{name: name, provisioningState: provisioningState, connectionState: privateLinkServiceConnections[0].privateLinkServiceConnectionState.status}"\n\n# Operation 11: Create additional private DNS record for redundancy\naz network private-dns record-set a add-record \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_STORAGE}" \\\n  --record-set-name "${STORAGE_ACCOUNT}-backup" \\\n  --ipv4-address "${STORAGE_PE_IP}"\n\n# Operation 12: List virtual network links for DNS zones\naz network private-dns link vnet list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --zone-name "${PRIVATE_DNS_STORAGE}" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete all private endpoint connections\naz network private-endpoint delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_PE}" \\\n  --yes\n\naz network private-endpoint delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEYVAULT_PE}" \\\n  --yes\n\naz network private-endpoint delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${SQL_PE}" \\\n  --yes\n\n# Step 2: Delete Private DNS Zones\naz network private-dns zone delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PRIVATE_DNS_STORAGE}" \\\n  --yes\n\naz network private-dns zone delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PRIVATE_DNS_KV}" \\\n  --yes\n\naz network private-dns zone delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PRIVATE_DNS_SQL}" \\\n  --yes\n\n# Step 3: Delete the entire resource group (includes all remaining resources)\naz group delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 4: Wait for deletion to complete\necho "Waiting for resource group deletion..."\nsleep 120\n\n# Step 5: Verify deletion\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 6: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-pe-${UNIQUE_ID}-rg`\n- Virtual Network: `azurehaymaker-vnet-${UNIQUE_ID}`\n- Private Subnet: `azurehaymaker-private-${UNIQUE_ID}`\n- Storage Account: `azmkstorage${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv${UNIQUE_ID}`\n- SQL Server: `azurehaymaker-sql-${UNIQUE_ID}`\n- SQL Database: `azurehaymaker-sqldb-${UNIQUE_ID}`\n- Storage Private Endpoint: `azurehaymaker-storage-pe-${UNIQUE_ID}`\n- Key Vault Private Endpoint: `azurehaymaker-kv-pe-${UNIQUE_ID}`\n- SQL Private Endpoint: `azurehaymaker-sql-pe-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Private Endpoints Overview](https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview)\n- [Azure Private Link Service](https://learn.microsoft.com/en-us/azure/private-link/private-link-service-overview)\n- [Private DNS Zones](https://learn.microsoft.com/en-us/azure/dns/private-dns-overview)\n- [Create Private Endpoint with CLI](https://learn.microsoft.com/en-us/azure/private-link/create-private-endpoint-cli)\n- [Private Endpoint Connection States](https://learn.microsoft.com/en-us/azure/private-link/private-endpoint-overview)\n- [Azure Storage Private Endpoints](https://learn.microsoft.com/en-us/azure/storage/common/storage-private-endpoints)\n- [Azure SQL Database Private Endpoints](https://learn.microsoft.com/en-us/azure/azure-sql/database/private-endpoint-overview)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive private link management with straightforward commands for creating private endpoints, configuring DNS zones, and managing private connectivity. Direct CLI commands enable fine-grained control over service access policies.\n\n---\n\n## Estimated Duration\n- **Deployment**: 20-25 minutes (includes service provisioning and endpoint creation)\n- **Operations Phase**: 8+ hours (with monitoring, access policy updates, and network verification)\n- **Cleanup**: 10-15 minutes\n\n---\n\n## Notes\n- Private Endpoints require dedicated subnet with network policies disabled\n- Storage Account access restricted to private endpoint (default deny)\n- Private DNS Zones automatically resolve service hostnames to private IP addresses\n- SQL Server requires firewall rule adjustment when using private endpoints\n- Key Vault access remains restricted to explicitly allowed principals\n- Private Endpoints eliminate exposure to public internet for Azure services\n- DNS resolution works transparently within VNet without client configuration changes\n- All operations scoped to single tenant and subscription\n- Private endpoint connections must be approved (auto-approved in this scenario)\n- Custom DNS configurations ensure seamless service discovery over private network\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Private Endpoints for Azure Services...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Private Endpoints for Azure Services...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-private-endpoints-agent...")
    print("Goal: Scenario: Private Endpoints for Azure Services")
    print("Estimated duration: 22 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
