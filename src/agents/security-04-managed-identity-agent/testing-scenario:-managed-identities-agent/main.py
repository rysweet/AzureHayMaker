#!/usr/bin/env python3
"""
testing-scenario:-managed-identities-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Managed Identities for Azure Resources\n\n## Objective\n# Scenario: Managed Identities for Azure Resources\n\n## Technology Area\nSecurity\n\n## Company Profile\n- **Company Size**: Small to mid-size enterprise\n- **Industry**: Cloud-Native Applications / Microservices\n- **Use Case**: Enable secure, credential-free access to Azure resources using managed identities\n\n## Scenario Description\nImplement managed identities for Azure resources to enable authentication without storing credentials. This scenario covers system-assigned and user-assigned identities, role assignments, and secure service-to-service communication patterns.\n\n## Azure Services Used\n- Azure Managed Identity (System-assigned and User-assigned)\n- Azure Virtual Machines\n- Azure App Service\n- Azure Key Vault\n- Azure Storage Account\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed and configured\n- Understanding of service principals and managed identities\n- Access to create VMs, App Services, and manage roles\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-security-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nVM_NAME="azurehaymaker-vm-${UNIQUE_ID}"\nAPP_SERVICE_PLAN="azurehaymaker-asp-${UNIQUE_ID}"\nWEB_APP_NAME="azurehaymaker-app-${UNIQUE_ID}"\nUSER_MANAGED_ID="azurehaymaker-identity-${UNIQUE_ID}"\nKEY_VAULT_NAME="azurehaymaker-kv-${UNIQUE_ID}"\nSTORAGE_ACCOUNT="azurehaymaker${UNIQUE_ID}"\nSUBSCRIPTION_ID=$(az account show --query id -o tsv)\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=security-managed-identity Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create User-assigned Managed Identity\nUSER_IDENTITY_ID=$(az identity create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${USER_MANAGED_ID}" \\\n  --query id -o tsv)\n\nUSER_IDENTITY_PRINCIPAL=$(az identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${USER_MANAGED_ID}" \\\n  --query principalId -o tsv)\n\n# Step 3: Create Key Vault for identity access testing\naz keyvault create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEY_VAULT_NAME}" \\\n  --location "${LOCATION}" \\\n  --enable-rbac-authorization \\\n  --tags ${TAGS}\n\n# Step 4: Create Storage Account for identity access testing\naz storage account create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --location "${LOCATION}" \\\n  --sku Standard_LRS \\\n  --tags ${TAGS}\n\n# Step 5: Create storage container\naz storage container create \\\n  --account-name "${STORAGE_ACCOUNT}" \\\n  --name "managed-identity-test"\n\n# Step 6: Create App Service Plan\naz appservice plan create \\\n  --name "${APP_SERVICE_PLAN}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --sku B1 \\\n  --is-linux \\\n  --tags ${TAGS}\n\n# Step 7: Create Web App with system-assigned identity\naz webapp create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --plan "${APP_SERVICE_PLAN}" \\\n  --name "${WEB_APP_NAME}" \\\n  --runtime "PYTHON|3.9" \\\n  --tags ${TAGS}\n\n# Step 8: Enable system-assigned identity on Web App\naz webapp identity assign \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --identities [system]\n\n# Step 9: Assign user-assigned identity to Web App\naz webapp identity assign \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --identities "${USER_IDENTITY_ID}"\n\n# Step 10: Get system-assigned identity principal ID\nSYSTEM_IDENTITY_PRINCIPAL=$(az webapp identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --query principalId -o tsv)\n\n# Step 11: Create SSH key for VM\naz sshkey create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "azurehaymaker-key-${UNIQUE_ID}" \\\n  --tags ${TAGS}\n\n# Step 12: Create Virtual Machine with system-assigned identity\naz vm create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --image UbuntuLTS \\\n  --size Standard_B1s \\\n  --admin-username azureuser \\\n  --ssh-key-name "azurehaymaker-key-${UNIQUE_ID}" \\\n  --assign-identity \\\n  --tags ${TAGS}\n\necho "User Identity ID: ${USER_IDENTITY_ID}"\necho "User Identity Principal: ${USER_IDENTITY_PRINCIPAL}"\necho "System Identity Principal (App): ${SYSTEM_IDENTITY_PRINCIPAL}"\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify user-assigned identity\naz identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${USER_MANAGED_ID}"\n\n# Get identity details\naz identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${USER_MANAGED_ID}" \\\n  --query "{principalId: principalId, clientId: clientId, tenantId: tenantId}"\n\n# Verify Web App identities\naz webapp identity show --resource-group "${RESOURCE_GROUP}" --name "${WEB_APP_NAME}"\n\n# Verify VM identity\naz vm identity show --resource-group "${RESOURCE_GROUP}" --name "${VM_NAME}"\n\n# List all identities in resource group\naz identity list --resource-group "${RESOURCE_GROUP}" --output table\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Assign Key Vault Secrets User role to system identity (Web App)\naz role assignment create \\\n  --role "Key Vault Secrets User" \\\n  --assignee-object-id "${SYSTEM_IDENTITY_PRINCIPAL}" \\\n  --assignee-principal-type ServicePrincipal \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.KeyVault/vaults/${KEY_VAULT_NAME}"\n\n# Operation 2: Assign Key Vault Secrets User role to user-assigned identity\naz role assignment create \\\n  --role "Key Vault Secrets User" \\\n  --assignee-object-id "${USER_IDENTITY_PRINCIPAL}" \\\n  --assignee-principal-type ServicePrincipal \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.KeyVault/vaults/${KEY_VAULT_NAME}"\n\n# Operation 3: Assign Storage Blob Data Contributor role to system identity\nSTORAGE_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Storage/storageAccounts/${STORAGE_ACCOUNT}"\naz role assignment create \\\n  --role "Storage Blob Data Contributor" \\\n  --assignee-object-id "${SYSTEM_IDENTITY_PRINCIPAL}" \\\n  --assignee-principal-type ServicePrincipal \\\n  --scope "${STORAGE_ID}"\n\n# Operation 4: Assign Storage Blob Data Reader role to user-assigned identity\naz role assignment create \\\n  --role "Storage Blob Data Reader" \\\n  --assignee-object-id "${USER_IDENTITY_PRINCIPAL}" \\\n  --assignee-principal-type ServicePrincipal \\\n  --scope "${STORAGE_ID}"\n\n# Operation 5: Get VM system-assigned identity principal\nVM_IDENTITY_PRINCIPAL=$(az vm identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --query principalId -o tsv)\n\n# Operation 6: Assign Storage Account Contributor role to VM identity\naz role assignment create \\\n  --role "Storage Account Contributor" \\\n  --assignee-object-id "${VM_IDENTITY_PRINCIPAL}" \\\n  --assignee-principal-type ServicePrincipal \\\n  --scope "${STORAGE_ID}"\n\n# Operation 7: Add secret to Key Vault for testing\naz keyvault secret set \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "managed-identity-test-secret" \\\n  --value "Secret value for managed identity testing $(openssl rand -hex 8)"\n\n# Operation 8: List role assignments for system identity\naz role assignment list \\\n  --assignee-object-id "${SYSTEM_IDENTITY_PRINCIPAL}" \\\n  --output table\n\n# Operation 9: List role assignments for user-assigned identity\naz role assignment list \\\n  --assignee-object-id "${USER_IDENTITY_PRINCIPAL}" \\\n  --output table\n\n# Operation 10: Get access token using user-assigned identity\nWEB_APP_IDENTITY_CLIENT=$(az identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${USER_MANAGED_ID}" \\\n  --query clientId -o tsv)\n\necho "User-assigned Identity Client ID: ${WEB_APP_IDENTITY_CLIENT}"\n\n# Operation 11: Update VM to use user-assigned identity\naz vm identity assign \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --identities "${USER_IDENTITY_ID}"\n\n# Operation 12: Create additional user-assigned identity\nSECONDARY_IDENTITY_ID=$(az identity create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "azurehaymaker-secondary-${UNIQUE_ID}" \\\n  --query id -o tsv)\n\nSECONDARY_PRINCIPAL=$(az identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "azurehaymaker-secondary-${UNIQUE_ID}" \\\n  --query principalId -o tsv)\n\n# Operation 13: Assign secondary identity to Web App\naz webapp identity assign \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --identities "${SECONDARY_IDENTITY_ID}"\n\n# Operation 14: List all identities assigned to Web App\naz webapp identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --query userAssignedIdentities\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Remove all role assignments for identities\nfor PRINCIPAL in "${SYSTEM_IDENTITY_PRINCIPAL}" "${USER_IDENTITY_PRINCIPAL}" "${VM_IDENTITY_PRINCIPAL}" "${SECONDARY_PRINCIPAL}"; do\n  for ASSIGNMENT in $(az role assignment list --assignee-object-id "${PRINCIPAL}" --query "[].id" -o tsv); do\n    az role assignment delete --ids "${ASSIGNMENT}" || true\n  done\ndone\n\n# Step 2: Remove identities from resources\naz webapp identity remove \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --identities "${USER_IDENTITY_ID}" 2>/dev/null || true\n\naz webapp identity remove \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --identities "${SECONDARY_IDENTITY_ID}" 2>/dev/null || true\n\naz vm identity remove \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --identities "${USER_IDENTITY_ID}" 2>/dev/null || true\n\n# Step 3: Delete user-assigned identities\naz identity delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${USER_MANAGED_ID}" || true\n\naz identity delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "azurehaymaker-secondary-${UNIQUE_ID}" || true\n\n# Step 4: Delete the entire resource group (includes all resources)\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 5: Wait for deletion to complete\necho "Waiting for resource group deletion..."\nsleep 120\n\n# Step 6: Verify deletion\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 7: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-security-${UNIQUE_ID}-rg`\n- User-assigned Identity: `azurehaymaker-identity-${UNIQUE_ID}`\n- Virtual Machine: `azurehaymaker-vm-${UNIQUE_ID}`\n- App Service Plan: `azurehaymaker-asp-${UNIQUE_ID}`\n- Web App: `azurehaymaker-app-${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n- Storage Account: `azurehaymaker${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Managed Identities Overview](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview)\n- [Managed Identities for Azure Resources](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/)\n- [How to Use Managed Identities](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-to-use-vm-token)\n- [System-assigned vs User-assigned Identities](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview#managed-identity-types)\n- [Service Principals in Azure](https://learn.microsoft.com/en-us/azure/active-directory/develop/app-objects-and-service-principals)\n- [Managed Identity Best Practices](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/managed-identities-faq)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive managed identity management with straightforward commands for identity creation, assignment, and RBAC configuration. Direct commands enable rapid secure service-to-service communication setup.\n\n---\n\n## Estimated Duration\n- **Deployment**: 15-20 minutes\n- **Operations Phase**: 8+ hours (with identity management, role assignment, and credential rotation)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- System-assigned identities are created and destroyed with the resource\n- User-assigned identities persist independently and can be reused across resources\n- No credentials or secrets stored when using managed identities\n- Each managed identity is a service principal in Entra ID\n- Role assignments determine permissions for managed identities\n- Managed identities automatically handled token lifecycle\n- Operations scoped to single subscription with multiple resource integration\n- Recommended approach for service-to-service authentication in Azure\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Managed Identities for Azure Resources...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Managed Identities for Azure Resources...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-managed-identities-agent...")
    print("Goal: Scenario: Managed Identities for Azure Resources")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
