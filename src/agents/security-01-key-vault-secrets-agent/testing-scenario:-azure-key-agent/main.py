#!/usr/bin/env python3
"""
testing-scenario:-azure-key-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Azure Key Vault for Secrets Management\n\n## Objective\n# Scenario: Azure Key Vault for Secrets Management\n\n## Technology Area\nSecurity\n\n## Company Profile\n- **Company Size**: Small startup\n- **Industry**: SaaS / Financial Technology\n- **Use Case**: Securely store and manage API keys, connection strings, and sensitive credentials for cloud applications\n\n## Scenario Description\nDeploy Azure Key Vault to centrally manage application secrets including API keys, connection strings, and certificates. This scenario covers secret creation, access management, rotation policies, and secure retrieval patterns for applications.\n\n## Azure Services Used\n- Azure Key Vault\n- Azure Managed Identity\n- Azure App Service (for consumption example)\n- Azure CLI (for secret management)\n\n## Prerequisites\n- Azure subscription with Owner or Contributor role\n- Azure CLI installed and configured\n- jq (JSON processor) for parsing responses\n- Access to create and manage Key Vault resources\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-security-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nKEY_VAULT_NAME="azurehaymaker-kv-${UNIQUE_ID}"\nAPP_SERVICE_PLAN="azurehaymaker-asp-${UNIQUE_ID}"\nWEB_APP_NAME="azurehaymaker-app-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=security-key-vault Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Azure Key Vault\naz keyvault create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEY_VAULT_NAME}" \\\n  --location "${LOCATION}" \\\n  --enable-rbac-authorization \\\n  --tags ${TAGS}\n\n# Step 3: Set access policy for current user (legacy model for testing)\nCURRENT_USER_OID=$(az ad signed-in-user show --query objectId -o tsv)\naz keyvault set-policy \\\n  --name "${KEY_VAULT_NAME}" \\\n  --object-id "${CURRENT_USER_OID}" \\\n  --secret-permissions get list set delete\n\n# Step 4: Create API Key secret\naz keyvault secret set \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "api-key" \\\n  --value "sk-$(openssl rand -hex 32)"\n\n# Step 5: Create Database Connection String secret\naz keyvault secret set \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "db-connection-string" \\\n  --value "Server=myserver.database.windows.net;Database=mydb;User Id=sa;Password=HayMaker$(openssl rand -hex 8)"\n\n# Step 6: Create third-party API credentials secret\naz keyvault secret set \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "third-party-api-credentials" \\\n  --value "{\\"username\\":\\"user123\\",\\"password\\":\\"pass$(openssl rand -hex 12)\\"}"\n\n# Step 7: Create JWT signing key secret\naz keyvault secret set \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "jwt-signing-key" \\\n  --value "$(openssl rand -base64 32)"\n\n# Step 8: Create App Service Plan\naz appservice plan create \\\n  --name "${APP_SERVICE_PLAN}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --sku B1 \\\n  --is-linux \\\n  --tags ${TAGS}\n\n# Step 9: Create Web App with identity\naz webapp create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --plan "${APP_SERVICE_PLAN}" \\\n  --name "${WEB_APP_NAME}" \\\n  --runtime "PYTHON|3.9" \\\n  --tags ${TAGS}\n\n# Step 10: Enable system-assigned managed identity on the Web App\naz webapp identity assign \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --identities [system]\n\n# Step 11: Get the managed identity object ID\nIDENTITY_OID=$(az webapp identity show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --query principalId -o tsv)\n\n# Step 12: Grant Key Vault access to the managed identity\naz keyvault set-policy \\\n  --name "${KEY_VAULT_NAME}" \\\n  --object-id "${IDENTITY_OID}" \\\n  --secret-permissions get list\n\necho "Key Vault Name: ${KEY_VAULT_NAME}"\necho "Web App Name: ${WEB_APP_NAME}"\necho "Managed Identity OID: ${IDENTITY_OID}"\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify Key Vault creation\naz keyvault show --resource-group "${RESOURCE_GROUP}" --name "${KEY_VAULT_NAME}"\n\n# List all secrets in Key Vault\naz keyvault secret list --vault-name "${KEY_VAULT_NAME}" --output table\n\n# Retrieve a specific secret value\naz keyvault secret show \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "api-key" \\\n  --query value -o tsv\n\n# Verify Web App identity\naz webapp identity show --resource-group "${RESOURCE_GROUP}" --name "${WEB_APP_NAME}"\n\n# Check Key Vault access policies\naz keyvault list-deleted --resource-group "${RESOURCE_GROUP}" || \\\n  az keyvault show --resource-group "${RESOURCE_GROUP}" --name "${KEY_VAULT_NAME}"\n\n# List all resources in the resource group\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Create a new secret version with a new value\naz keyvault secret set \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "api-key" \\\n  --value "sk-$(openssl rand -hex 32)"\n\n# Operation 2: List all versions of a secret\naz keyvault secret list-versions \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "api-key" \\\n  --output table\n\n# Operation 3: Retrieve a specific secret version by ID\nAPI_KEY_ID=$(az keyvault secret show \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "api-key" \\\n  --query id -o tsv)\n\naz keyvault secret show --id "${API_KEY_ID}"\n\n# Operation 4: Add tags to a secret\naz keyvault secret set \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "db-connection-string" \\\n  --value "Server=myserver.database.windows.net;Database=mydb;User Id=sa;Password=HayMaker$(openssl rand -hex 8)" \\\n  --tags environment=production tier=database\n\n# Operation 5: Update Web App settings to reference Key Vault\naz webapp config appsettings set \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${WEB_APP_NAME}" \\\n  --settings \\\n    "@Microsoft.KeyVault(SecretUri=https://${KEY_VAULT_NAME}.vault.azure.net/secrets/api-key/)" \\\n    "KEYVAULT_URL=https://${KEY_VAULT_NAME}.vault.azure.net/"\n\n# Operation 6: Create certificate in Key Vault (self-signed for testing)\naz keyvault certificate create \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "test-certificate" \\\n  --policy @- << EOF\n{\n  "issuerParameters": {\n    "name": "Self"\n  },\n  "keyProperties": {\n    "exportable": true,\n    "keySize": 2048,\n    "keyType": "RSA",\n    "reuseKey": true\n  },\n  "lifetimeActions": [\n    {\n      "action": {\n        "actionType": "EmailContacts"\n      },\n      "trigger": {\n        "daysBeforeExpiry": 30\n      }\n    }\n  ],\n  "secretProperties": {\n    "contentType": "application/x-pkcs12"\n  },\n  "x509CertificateProperties": {\n    "extendedKeyUsage": [\n      "1.3.6.1.5.5.7.3.1"\n    ],\n    "keyUsage": [\n      "digitalSignature"\n    ],\n    "subject": "CN=azurehaymaker.local",\n    "validityInMonths": 12\n  }\n}\nEOF\n\n# Operation 7: Audit Key Vault access logs\naz monitor activity-log list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --caller-only \\\n  --output table\n\n# Operation 8: Set secret expiration policy\naz keyvault secret set \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "temp-api-token" \\\n  --value "token-$(openssl rand -hex 16)" \\\n  --expires $(date -u -d \'+7 days\' \'+%s\')\n\n# Operation 9: Check Key Vault diagnostics settings\naz monitor diagnostic-settings list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.KeyVault/vaults/${KEY_VAULT_NAME}" \\\n  --output table || echo "Diagnostics not yet configured"\n\n# Operation 10: Backup a secret\nBACKUP_DIR="/tmp/kv-backup-${UNIQUE_ID}"\nmkdir -p "${BACKUP_DIR}"\n\naz keyvault secret backup \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --name "api-key" \\\n  --file "${BACKUP_DIR}/api-key.backup"\n\n# Operation 11: Restore a secret from backup\naz keyvault secret restore \\\n  --vault-name "${KEY_VAULT_NAME}" \\\n  --file "${BACKUP_DIR}/api-key.backup"\n\n# Operation 12: Enable soft delete verification (already enabled by default)\naz keyvault show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEY_VAULT_NAME}" \\\n  --query "{enableSoftDelete: properties.enableSoftDelete, softDeleteRetentionInDays: properties.softDeleteRetentionInDays}"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Purge all secrets from Key Vault (optional - soft delete removes immediately)\nfor SECRET in $(az keyvault secret list --vault-name "${KEY_VAULT_NAME}" --query "[].name" -o tsv); do\n  az keyvault secret delete \\\n    --vault-name "${KEY_VAULT_NAME}" \\\n    --name "${SECRET}" || true\ndone\n\n# Step 2: Purge certificates from Key Vault\nfor CERT in $(az keyvault certificate list --vault-name "${KEY_VAULT_NAME}" --query "[].name" -o tsv); do\n  az keyvault certificate delete \\\n    --vault-name "${KEY_VAULT_NAME}" \\\n    --name "${CERT}" || true\ndone\n\n# Step 3: Delete the entire resource group (includes Key Vault, Web App, App Service Plan)\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 4: Wait for deletion to complete\necho "Waiting for resource group deletion..."\nsleep 120\n\n# Step 5: Verify deletion\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 6: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n\n# Step 7: Clean up local backup files\nrm -rf /tmp/kv-backup-*\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-security-${UNIQUE_ID}-rg`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n- App Service Plan: `azurehaymaker-asp-${UNIQUE_ID}`\n- Web App: `azurehaymaker-app-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Key Vault Overview](https://learn.microsoft.com/en-us/azure/key-vault/general/overview)\n- [Key Vault Secret Management](https://learn.microsoft.com/en-us/azure/key-vault/secrets/about-secrets)\n- [Managed Identity for Azure Resources](https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview)\n- [Key Vault Access Control](https://learn.microsoft.com/en-us/azure/key-vault/general/security-features)\n- [Key Vault CLI Reference](https://learn.microsoft.com/en-us/cli/azure/keyvault)\n- [Key Vault Best Practices](https://learn.microsoft.com/en-us/azure/key-vault/general/security-best-practices)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive Key Vault management capabilities for secret lifecycle management, access policies, and integration with other Azure services. Direct CLI commands enable rapid secret provisioning and audit operations.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8+ hours (with secret rotation, access management, and compliance checks)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- Key Vault uses RBAC for access control (recommended over legacy access policies)\n- Secrets are encrypted at rest and in transit\n- Soft delete enabled by default for recovery (retention: 90 days)\n- Managed identity eliminates need for credential storage in application code\n- All secrets stored with unique IDs for version control and rollback capability\n- Operations scoped to single tenant and subscription\n- Key Vault integrates with Azure Monitor for comprehensive audit logging\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Azure Key Vault for Secrets Management...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Azure Key Vault for Secrets Management...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-azure-key-agent...")
    print("Goal: Scenario: Azure Key Vault for Secrets Management")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
