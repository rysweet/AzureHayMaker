#!/usr/bin/env python3
"""
testing-scenario:-site-to-site-vpn-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Site-to-Site VPN Gateway Connection\n\n## Objective\n# Scenario: Site-to-Site VPN Gateway Connection\n\n## Technology Area\nNetworking\n\n## Company Profile\n- **Company Size**: Mid-size enterprise\n- **Industry**: Finance / Professional Services\n- **Use Case**: Establish secure site-to-site VPN connectivity between on-premises network and Azure\n\n## Scenario Description\nDeploy an Azure VPN Gateway configured for site-to-site VPN connectivity to simulate an on-premises network connection. This scenario covers gateway provisioning, IPsec configuration, connection management, and traffic routing through encrypted tunnels.\n\n## Azure Services Used\n- Azure VPN Gateway\n- Azure Virtual Network\n- Azure Public IP\n- Azure Local Network Gateway\n- Azure Connection (VPN)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed and configured\n- Understanding of VPN concepts and IPsec protocols\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-vpn-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nVNET_NAME="azurehaymaker-vnet-${UNIQUE_ID}"\nGATEWAY_SUBNET="GatewaySubnet"\nAPPLICATION_SUBNET="azurehaymaker-app-${UNIQUE_ID}"\nVPN_GATEWAY="azurehaymaker-vpn-gw-${UNIQUE_ID}"\nVPN_PUBLIC_IP="azurehaymaker-vpn-pip-${UNIQUE_ID}"\nLOCAL_GATEWAY="azurehaymaker-local-gw-${UNIQUE_ID}"\nVPN_CONNECTION="azurehaymaker-vpn-conn-${UNIQUE_ID}"\n\n# Simulated on-premises network\nLOCAL_NETWORK_PREFIX="192.168.0.0/16"\nLOCAL_GATEWAY_IP="203.0.113.12"  # Simulated public IP\nSHARED_KEY="AzureHayMaker2024Secure"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=networking-vpn-gateway Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network\naz network vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VNET_NAME}" \\\n  --address-prefix 10.0.0.0/16 \\\n  --tags ${TAGS}\n\n# Step 3: Create Gateway Subnet (required for VPN Gateway)\naz network vnet subnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --name "${GATEWAY_SUBNET}" \\\n  --address-prefix 10.0.255.0/27\n\n# Step 4: Create application subnet for testing\naz network vnet subnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --name "${APPLICATION_SUBNET}" \\\n  --address-prefix 10.0.1.0/24\n\n# Step 5: Create public IP for VPN Gateway\naz network public-ip create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_PUBLIC_IP}" \\\n  --allocation-method Static \\\n  --sku Standard \\\n  --tags ${TAGS}\n\n# Step 6: Create VPN Gateway (this may take 15-20 minutes)\naz network vnet-gateway create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_GATEWAY}" \\\n  --public-ip-addresses "${VPN_PUBLIC_IP}" \\\n  --vnet "${VNET_NAME}" \\\n  --gateway-type Vpn \\\n  --vpn-type RouteBased \\\n  --sku VpnGw1 \\\n  --tags ${TAGS} \\\n  --no-wait\n\n# Wait for gateway creation\necho "Waiting for VPN Gateway creation (this typically takes 15-20 minutes)..."\nsleep 180\n\n# Step 7: Get VPN Gateway public IP\nVPN_GATEWAY_IP=$(az network public-ip show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_PUBLIC_IP}" \\\n  --query ipAddress -o tsv)\n\necho "VPN Gateway Public IP: ${VPN_GATEWAY_IP}"\n\n# Step 8: Create Local Network Gateway (represents on-premises network)\naz network local-gateway create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${LOCAL_GATEWAY}" \\\n  --gateway-ip-address "${LOCAL_GATEWAY_IP}" \\\n  --local-address-prefixes "${LOCAL_NETWORK_PREFIX}" \\\n  --tags ${TAGS}\n\n# Step 9: Create VPN Connection\naz network vpn-connection create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_CONNECTION}" \\\n  --vnet-gateway1 "${VPN_GATEWAY}" \\\n  --local-gateway2 "${LOCAL_GATEWAY}" \\\n  --shared-key "${SHARED_KEY}" \\\n  --tags ${TAGS}\n\n# Step 10: Configure IPsec policies (optional but recommended)\naz network vpn-connection ipsec-policy add \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --connection-name "${VPN_CONNECTION}" \\\n  --dh-group DHGroup14 \\\n  --ike-encryption AES256 \\\n  --ike-integrity SHA256 \\\n  --ipsec-encryption AES256 \\\n  --ipsec-integrity SHA256 \\\n  --pfs-group PFS2048 \\\n  --sa-lifetime 27000\n\n# Step 11: Verify connection status\naz network vpn-connection show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_CONNECTION}" \\\n  --query "connectionStatus"\n\n# Step 12: Create Network Security Group for application subnet\nNSG_NAME="azurehaymaker-vpn-nsg-${UNIQUE_ID}"\naz network nsg create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${NSG_NAME}" \\\n  --tags ${TAGS}\n\n# Step 13: Add NSG rules for VPN traffic\naz network nsg rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --nsg-name "${NSG_NAME}" \\\n  --name "allow-from-onpremises" \\\n  --priority 1000 \\\n  --source-address-prefixes "${LOCAL_NETWORK_PREFIX}" \\\n  --source-port-ranges "*" \\\n  --destination-address-prefixes "*" \\\n  --destination-port-ranges "*" \\\n  --access Allow \\\n  --protocol "*"\n\n# Step 14: Associate NSG with application subnet\naz network vnet subnet update \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --name "${APPLICATION_SUBNET}" \\\n  --network-security-group "${NSG_NAME}"\n```\n\n### Validation\n```bash\n# Verify VPN Gateway\naz network vnet-gateway show --resource-group "${RESOURCE_GROUP}" --name "${VPN_GATEWAY}"\n\n# Verify VPN Gateway public IP\naz network public-ip show --resource-group "${RESOURCE_GROUP}" --name "${VPN_PUBLIC_IP}"\n\n# Verify Local Network Gateway\naz network local-gateway show --resource-group "${RESOURCE_GROUP}" --name "${LOCAL_GATEWAY}"\n\n# Check VPN Connection status\naz network vpn-connection show --resource-group "${RESOURCE_GROUP}" --name "${VPN_CONNECTION}" --query "{name: name, connectionStatus: connectionStatus, provisioningState: provisioningState}"\n\n# List all VPN connections\naz network vpn-connection list --resource-group "${RESOURCE_GROUP}" --output table\n\n# Get IPsec policies\naz network vpn-connection ipsec-policy list --resource-group "${RESOURCE_GROUP}" --connection-name "${VPN_CONNECTION}"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Check VPN Connection statistics\naz network vpn-connection get-ikesa \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_CONNECTION}"\n\n# Operation 2: Reset VPN Gateway (may be needed for troubleshooting)\n# Note: This operation temporarily disconnects VPN connections\n# az network vnet-gateway reset --resource-group "${RESOURCE_GROUP}" --name "${VPN_GATEWAY}" --no-wait\n\n# Operation 3: View VPN Gateway configuration\naz network vnet-gateway show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_GATEWAY}" \\\n  --query "{name: name, type: type, vpnType: vpnType, gatewayType: gatewayType, skuName: sku.name}"\n\n# Operation 4: List all subnets in VNet\naz network vnet subnet list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --output table\n\n# Operation 5: Update VPN Connection shared key (change encryption key)\naz network vpn-connection shared-key update \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --connection-name "${VPN_CONNECTION}" \\\n  --value "NewAzureHayMaker2024Key"\n\n# Operation 6: Get VPN Gateway supported VPN protocols\naz network vnet-gateway supported-vpn-devices \\\n  --query "[].supportedVpnDevices" -o json\n\n# Operation 7: Monitor connection metrics\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Network/connections/${VPN_CONNECTION}" \\\n  --metric "BytesIn BytesOut Packets" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 8: Create VPN client configuration (for point-to-site - simulated)\naz network vnet-gateway vpn-client generate \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_GATEWAY}" \\\n  --processor-architecture Amd64 \\\n  --authentication-method EAP \\\n  --output table\n\n# Operation 9: Update NSG to add additional allowed ports\naz network nsg rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --nsg-name "${NSG_NAME}" \\\n  --name "allow-rdp-from-onpremises" \\\n  --priority 1001 \\\n  --source-address-prefixes "${LOCAL_NETWORK_PREFIX}" \\\n  --source-port-ranges "*" \\\n  --destination-address-prefixes "10.0.1.0/24" \\\n  --destination-port-ranges "3389" \\\n  --access Allow \\\n  --protocol Tcp\n\n# Operation 10: Verify routing table configuration\naz network route-table list --resource-group "${RESOURCE_GROUP}" --output table\n\n# Operation 11: Check gateway connectivity status\naz network vpn-connection show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_CONNECTION}" \\\n  --query "{connectionStatus: connectionStatus, egressBytesTransferred: egressBytesTransferred, ingressBytesTransferred: ingressBytesTransferred}"\n\n# Operation 12: List Local Network Gateway address prefixes\naz network local-gateway show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${LOCAL_GATEWAY}" \\\n  --query "localNetworkAddressSpace.addressPrefixes"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete VPN Connection\naz network vpn-connection delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_CONNECTION}" \\\n  --yes \\\n  --no-wait\n\n# Step 2: Delete VPN Gateway (this may take several minutes)\naz network vnet-gateway delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VPN_GATEWAY}" \\\n  --yes \\\n  --no-wait\n\n# Step 3: Wait for gateway deletion\necho "Waiting for VPN Gateway deletion..."\nsleep 180\n\n# Step 4: Delete Local Network Gateway\naz network local-gateway delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${LOCAL_GATEWAY}" \\\n  --yes\n\n# Step 5: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 6: Verify deletion\necho "Waiting for resource group deletion..."\nsleep 120\n\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 7: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-vpn-${UNIQUE_ID}-rg`\n- Virtual Network: `azurehaymaker-vnet-${UNIQUE_ID}`\n- VPN Gateway: `azurehaymaker-vpn-gw-${UNIQUE_ID}`\n- VPN Gateway Public IP: `azurehaymaker-vpn-pip-${UNIQUE_ID}`\n- Local Network Gateway: `azurehaymaker-local-gw-${UNIQUE_ID}`\n- VPN Connection: `azurehaymaker-vpn-conn-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure VPN Gateway Overview](https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpngateways)\n- [Site-to-Site VPN Configuration](https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-cli)\n- [IPsec Policies](https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-ipsecikepolicy-overview)\n- [VPN Gateway CLI Reference](https://learn.microsoft.com/en-us/cli/azure/network/vnet-gateway)\n- [Local Network Gateway](https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-tutorial-vpnconnection-cli)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive VPN Gateway management with all necessary commands for configuration, monitoring, and troubleshooting. Direct CLI commands enable fine-grained control over IPsec policies and connection parameters.\n\n---\n\n## Estimated Duration\n- **Deployment**: 25-30 minutes (includes gateway provisioning time)\n- **Operations Phase**: 8+ hours (with monitoring and maintenance)\n- **Cleanup**: 15-20 minutes (includes gateway deletion)\n\n---\n\n## Notes\n- VPN Gateway provisioning takes 15-20 minutes; operations wait accordingly\n- RouteBased VPN supports dynamic routing with BGP\n- IPsec policies configured for strong encryption (AES256)\n- Local Network Gateway simulates on-premises network with 192.168.0.0/16\n- Shared key is stored securely; update periodically in production\n- Connection status may show "NotConnected" in lab environment without actual on-premises VPN device\n- All operations scoped to single tenant and subscription\n- Gateway SKU (VpnGw1) supports up to 128 concurrent connections\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Site-to-Site VPN Gateway Connection...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": ["Goal 'Scenario: Site-to-Site VPN Gateway Connection...' is achieved"],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-site-to-site-vpn-agent...")
    print("Goal: Scenario: Site-to-Site VPN Gateway Connection")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
