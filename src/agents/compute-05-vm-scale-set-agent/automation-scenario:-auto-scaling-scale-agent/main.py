#!/usr/bin/env python3
"""
automation-scenario:-auto-scaling-scale-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 6,
        "initial_prompt": '# Goal: Scenario: Auto-Scaling VM Scale Set with Load Balancer\n\n## Objective\n# Scenario: Auto-Scaling VM Scale Set with Load Balancer\n\n## Technology Area\nCompute\n\n## Company Profile\n- **Company Size**: Mid-size enterprise\n- **Industry**: E-Commerce / Retail\n- **Use Case**: Deploy auto-scaling virtual machine fleet with load balancing for high-traffic web applications\n\n## Scenario Description\nDeploy an Azure Virtual Machine Scale Set with automatic scaling based on CPU utilization, fronted by an Azure Load Balancer for traffic distribution. Includes monitoring, scaling rules configuration, and traffic management.\n\n## Azure Services Used\n- Azure Virtual Machine Scale Sets\n- Azure Load Balancer\n- Azure Network Interfaces\n- Azure Network Security Groups\n- Azure Public IP Addresses\n- Azure Monitor with auto-scaling rules\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed and configured\n- Basic understanding of load balancing concepts\n- Access to create VMs and networking resources\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-compute-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nVMSS_NAME="azurehaymaker-vmss-${UNIQUE_ID}"\nLB_NAME="azurehaymaker-lb-${UNIQUE_ID}"\nLB_BACKEND_POOL="azurehaymaker-backend-${UNIQUE_ID}"\nLB_FRONTEND_IP="azurehaymaker-frontend-${UNIQUE_ID}"\nNSG_NAME="azurehaymaker-vmss-nsg-${UNIQUE_ID}"\nVNET_NAME="azurehaymaker-vmss-vnet-${UNIQUE_ID}"\nSUBNET_NAME="azurehaymaker-vmss-subnet-${UNIQUE_ID}"\nPUBLIC_IP_NAME="azurehaymaker-lb-pip-${UNIQUE_ID}"\nAUTOSCALE_NAME="azurehaymaker-autoscale-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=compute-vm-scale-set Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network and Subnet\naz network vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VNET_NAME}" \\\n  --address-prefix 10.0.0.0/16 \\\n  --subnet-name "${SUBNET_NAME}" \\\n  --subnet-prefix 10.0.1.0/24 \\\n  --tags ${TAGS}\n\n# Step 3: Create Network Security Group for VMSS\naz network nsg create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${NSG_NAME}" \\\n  --tags ${TAGS}\n\n# Step 4: Add security rules\naz network nsg rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --nsg-name "${NSG_NAME}" \\\n  --name "allow-http" \\\n  --priority 1000 \\\n  --source-address-prefixes "*" \\\n  --destination-port-ranges 80 \\\n  --access Allow \\\n  --protocol Tcp\n\naz network nsg rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --nsg-name "${NSG_NAME}" \\\n  --name "allow-https" \\\n  --priority 1001 \\\n  --source-address-prefixes "*" \\\n  --destination-port-ranges 443 \\\n  --access Allow \\\n  --protocol Tcp\n\naz network nsg rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --nsg-name "${NSG_NAME}" \\\n  --name "allow-ssh" \\\n  --priority 1002 \\\n  --source-address-prefixes "*" \\\n  --destination-port-ranges 22 \\\n  --access Allow \\\n  --protocol Tcp\n\n# Step 5: Create Public IP for Load Balancer\naz network public-ip create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PUBLIC_IP_NAME}" \\\n  --allocation-method Static \\\n  --sku Standard \\\n  --tags ${TAGS}\n\nPUBLIC_IP=$(az network public-ip show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PUBLIC_IP_NAME}" \\\n  --query ipAddress -o tsv)\n\necho "Load Balancer Public IP: ${PUBLIC_IP}"\n\n# Step 6: Create Load Balancer\naz network lb create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${LB_NAME}" \\\n  --sku Standard \\\n  --public-ip-address "${PUBLIC_IP_NAME}" \\\n  --frontend-ip-name "${LB_FRONTEND_IP}" \\\n  --backend-pool-name "${LB_BACKEND_POOL}" \\\n  --tags ${TAGS}\n\n# Step 7: Create health probe for Load Balancer\naz network lb probe create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --lb-name "${LB_NAME}" \\\n  --name "health-probe" \\\n  --protocol http \\\n  --port 80 \\\n  --path "/"\n\n# Step 8: Create load balancing rule\naz network lb rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --lb-name "${LB_NAME}" \\\n  --name "http-rule" \\\n  --protocol tcp \\\n  --frontend-port 80 \\\n  --backend-port 80 \\\n  --frontend-ip-name "${LB_FRONTEND_IP}" \\\n  --backend-pool-name "${LB_BACKEND_POOL}" \\\n  --probe-name "health-probe"\n\n# Step 9: Create Virtual Machine Scale Set\naz vmss create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VMSS_NAME}" \\\n  --image UbuntuLTS \\\n  --vm-sku Standard_B1s \\\n  --admin-username azureuser \\\n  --generate-ssh-keys \\\n  --vnet-name "${VNET_NAME}" \\\n  --subnet "${SUBNET_NAME}" \\\n  --nsg "${NSG_NAME}" \\\n  --backend-pool-name "${LB_BACKEND_POOL}" \\\n  --load-balancer "${LB_NAME}" \\\n  --instance-count 2 \\\n  --tags ${TAGS}\n\n# Step 10: Install nginx on all VMSS instances using custom script extension\naz vmss extension set \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vmss-name "${VMSS_NAME}" \\\n  --name CustomScriptExtension \\\n  --publisher Microsoft.Azure.Extensions \\\n  --version 2.1 \\\n  --protected-settings \'{"commandToExecute":"bash -c \\"apt-get update && apt-get install -y nginx && systemctl start nginx && systemctl enable nginx && HOSTNAME=$(hostname) && cat > /var/www/html/index.html <<EOFHTML\\n<!DOCTYPE html>\\n<html>\\n<head><title>Azure HayMaker - VMSS</title><style>body{font-family:Arial;margin:50px}h1{color:#0078d4}</style></head>\\n<body>\\n<h1>Azure HayMaker - VM Scale Set</h1>\\n<p>Scenario: compute-05-vm-scale-set</p>\\n<p>Hostname: ${HOSTNAME}</p>\\n<p>Instance ID: $(curl -s -H Metadata:true http://169.254.169.254/metadata/instance?api-version=2020-09-01 | grep -o \\"vmId[^,]*\\" | cut -d\\\\\\" -f3)</p>\\n<p>Timestamp: $(date)</p>\\n</body>\\n</html>\\nEOFHTML\\""}\'\n\n# Step 11: Create auto-scale settings based on CPU utilization\naz monitor autoscale create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --resource "${VMSS_NAME}" \\\n  --resource-type "Microsoft.Compute/virtualMachineScaleSets" \\\n  --name "${AUTOSCALE_NAME}" \\\n  --min-count 2 \\\n  --max-count 10 \\\n  --count 2\n\n# Step 12: Add scale-out rule (when CPU > 70%)\naz monitor autoscale rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --autoscale-name "${AUTOSCALE_NAME}" \\\n  --condition "Percentage CPU > 70 avg 5m" \\\n  --scale out 2\n\n# Step 13: Add scale-in rule (when CPU < 30%)\naz monitor autoscale rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --autoscale-name "${AUTOSCALE_NAME}" \\\n  --condition "Percentage CPU < 30 avg 10m" \\\n  --scale in 1\n\n# Step 14: Wait for VMSS deployment and script execution\necho "Waiting for VMSS initialization..."\nsleep 120\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify VMSS configuration\naz vmss show --resource-group "${RESOURCE_GROUP}" --name "${VMSS_NAME}"\n\n# Verify Load Balancer\naz network lb show --resource-group "${RESOURCE_GROUP}" --name "${LB_NAME}"\n\n# List VMSS instances\naz vmss list-instances --resource-group "${RESOURCE_GROUP}" --vmss-name "${VMSS_NAME}" --output table\n\n# Test Load Balancer endpoint\necho "Testing HTTP connection to Load Balancer (${PUBLIC_IP})..."\ncurl -I "http://${PUBLIC_IP}" || echo "Note: May need to wait a moment for instances to be ready"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Monitor VMSS instance health\naz vmss list-instances \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vmss-name "${VMSS_NAME}" \\\n  --query "[].{ID:instanceId, ProvisioningState:provisioningState, PowerState:powerState}" \\\n  --output table\n\n# Operation 2: Check Load Balancer backend pool health\naz network lb address-pool show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --lb-name "${LB_NAME}" \\\n  --name "${LB_BACKEND_POOL}" \\\n  --output table\n\n# Operation 3: Monitor CPU metrics for VMSS\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Compute/virtualMachineScaleSets/${VMSS_NAME}" \\\n  --metric "Percentage CPU" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 4: Monitor network throughput\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Compute/virtualMachineScaleSets/${VMSS_NAME}" \\\n  --metric "Network In Total" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 5: Check auto-scale settings\naz monitor autoscale show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${AUTOSCALE_NAME}"\n\n# Operation 6: View auto-scale activity logs\naz monitor autoscale-settings list-by-resource-group \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# Operation 7: Manually scale out VMSS instances\naz vmss scale \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VMSS_NAME}" \\\n  --new-capacity 5\n\n# Operation 8: Manually scale in VMSS instances\naz vmss scale \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VMSS_NAME}" \\\n  --new-capacity 3\n\n# Operation 9: Restart specific VMSS instance\nINSTANCE_ID=$(az vmss list-instances --resource-group "${RESOURCE_GROUP}" --vmss-name "${VMSS_NAME}" --query "[0].instanceId" -o tsv)\naz vmss restart --resource-group "${RESOURCE_GROUP}" --name "${VMSS_NAME}" --instance-ids "${INSTANCE_ID}"\n\n# Operation 10: Update VMSS instance count from Load Balancer metrics\naz network lb show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${LB_NAME}" \\\n  --query "backendAddressPools[].backendIpConfigurations" \\\n  --output table\n\n# Operation 11: Check Load Balancer rule configuration\naz network lb rule list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --lb-name "${LB_NAME}" \\\n  --output table\n\n# Operation 12: Update VMSS base image (rolling upgrade)\naz vmss update --resource-group "${RESOURCE_GROUP}" --name "${VMSS_NAME}" --enable-os-disk-encryption false\n\n# Operation 13: Monitor Load Balancer throughput\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Network/loadBalancers/${LB_NAME}" \\\n  --metric "BytesInCount" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 14: View VMSS upgrade history\naz vmss rolling-upgrade start-extension-upgrade \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vmss-name "${VMSS_NAME}" || true\n\n# Operation 15: Perform stress testing to trigger auto-scale\nfor INSTANCE in $(az vmss list-instances --resource-group "${RESOURCE_GROUP}" --vmss-name "${VMSS_NAME}" --query "[].[instanceId]" -o tsv); do\n  az vmss run-command invoke \\\n    --resource-group "${RESOURCE_GROUP}" \\\n    --instance-ids "${INSTANCE}" \\\n    --vmss-name "${VMSS_NAME}" \\\n    --command-id RunShellScript \\\n    --scripts "stress-ng --cpu 2 --timeout 30s &" 2>/dev/null || true\ndone\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 2: Wait for deletion to complete\necho "Waiting for resource group deletion..."\nsleep 120\n\n# Step 3: Verify deletion\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 4: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-compute-${UNIQUE_ID}-rg`\n- Virtual Machine Scale Set: `azurehaymaker-vmss-${UNIQUE_ID}`\n- Load Balancer: `azurehaymaker-lb-${UNIQUE_ID}`\n- Network Security Group: `azurehaymaker-vmss-nsg-${UNIQUE_ID}`\n- Virtual Network: `azurehaymaker-vmss-vnet-${UNIQUE_ID}`\n- Public IP: `azurehaymaker-lb-pip-${UNIQUE_ID}`\n- Auto-scale Setting: `azurehaymaker-autoscale-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Virtual Machine Scale Sets Overview](https://learn.microsoft.com/en-us/azure/virtual-machine-scale-sets/overview)\n- [Create VM Scale Set with Azure CLI](https://learn.microsoft.com/en-us/azure/virtual-machine-scale-sets/quick-create-cli)\n- [Azure Load Balancer Overview](https://learn.microsoft.com/en-us/azure/load-balancer/load-balancer-overview)\n- [Autoscale Virtual Machine Scale Sets](https://learn.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-autoscale-overview)\n- [VM Scale Set Extensions](https://learn.microsoft.com/en-us/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-extensions)\n- [Load Balancer Rules](https://learn.microsoft.com/en-us/azure/load-balancer/load-balancer-components)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive VMSS and Load Balancer management with straightforward commands for provisioning, scaling, and monitoring. This approach enables flexible infrastructure-as-code patterns.\n\n---\n\n## Estimated Duration\n- **Deployment**: 20-25 minutes\n- **Operations Phase**: 8+ hours (with scaling operations, monitoring, and performance tuning)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- Virtual Machine Scale Set provides automated VM lifecycle management\n- Load Balancer distributes traffic across healthy instances\n- Auto-scaling rules trigger based on CPU metrics (scale out at >70%, scale in at <30%)\n- Minimum 2 instances, maximum 10 instances configured\n- Health probe monitors instance availability (HTTP port 80)\n- Custom Script Extension installs nginx automatically on all instances\n- Horizontal scaling handles traffic spikes without manual intervention\n- All operations scoped to single tenant and subscription\n- Ideal for stateless, horizontally-scalable applications\n- Zero-downtime deployments with rolling upgrades\n\n\n## Execution Plan\n\n### Phase 1: Setup\nConfigure automation environment\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: configuration, initialization\n\n### Phase 2: Workflow Design\nDesign automation workflow\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: workflow-design, orchestration\n**Dependencies**: Setup\n\n### Phase 3: Execution\nExecute automated tasks\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: task-execution, monitoring\n**Dependencies**: Workflow Design\n\n### Phase 4: Validation\nValidate results\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: validation, quality-check\n**Dependencies**: Execution\n\n## Success Criteria\n- Goal \'Scenario: Auto-Scaling VM Scale Set with Load Bala...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Auto-Scaling VM Scale Set with Load Bala...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting automation-scenario:-auto-scaling-scale-agent...")
    print("Goal: Scenario: Auto-Scaling VM Scale Set with Load Balancer")
    print("Estimated duration: 22 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
