#!/usr/bin/env python3
"""
testing-scenario:-entra-groups-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Entra ID Groups and Role Assignments\n\n## Objective\n# Scenario: Entra ID Groups and Role Assignments\n\n## Technology Area\nSecurity\n\n## Company Profile\n- **Company Size**: Mid-size enterprise\n- **Industry**: Enterprise Software / Consulting\n- **Use Case**: Manage user access through Azure AD groups with role-based access control to Azure resources\n\n## Scenario Description\nCreate and manage Azure Entra ID (formerly Azure AD) groups with hierarchical organization, assign role-based access to Azure resources, and manage membership. This scenario covers group creation, role assignment, access management, and compliance auditing.\n\n## Azure Services Used\n- Azure Entra ID (Azure AD)\n- Azure Role-Based Access Control (RBAC)\n- Azure Key Vault (for access validation)\n- Azure App Service (for access validation)\n\n## Prerequisites\n- Azure subscription with Owner or User Access Administrator role\n- Azure CLI installed and configured (version 2.40+)\n- Microsoft Graph CLI (optional, for advanced AD operations)\n- User with Entra ID administrator permissions\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-security-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nKEY_VAULT_NAME="azurehaymaker-kv-${UNIQUE_ID}"\nSTORAGE_ACCOUNT="azurehaymaker${UNIQUE_ID}"\nTENANT_ID=$(az account show --query tenantId -o tsv)\nSUBSCRIPTION_ID=$(az account show --query id -o tsv)\n\n# Entra ID Groups\nADMIN_GROUP="azurehaymaker-admins-${UNIQUE_ID}"\nDEVELOPER_GROUP="azurehaymaker-developers-${UNIQUE_ID}"\nREADER_GROUP="azurehaymaker-readers-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=security-entra-id-groups Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Key Vault for role-based access testing\naz keyvault create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${KEY_VAULT_NAME}" \\\n  --location "${LOCATION}" \\\n  --enable-rbac-authorization \\\n  --tags ${TAGS}\n\n# Step 3: Create Storage Account for role-based access testing\naz storage account create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --location "${LOCATION}" \\\n  --sku Standard_LRS \\\n  --tags ${TAGS}\n\n# Step 4: Create Entra ID Admin Group\nADMIN_GROUP_ID=$(az ad group create \\\n  --display-name "${ADMIN_GROUP}" \\\n  --mail-nickname "azurehaymaker-admins-${UNIQUE_ID}" \\\n  --query id -o tsv)\n\n# Step 5: Create Entra ID Developer Group\nDEVELOPER_GROUP_ID=$(az ad group create \\\n  --display-name "${DEVELOPER_GROUP}" \\\n  --mail-nickname "azurehaymaker-developers-${UNIQUE_ID}" \\\n  --query id -o tsv)\n\n# Step 6: Create Entra ID Reader Group\nREADER_GROUP_ID=$(az ad group create \\\n  --display-name "${READER_GROUP}" \\\n  --mail-nickname "azurehaymaker-readers-${UNIQUE_ID}" \\\n  --query id -o tsv)\n\n# Step 7: Assign Owner role to Admin Group on Resource Group\naz role assignment create \\\n  --role "Owner" \\\n  --assignee-object-id "${ADMIN_GROUP_ID}" \\\n  --assignee-principal-type Group \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# Step 8: Assign Contributor role to Developer Group on Resource Group\naz role assignment create \\\n  --role "Contributor" \\\n  --assignee-object-id "${DEVELOPER_GROUP_ID}" \\\n  --assignee-principal-type Group \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# Step 9: Assign Reader role to Reader Group on Resource Group\naz role assignment create \\\n  --role "Reader" \\\n  --assignee-object-id "${READER_GROUP_ID}" \\\n  --assignee-principal-type Group \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# Step 10: Assign Key Vault Secrets Officer role to Admin Group\naz role assignment create \\\n  --role "Key Vault Secrets Officer" \\\n  --assignee-object-id "${ADMIN_GROUP_ID}" \\\n  --assignee-principal-type Group \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.KeyVault/vaults/${KEY_VAULT_NAME}"\n\n# Step 11: Assign Key Vault Secrets User role to Developer Group\naz role assignment create \\\n  --role "Key Vault Secrets User" \\\n  --assignee-object-id "${DEVELOPER_GROUP_ID}" \\\n  --assignee-principal-type Group \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.KeyVault/vaults/${KEY_VAULT_NAME}"\n\n# Step 12: Assign Storage Account Contributor role to Developer Group\nSTORAGE_RESOURCE_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Storage/storageAccounts/${STORAGE_ACCOUNT}"\naz role assignment create \\\n  --role "Storage Account Contributor" \\\n  --assignee-object-id "${DEVELOPER_GROUP_ID}" \\\n  --assignee-principal-type Group \\\n  --scope "${STORAGE_RESOURCE_ID}"\n\necho "Admin Group ID: ${ADMIN_GROUP_ID}"\necho "Developer Group ID: ${DEVELOPER_GROUP_ID}"\necho "Reader Group ID: ${READER_GROUP_ID}"\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify Entra ID Groups exist\naz ad group list --filter "displayName eq \'${ADMIN_GROUP}\'" --output table\naz ad group list --filter "displayName eq \'${DEVELOPER_GROUP}\'" --output table\naz ad group list --filter "displayName eq \'${READER_GROUP}\'" --output table\n\n# List role assignments on Resource Group\naz role assignment list --resource-group "${RESOURCE_GROUP}" --output table\n\n# List role assignments on Key Vault\naz role assignment list \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.KeyVault/vaults/${KEY_VAULT_NAME}" \\\n  --output table\n\n# List role assignments on Storage Account\naz role assignment list \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Storage/storageAccounts/${STORAGE_ACCOUNT}" \\\n  --output table\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n\n# Get group details\naz ad group show --id "${ADMIN_GROUP_ID}"\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Get current user object ID for testing\nCURRENT_USER_OID=$(az ad signed-in-user show --query objectId -o tsv)\n\n# Operation 2: Add current user to Admin Group\naz ad group member add \\\n  --group "${ADMIN_GROUP_ID}" \\\n  --member-id "${CURRENT_USER_OID}"\n\n# Operation 3: Add current user to Developer Group\naz ad group member add \\\n  --group "${DEVELOPER_GROUP_ID}" \\\n  --member-id "${CURRENT_USER_OID}"\n\n# Operation 4: List members of Admin Group\naz ad group member list --group "${ADMIN_GROUP_ID}" --output table\n\n# Operation 5: List members of Developer Group\naz ad group member list --group "${DEVELOPER_GROUP_ID}" --output table\n\n# Operation 6: Create a second group for nested membership\nNESTED_GROUP="azurehaymaker-nested-${UNIQUE_ID}"\nNESTED_GROUP_ID=$(az ad group create \\\n  --display-name "${NESTED_GROUP}" \\\n  --mail-nickname "azurehaymaker-nested-${UNIQUE_ID}" \\\n  --query id -o tsv)\n\n# Operation 7: Add Developer Group as member to Admin Group (nested membership)\naz ad group member add \\\n  --group "${ADMIN_GROUP_ID}" \\\n  --member-id "${DEVELOPER_GROUP_ID}"\n\n# Operation 8: Check role assignments for current user\naz role assignment list \\\n  --assignee "${CURRENT_USER_OID}" \\\n  --output table\n\n# Operation 9: Deny specific action on resource for Developer Group\naz role assignment create \\\n  --role "Reader" \\\n  --assignee-object-id "${READER_GROUP_ID}" \\\n  --assignee-principal-type Group \\\n  --scope "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}" \\\n  --condition "((!(ActionMatches{\'Microsoft.Storage/storageAccounts/write\',\'Microsoft.Storage/storageAccounts/delete\'})) OR (@Resource[Microsoft.Authorization/locks/level] StringEquals \'CanNotDelete\'))" \\\n  --condition-version "2.0" || echo "Condition-based RBAC not available in current CLI version"\n\n# Operation 10: List all roles assigned to a group\naz role assignment list --assignee-object-id "${DEVELOPER_GROUP_ID}" --output table\n\n# Operation 11: Remove user from Developer Group\naz ad group member remove \\\n  --group "${DEVELOPER_GROUP_ID}" \\\n  --member-id "${CURRENT_USER_OID}"\n\n# Operation 12: Update group membership with batch operation\n# Create additional test group\nTEST_GROUP="azurehaymaker-test-${UNIQUE_ID}"\nTEST_GROUP_ID=$(az ad group create \\\n  --display-name "${TEST_GROUP}" \\\n  --mail-nickname "azurehaymaker-test-${UNIQUE_ID}" \\\n  --query id -o tsv)\n\n# Assign Reader role to Test Group\naz role assignment create \\\n  --role "Reader" \\\n  --assignee-object-id "${TEST_GROUP_ID}" \\\n  --assignee-principal-type Group \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# Operation 13: List all Entra ID groups in tenant\naz ad group list --output table\n\n# Operation 14: Export group membership for compliance report\necho "Group Membership Report - $(date)" > /tmp/group-report-${UNIQUE_ID}.txt\necho "Admin Group Members:" >> /tmp/group-report-${UNIQUE_ID}.txt\naz ad group member list --group "${ADMIN_GROUP_ID}" --output table >> /tmp/group-report-${UNIQUE_ID}.txt\necho "Developer Group Members:" >> /tmp/group-report-${UNIQUE_ID}.txt\naz ad group member list --group "${DEVELOPER_GROUP_ID}" --output table >> /tmp/group-report-${UNIQUE_ID}.txt\ncat /tmp/group-report-${UNIQUE_ID}.txt\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Remove all group members\nfor GROUP_ID in "${ADMIN_GROUP_ID}" "${DEVELOPER_GROUP_ID}" "${READER_GROUP_ID}"; do\n  for MEMBER in $(az ad group member list --group "${GROUP_ID}" --query "[].id" -o tsv); do\n    az ad group member remove \\\n      --group "${GROUP_ID}" \\\n      --member-id "${MEMBER}" || true\n  done\ndone\n\n# Step 2: Delete all Entra ID groups\naz ad group delete --id "${ADMIN_GROUP_ID}" || true\naz ad group delete --id "${DEVELOPER_GROUP_ID}" || true\naz ad group delete --id "${READER_GROUP_ID}" || true\naz ad group delete --id "${NESTED_GROUP_ID}" 2>/dev/null || true\naz ad group delete --id "${TEST_GROUP_ID}" 2>/dev/null || true\n\n# Step 3: Remove all role assignments from resource group\nfor ASSIGNMENT in $(az role assignment list --resource-group "${RESOURCE_GROUP}" --query "[].id" -o tsv); do\n  az role assignment delete --ids "${ASSIGNMENT}" || true\ndone\n\n# Step 4: Delete the entire resource group (includes Key Vault, Storage, etc.)\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 5: Wait for deletion to complete\necho "Waiting for resource group deletion..."\nsleep 120\n\n# Step 6: Verify deletion\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 7: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n\n# Step 8: Clean up local files\nrm -f /tmp/group-report-*.txt\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-security-${UNIQUE_ID}-rg`\n- Admin Group: `azurehaymaker-admins-${UNIQUE_ID}`\n- Developer Group: `azurehaymaker-developers-${UNIQUE_ID}`\n- Reader Group: `azurehaymaker-readers-${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n- Storage Account: `azurehaymaker${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Entra ID Overview](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis)\n- [Azure Groups and Members](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/how-to-manage-groups)\n- [Azure Role-Based Access Control (RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview)\n- [Built-in Azure Roles](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)\n- [Azure CLI AD Commands](https://learn.microsoft.com/en-us/cli/azure/ad)\n- [Azure RBAC Best Practices](https://learn.microsoft.com/en-us/azure/role-based-access-control/best-practices)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive Entra ID and RBAC management capabilities for group lifecycle and role assignment operations. Direct commands enable rapid access control provisioning and governance.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes\n- **Operations Phase**: 8+ hours (with membership management, role auditing, and compliance reviews)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- Entra ID groups support nested membership for hierarchical access structures\n- RBAC provides least-privilege access model with fine-grained role control\n- Role assignments inherit from resource group to contained resources\n- Groups can be used across subscriptions within the same tenant\n- Managed identity groups cannot be manually managed\n- Operations scoped to single tenant with multiple resource groups support\n- Audit logs track all group membership and role assignment changes\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Entra ID Groups and Role Assignments...\' is achieved\n\n## Constraints\n- be manually managed\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Entra ID Groups and Role Assignments...' is achieved"
        ],
        "constraints": ["be manually managed"],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-entra-groups-agent...")
    print("Goal: Scenario: Entra ID Groups and Role Assignments")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
