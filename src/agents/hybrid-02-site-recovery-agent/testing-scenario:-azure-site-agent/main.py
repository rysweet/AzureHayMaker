#!/usr/bin/env python3
"""
testing-scenario:-azure-site-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Azure Site Recovery for Disaster Recovery\n\n## Objective\n# Scenario: Azure Site Recovery for Disaster Recovery\n\n## Technology Area\nHybrid+Multicloud\n\n## Company Profile\n- **Company Size**: Large enterprise\n- **Industry**: Healthcare\n- **Use Case**: Replicate on-premises VMs to Azure for business continuity\n\n## Scenario Description\nDeploy Azure Site Recovery to replicate virtual machines from on-premises VMware/Hyper-V to Azure. Configure replication, set up recovery plans, and perform failover testing.\n\n## Azure Services Used\n- Azure Site Recovery (disaster recovery)\n- Azure Storage (replication target)\n- Azure Virtual Network (recovery network)\n- Azure Key Vault (credentials)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-hybrid-recovery-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nVAULT_NAME="azurehaymaker-vault-${UNIQUE_ID}"\nSTORAGE_ACCOUNT="azmkrsiterecovery${UNIQUE_ID}"\nVNET_NAME="azurehaymaker-vnet-${UNIQUE_ID}"\nKEYVAULT="azurehaymaker-kv-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=hybrid-site-recovery Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network for recovery\naz network vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VNET_NAME}" \\\n  --address-prefix "10.0.0.0/16" \\\n  --subnet-name "recovery-subnet" \\\n  --subnet-prefixes "10.0.0.0/24" \\\n  --tags ${TAGS}\n\n# Step 3: Create Storage Account for replication\naz storage account create \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --sku Standard_LRS \\\n  --kind StorageV2 \\\n  --tags ${TAGS}\n\n# Step 4: Create Key Vault\naz keyvault create \\\n  --name "${KEYVAULT}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 5: Create Recovery Services Vault\naz backup vault create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VAULT_NAME}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Note: The above creates a backup vault; for Site Recovery, use:\n# az resource create --resource-group ${RESOURCE_GROUP} --api-version 2021-07-01 --resource-type Microsoft.RecoveryServices/vaults\n\n# Alternative: Create recovery vault directly\ncat > /tmp/vault_template.json <<EOF\n{\n  "\\$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",\n  "contentVersion": "1.0.0.0",\n  "resources": [\n    {\n      "type": "Microsoft.RecoveryServices/vaults",\n      "apiVersion": "2021-07-01",\n      "name": "${VAULT_NAME}-recovery",\n      "location": "${LOCATION}",\n      "sku": {\n        "name": "Standard"\n      },\n      "properties": {}\n    }\n  ]\n}\nEOF\n\n# Deploy vault\naz deployment group create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --template-file /tmp/vault_template.json\n\n# Step 6: Configure vault storage redundancy\naz backup vault backup-properties set \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vault-name "${VAULT_NAME}" \\\n  --backup-storage-redundancy LocallyRedundant\n\n# Step 7: Enable replication policies\n# Create replication policy\ncat > /tmp/policy_config.json <<EOF\n{\n  "properties": {\n    "recoveryPointRetentionInDays": 7,\n    "appConsistentFrequencyInMinutes": 0,\n    "crashConsistentFrequencyInMinutes": 5,\n    "multiVmSyncStatus": "Enabled"\n  }\n}\nEOF\n\n# Step 8: Create sample protected item configuration\ncat > /tmp/protected_vm.json <<EOF\n{\n  "sourceVMName": "on-premises-vm-1",\n  "sourceVMResourceGroup": "on-premises-rg",\n  "protectionContainerName": "onprem-container",\n  "replicationPolicyName": "default-policy",\n  "targetResourceGroupName": "${RESOURCE_GROUP}",\n  "targetStorageAccount": "${STORAGE_ACCOUNT}",\n  "targetVirtualNetwork": "${VNET_NAME}",\n  "recoveryVaultName": "${VAULT_NAME}-recovery"\n}\nEOF\n\n# Step 9: Store recovery configuration in Key Vault\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "site-recovery-config" \\\n  --value @/tmp/protected_vm.json\n\n# Step 10: Create diagnostic settings\naz monitor diagnostic-settings create \\\n  --name "site-recovery-diagnostics" \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.RecoveryServices/vaults/${VAULT_NAME}" \\\n  --logs \'[{"category":"AzureSiteRecoveryEvents","enabled":true}]\' \\\n  --metrics \'[{"category":"AllMetrics","enabled":true}]\'\n\necho ""\necho "=========================================="\necho "Site Recovery Vault Created: ${VAULT_NAME}"\necho "Recovery Region: ${LOCATION}"\necho "=========================================="\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify Recovery Vault\naz backup vault list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --output table\n\n# Check vault properties\naz backup vault backup-properties show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VAULT_NAME}" 2>/dev/null || echo "Vault details not available"\n\n# Verify Storage Account\naz storage account show \\\n  --name "${STORAGE_ACCOUNT}" \\\n  --resource-group "${RESOURCE_GROUP}"\n\n# Verify Virtual Network\naz network vnet show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VNET_NAME}"\n\n# Check Key Vault\naz keyvault show --name "${KEYVAULT}"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Enable replication for simulated VM\necho "To enable replication for a source VM:"\necho "az site-recovery machine replicate --resource-group ${RESOURCE_GROUP} --fabric-name on-premises-fabric --protection-container-name default-container --machine-name source-vm-name --source-machine-id /subscriptions/xxx/resourceGroups/xxx/providers/Microsoft.Compute/virtualMachines/source-vm"\n\n# Operation 2: Create recovery plan\ncat > /tmp/recovery_plan.json <<EOF\n{\n  "name": "production-recovery-plan",\n  "description": "Recovery plan for production VMs",\n  "groups": [\n    {\n      "name": "Tier1-DatabaseServers",\n      "startGroupActions": [],\n      "endGroupActions": [],\n      "replicationProtectedItems": []\n    },\n    {\n      "name": "Tier2-AppServers",\n      "startGroupActions": [],\n      "endGroupActions": [],\n      "replicationProtectedItems": []\n    }\n  ]\n}\nEOF\n\n# Operation 3: Monitor replication health\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.RecoveryServices/vaults/${VAULT_NAME}" \\\n  --metric "ReplicationLatency" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\') 2>/dev/null || echo "Metrics not yet available"\n\n# Operation 4: Check latest recovery points\necho "To check recovery points:"\necho "az site-recovery recovery-point list --fabric-name on-premises-fabric --protection-container-name default-container --replicated-item-name source-vm-name"\n\n# Operation 5: Test failover\necho "To perform test failover:"\necho "az site-recovery machine failover-test --fabric-name on-premises-fabric --protection-container-name default-container --machine-name source-vm-name --network-id /subscriptions/xxx/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Network/virtualNetworks/${VNET_NAME}"\n\n# Operation 6: Perform cleanup of test failover\necho "To cleanup test failover:"\necho "az site-recovery machine failover-test-cleanup --fabric-name on-premises-fabric --protection-container-name default-container --machine-name source-vm-name"\n\n# Operation 7: Commit failover\necho "To commit a failover (after test successful):"\necho "az site-recovery machine failover-commit --fabric-name on-premises-fabric --protection-container-name default-container --machine-name source-vm-name"\n\n# Operation 8: Monitor vault backup jobs\naz backup job list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vault-name "${VAULT_NAME}" \\\n  --output table 2>/dev/null || echo "No backup jobs"\n\n# Operation 9: Configure notification settings\necho "To configure notifications:"\necho "Email notifications can be set up in Azure Portal for replication events"\n\n# Operation 10: Review site recovery logs\naz monitor activity-log list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "[?contains(resourceType, \'RecoveryServices\')].{Time:eventTimestamp, Event:operationName.localizedValue, Status:status.localizedValue}" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Disable replication for protected items\necho "To disable replication:"\necho "az site-recovery machine remove --fabric-name on-premises-fabric --protection-container-name default-container --name source-vm-name"\n\n# Step 2: Delete recovery vault\naz backup vault delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VAULT_NAME}" \\\n  --yes 2>/dev/null || true\n\n# Step 3: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 4: Verify deletion\nsleep 60\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 5: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n\n# Step 6: Clean up local files\nrm -rf /tmp/vault_template.json /tmp/policy_config.json /tmp/protected_vm.json /tmp/recovery_plan.json\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-hybrid-recovery-${UNIQUE_ID}-rg`\n- Recovery Vault: `azurehaymaker-vault-${UNIQUE_ID}`\n- Storage Account: `azmkrsiterecovery${UNIQUE_ID}`\n- Virtual Network: `azurehaymaker-vnet-${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Site Recovery Overview](https://learn.microsoft.com/en-us/azure/site-recovery/site-recovery-overview)\n- [Site Recovery Architecture](https://learn.microsoft.com/en-us/azure/site-recovery/azure-to-azure-architecture)\n- [Replication Process](https://learn.microsoft.com/en-us/azure/site-recovery/site-recovery-replication)\n- [Recovery Plans](https://learn.microsoft.com/en-us/azure/site-recovery/recovery-plan-overview)\n- [Site Recovery CLI Reference](https://learn.microsoft.com/en-us/cli/azure/site-recovery)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI + ARM Templates\n\n**Rationale**: Azure CLI handles vault management while ARM templates configure complex replication policies and recovery plans.\n\n---\n\n## Estimated Duration\n- **Deployment**: 15-20 minutes\n- **Operations Phase**: 8 hours (with replication monitoring and test failovers)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- Replication RPO (Recovery Point Objective) typically 5-15 minutes\n- RTO (Recovery Time Objective) depends on failover complexity\n- Test failovers verify recovery plans without affecting production\n- Network mapping ensures proper connectivity after failover\n- All operations scoped to single tenant and subscription\n- Suitable for business-critical workload protection\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Azure Site Recovery for Disaster Recover...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Azure Site Recovery for Disaster Recover...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-azure-site-agent...")
    print("Goal: Scenario: Azure Site Recovery for Disaster Recovery")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
