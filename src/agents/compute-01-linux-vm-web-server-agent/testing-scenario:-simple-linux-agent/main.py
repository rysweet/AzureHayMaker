#!/usr/bin/env python3
"""
testing-scenario:-simple-linux-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 6,
        "initial_prompt": '# Goal: Scenario: Simple Linux VM Running Nginx Web Server\n\n## Objective\n# Scenario: Simple Linux VM Running Nginx Web Server\n\n## Technology Area\nCompute\n\n## Company Profile\n- **Company Size**: Small startup\n- **Industry**: Technology / SaaS\n- **Use Case**: Deploy a lightweight web server on a Linux VM for internal documentation hosting\n\n## Scenario Description\nDeploy a Linux virtual machine running Ubuntu with nginx web server, configure custom domain resolution, and manage the server through SSH. This scenario covers VM provisioning, network configuration, and HTTP service management.\n\n## Azure Services Used\n- Azure Virtual Machines (Linux - Ubuntu)\n- Azure Network Interfaces\n- Azure Public IP Addresses\n- Azure Network Security Groups\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed and configured\n- SSH key pair generated locally (or one will be created during deployment)\n- Access to create virtual machines and manage network resources\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-compute-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nVM_NAME="azurehaymaker-web-${UNIQUE_ID}"\nNIC_NAME="azurehaymaker-nic-${UNIQUE_ID}"\nNSG_NAME="azurehaymaker-nsg-${UNIQUE_ID}"\nVNET_NAME="azurehaymaker-vnet-${UNIQUE_ID}"\nSUBNET_NAME="azurehaymaker-subnet-${UNIQUE_ID}"\nPUBLIC_IP_NAME="azurehaymaker-pip-${UNIQUE_ID}"\nSSH_KEY_NAME="azurehaymaker-key-${UNIQUE_ID}"\nSTORAGE_ACCOUNT="azurehaymaker${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=compute-linux-vm Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network and Subnet\naz network vnet create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VNET_NAME}" \\\n  --address-prefix 10.0.0.0/16 \\\n  --subnet-name "${SUBNET_NAME}" \\\n  --subnet-prefix 10.0.1.0/24 \\\n  --tags ${TAGS}\n\n# Step 3: Create Network Security Group\naz network nsg create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${NSG_NAME}" \\\n  --tags ${TAGS}\n\n# Step 4: Add security rules for HTTP, HTTPS, and SSH\naz network nsg rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --nsg-name "${NSG_NAME}" \\\n  --name "allow-ssh" \\\n  --priority 1000 \\\n  --source-address-prefixes "*" \\\n  --source-port-ranges "*" \\\n  --destination-address-prefixes "*" \\\n  --destination-port-ranges 22 \\\n  --access Allow \\\n  --protocol Tcp\n\naz network nsg rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --nsg-name "${NSG_NAME}" \\\n  --name "allow-http" \\\n  --priority 1001 \\\n  --source-address-prefixes "*" \\\n  --source-port-ranges "*" \\\n  --destination-address-prefixes "*" \\\n  --destination-port-ranges 80 \\\n  --access Allow \\\n  --protocol Tcp\n\naz network nsg rule create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --nsg-name "${NSG_NAME}" \\\n  --name "allow-https" \\\n  --priority 1002 \\\n  --source-address-prefixes "*" \\\n  --source-port-ranges "*" \\\n  --destination-address-prefixes "*" \\\n  --destination-port-ranges 443 \\\n  --access Allow \\\n  --protocol Tcp\n\n# Step 5: Create Public IP Address\naz network public-ip create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PUBLIC_IP_NAME}" \\\n  --allocation-method Static \\\n  --sku Standard \\\n  --tags ${TAGS}\n\n# Step 6: Create Network Interface\naz network nic create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${NIC_NAME}" \\\n  --vnet-name "${VNET_NAME}" \\\n  --subnet "${SUBNET_NAME}" \\\n  --public-ip-address "${PUBLIC_IP_NAME}" \\\n  --network-security-group "${NSG_NAME}" \\\n  --tags ${TAGS}\n\n# Step 7: Create SSH key pair for authentication\naz sshkey create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${SSH_KEY_NAME}" \\\n  --tags ${TAGS}\n\n# Step 8: Get the SSH public key\nPUBLIC_KEY_PATH=$(az sshkey show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${SSH_KEY_NAME}" \\\n  --query "publicKey" -o tsv)\n\n# Step 9: Create Linux Virtual Machine\naz vm create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --nics "${NIC_NAME}" \\\n  --image UbuntuLTS \\\n  --size Standard_B1s \\\n  --admin-username azureuser \\\n  --ssh-key-name "${SSH_KEY_NAME}" \\\n  --os-disk-name "azurehaymaker-osdisk-${UNIQUE_ID}" \\\n  --tags ${TAGS}\n\n# Step 10: Get the Public IP Address\nPUBLIC_IP=$(az network public-ip show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${PUBLIC_IP_NAME}" \\\n  --query ipAddress -o tsv)\n\necho "Public IP Address: ${PUBLIC_IP}"\n\n# Step 11: Run custom script to install and configure nginx\naz vm run-command invoke \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --command-id RunShellScript \\\n  --scripts "sudo apt-get update && sudo apt-get install -y nginx && sudo systemctl start nginx && sudo systemctl enable nginx"\n\n# Step 12: Create a custom index page\naz vm run-command invoke \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --command-id RunShellScript \\\n  --scripts "sudo tee /var/www/html/index.html > /dev/null <<\'EOF\'\n<!DOCTYPE html>\n<html>\n<head>\n  <title>Azure HayMaker - Linux VM Nginx Server</title>\n  <style>\n    body { font-family: Arial, sans-serif; margin: 50px; }\n    .container { max-width: 600px; margin: 0 auto; }\n  </style>\n</head>\n<body>\n  <div class=\\"container\\">\n    <h1>Azure HayMaker - Linux VM Web Server</h1>\n    <p><strong>Scenario:</strong> compute-01-linux-vm-web-server</p>\n    <p><strong>Hostname:</strong> $(hostname)</p>\n    <p><strong>OS:</strong> $(lsb_release -ds)</p>\n    <p><strong>Nginx Version:</strong> $(nginx -v 2>&1)</p>\n    <p><strong>Timestamp:</strong> $(date)</p>\n    <hr>\n    <p>This server is running on an Azure Linux VM with nginx web server.</p>\n  </div>\n</body>\n</html>\nEOF"\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# Verify Virtual Machine\naz vm show --resource-group "${RESOURCE_GROUP}" --name "${VM_NAME}" --query "powerState" -o tsv\n\n# Verify Network Interface\naz network nic show --resource-group "${RESOURCE_GROUP}" --name "${NIC_NAME}"\n\n# Verify Public IP\naz network public-ip show --resource-group "${RESOURCE_GROUP}" --name "${PUBLIC_IP_NAME}"\n\n# Verify Network Security Group Rules\naz network nsg rule list --resource-group "${RESOURCE_GROUP}" --nsg-name "${NSG_NAME}" --output table\n\n# Test HTTP connectivity\necho "Testing HTTP connection to ${PUBLIC_IP}..."\ncurl -I "http://${PUBLIC_IP}" || echo "Note: May need to wait a moment for nginx to fully initialize"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Check VM performance metrics\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Compute/virtualMachines/${VM_NAME}" \\\n  --metric "Percentage CPU" \\\n  --start-time $(date -u -d \'30 minutes ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 2: Check disk I/O metrics\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Compute/virtualMachines/${VM_NAME}" \\\n  --metric "Disk Read Bytes" \\\n  --start-time $(date -u -d \'30 minutes ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 3: Check VM network metrics\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.Compute/virtualMachines/${VM_NAME}" \\\n  --metric "Network In Total" \\\n  --start-time $(date -u -d \'30 minutes ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\')\n\n# Operation 4: Restart the VM\naz vm restart --resource-group "${RESOURCE_GROUP}" --name "${VM_NAME}" --no-wait\n\n# Operation 5: Deallocate VM (stop and release compute resources)\naz vm deallocate --resource-group "${RESOURCE_GROUP}" --name "${VM_NAME}" --no-wait\n\n# Operation 6: Start the deallocated VM\naz vm start --resource-group "${RESOURCE_GROUP}" --name "${VM_NAME}" --no-wait\n\n# Operation 7: Update custom content on web server\naz vm run-command invoke \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --command-id RunShellScript \\\n  --scripts "sudo tee /var/www/html/info.html > /dev/null <<\'EOF\'\n<!DOCTYPE html>\n<html>\n<head>\n  <title>System Information</title>\n</head>\n<body>\n  <h1>System Information</h1>\n  <p>Last updated: $(date)</p>\n  <p>Uptime: $(uptime)</p>\n  <p>Disk usage: $(df -h / | tail -1)</p>\n  <p>Memory: $(free -h | grep Mem)</p>\n</body>\n</html>\nEOF"\n\n# Operation 8: Check disk usage on VM\naz vm run-command invoke \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --command-id RunShellScript \\\n  --scripts "df -h && echo \'---\' && du -sh /var/www/"\n\n# Operation 9: Verify nginx status\naz vm run-command invoke \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --command-id RunShellScript \\\n  --scripts "sudo systemctl status nginx"\n\n# Operation 10: View nginx access logs\naz vm run-command invoke \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${VM_NAME}" \\\n  --command-id RunShellScript \\\n  --scripts "sudo tail -20 /var/log/nginx/access.log"\n\n# Operation 11: Modify VM size (scale up)\naz vm resize --resource-group "${RESOURCE_GROUP}" --name "${VM_NAME}" --size Standard_B2s\n\n# Operation 12: View VM details and configuration\naz vm show --resource-group "${RESOURCE_GROUP}" --name "${VM_NAME}" --output table\n\n# Operation 13: List all network interfaces attached to VM\naz vm open-port --resource-group "${RESOURCE_GROUP}" --name "${VM_NAME}" --port 8080 --priority 1003\n\n# Operation 14: Add a new data disk to the VM\nDATA_DISK_NAME="azurehaymaker-datadisk-${UNIQUE_ID}"\naz disk create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "${DATA_DISK_NAME}" \\\n  --size-gb 10 \\\n  --tags ${TAGS}\n\naz vm disk attach \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --vm-name "${VM_NAME}" \\\n  --name "${DATA_DISK_NAME}"\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete the entire resource group (includes VM, NICs, storage, etc.)\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 2: Wait for deletion to complete\necho "Waiting for resource group deletion..."\nsleep 120\n\n# Step 3: Verify deletion\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 4: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-compute-${UNIQUE_ID}-rg`\n- Virtual Machine: `azurehaymaker-web-${UNIQUE_ID}`\n- Network Interface: `azurehaymaker-nic-${UNIQUE_ID}`\n- Network Security Group: `azurehaymaker-nsg-${UNIQUE_ID}`\n- Virtual Network: `azurehaymaker-vnet-${UNIQUE_ID}`\n- Public IP: `azurehaymaker-pip-${UNIQUE_ID}`\n- SSH Key: `azurehaymaker-key-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Virtual Machines Overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)\n- [Create Linux Virtual Machine with Azure CLI](https://learn.microsoft.com/en-us/azure/virtual-machines/linux/quick-create-cli)\n- [Azure Network Security Groups](https://learn.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview)\n- [SSH Keys in Azure](https://learn.microsoft.com/en-us/azure/virtual-machines/linux/ssh-keys-portal)\n- [Azure Virtual Machine CLI Reference](https://learn.microsoft.com/en-us/cli/azure/vm)\n- [Nginx Web Server Documentation](https://nginx.org/en/docs/)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive VM management capabilities with straightforward commands for provisioning, configuration, and monitoring. The direct command approach is ideal for this straightforward infrastructure scenario.\n\n---\n\n## Estimated Duration\n- **Deployment**: 15-20 minutes\n- **Operations Phase**: 8+ hours (with monitoring, updates, and maintenance)\n- **Cleanup**: 5-10 minutes\n\n---\n\n## Notes\n- SSH key is managed by Azure and securely stored\n- VM runs Ubuntu LTS for long-term support and stability\n- nginx is installed and configured to auto-start on VM reboot\n- Public IP allows direct HTTP/HTTPS access from the internet\n- NSG rules restrict traffic to necessary ports (SSH, HTTP, HTTPS)\n- All operations scoped to single tenant and subscription\n- Operations demonstrate VM lifecycle management including start/stop/resize\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 5 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal \'Scenario: Simple Linux VM Running Nginx Web Server...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Simple Linux VM Running Nginx Web Server...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting testing-scenario:-simple-linux-agent...")
    print("Goal: Scenario: Simple Linux VM Running Nginx Web Server")
    print("Estimated duration: 22 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
