#!/usr/bin/env python3
"""
deployment-scenario:-azure-arc-agent - Autonomous Goal-Seeking Agent

Generated by Amplihack Goal Agent Generator
"""

import sys
from pathlib import Path

# Add parent directory to path for amplihack imports
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from amplihack.launcher.auto_mode import AutoMode
except ImportError:
    print("Error: amplihack package not found")
    print("Install with: pip install amplihack")
    sys.exit(1)


def main():
    """Execute the goal-seeking agent."""
    # Load configuration
    config = {
        "max_turns": 18,
        "initial_prompt": '# Goal: Scenario: Azure Arc for Hybrid Server Management\n\n## Objective\n# Scenario: Azure Arc for Hybrid Server Management\n\n## Technology Area\nHybrid+Multicloud\n\n## Company Profile\n- **Company Size**: Large enterprise\n- **Industry**: Financial Services\n- **Use Case**: Manage on-premises and multicloud servers with unified Azure control plane\n\n## Scenario Description\nDeploy Azure Arc to connect on-premises servers and cloud VMs into a unified management experience. Apply policies, deploy agents, and monitor resources across hybrid infrastructure.\n\n## Azure Services Used\n- Azure Arc (hybrid server management)\n- Azure Policy (governance)\n- Azure Monitor (centralized monitoring)\n- Azure Key Vault (secrets management)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed\n- Virtual machines (on-premises or cloud)\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP="azurehaymaker-hybrid-arc-${UNIQUE_ID}-rg"\nLOCATION="eastus"\nSERVICE_PRINCIPAL_NAME="azurehaymaker-arc-${UNIQUE_ID}"\nKEYVAULT="azurehaymaker-kv-${UNIQUE_ID}"\n\n# Tags\nTAGS="AzureHayMaker-managed=true Scenario=hybrid-azure-arc Owner=AzureHayMaker"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Step 2: Create Service Principal for Arc agents\nSP_OUTPUT=$(az ad sp create-for-rbac \\\n  --name "${SERVICE_PRINCIPAL_NAME}" \\\n  --role "Azure Connected Machine Onboarding" \\\n  --scopes "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}")\n\nSP_CLIENT_ID=$(echo ${SP_OUTPUT} | jq -r \'.appId\')\nSP_TENANT_ID=$(echo ${SP_OUTPUT} | jq -r \'.tenant\')\nSP_PASSWORD=$(echo ${SP_OUTPUT} | jq -r \'.password\')\n\n# Step 3: Create Key Vault\naz keyvault create \\\n  --name "${KEYVAULT}" \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --location "${LOCATION}" \\\n  --tags ${TAGS}\n\n# Store SP credentials\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "arc-client-id" \\\n  --value "${SP_CLIENT_ID}"\n\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "arc-client-secret" \\\n  --value "${SP_PASSWORD}"\n\naz keyvault secret set \\\n  --vault-name "${KEYVAULT}" \\\n  --name "arc-tenant-id" \\\n  --value "${SP_TENANT_ID}"\n\n# Step 4: Create sample script for Arc agent installation\ncat > /tmp/arc_installation_script.sh <<EOF\n#!/bin/bash\n\n# Azure Arc Connected Machine Agent Installation Script\n\n# Variables\nCLIENT_ID="${SP_CLIENT_ID}"\nCLIENT_SECRET="${SP_PASSWORD}"\nTENANT_ID="${SP_TENANT_ID}"\nSUBSCRIPTION_ID="$(az account show --query id -o tsv)"\nRESOURCE_GROUP="${RESOURCE_GROUP}"\nLOCATION="${LOCATION}"\nRESOURCE_NAME="hybrid-vm-\\$(hostname)"\n\n# Download and install Azure Connected Machine Agent\n# For Ubuntu/Debian\nif [ -f /etc/os-release ]; then\n    . /etc/os-release\n    if [ "\\$ID" = "ubuntu" ] || [ "\\$ID" = "debian" ]; then\n        apt-get update\n        apt-get install -y azcmagent\n    fi\nfi\n\n# Connect machine to Azure Arc\nazcmagent connect \\\n    --service-principal-id "\\${CLIENT_ID}" \\\n    --service-principal-secret "\\${CLIENT_SECRET}" \\\n    --resource-group "\\${RESOURCE_GROUP}" \\\n    --tenant-id "\\${TENANT_ID}" \\\n    --location "\\${LOCATION}" \\\n    --subscription-id "\\${SUBSCRIPTION_ID}" \\\n    --resource-name "\\${RESOURCE_NAME}"\n\n# Verify connection\nazcmagent show\nEOF\n\nchmod +x /tmp/arc_installation_script.sh\n\n# Step 5: Create onboarding script for Windows\ncat > /tmp/arc_onboard.ps1 <<EOF\n# Azure Arc Connected Machine Agent Installation for Windows\n\nparam(\n    [Parameter(Mandatory=\\$true)]\n    [string]\\$ClientId,\n\n    [Parameter(Mandatory=\\$true)]\n    [string]\\$ClientSecret,\n\n    [Parameter(Mandatory=\\$true)]\n    [string]\\$TenantId\n)\n\n# Download agent\n\\$URL = "https://aka.ms/dependencyagentwindows"\n\\$Path = "C:\\temp\\InstallDependencyAgent-Windows-x64.exe"\n\nif ((Test-Path C:\\temp) -eq 0) {\n    New-Item -Path C:\\temp -ItemType Directory\n}\n\nInvoke-WebRequest -Uri \\$URL -OutFile \\$Path\n\n# Install agent\nStart-Process -FilePath \\$Path -ArgumentList "/S /AcceptLicense" -Wait\n\n# Connect to Azure Arc\necho "Connecting to Azure Arc..."\n\nEOF\n\n# Step 6: Create diagnostic script\ncat > /tmp/arc_diagnostics.sh <<EOF\n#!/bin/bash\n\necho "=== Azure Arc Agent Diagnostics ==="\n\n# Check agent status\necho "Agent Status:"\nazcmagent show\n\n# Check agent logs\necho -e "\\nAgent Logs:"\ntail -20 /var/opt/azcmagent/log/azcmagent.log 2>/dev/null || echo "Log file not found"\n\n# Check connectivity\necho -e "\\nConnectivity Test:"\ncurl -s https://management.azure.com/version\n\necho -e "\\n=== Diagnostics Complete ==="\nEOF\n\nchmod +x /tmp/arc_diagnostics.sh\n\n# Step 7: Create sample Arc-connected servers (simulated)\n# In real scenario, these would be actual on-premises or multicloud servers\n\nfor i in {1..3}; do\n  MACHINE_NAME="hybrid-server-${i}"\n\n  # Register Arc machine (simulated - actual servers would run agent)\n  az connectedmachine machine create \\\n    --resource-group "${RESOURCE_GROUP}" \\\n    --name "${MACHINE_NAME}" \\\n    --location "${LOCATION}" \\\n    --os-profile osName="Linux" osVersion="Ubuntu 20.04" \\\n    --machine-type "Physical" \\\n    --tags ${TAGS} 2>/dev/null || true\ndone\n\n# Step 8: Create Azure Policy for Arc resources\ncat > /tmp/arc_policy.json <<EOF\n{\n  "mode": "All",\n  "policyRule": {\n    "if": {\n      "field": "type",\n      "equals": "Microsoft.HybridCompute/machines"\n    },\n    "then": {\n      "effect": "audit",\n      "details": {}\n    }\n  }\n}\nEOF\n\n# Step 9: Assign monitoring extension to Arc machines\necho "To assign extensions to Arc machines:"\necho "az connectedmachine extension create --resource-group ${RESOURCE_GROUP} --machine-name <machine-name> --name MonitoringAgent --type MicrosoftMonitoringAgent"\n\n# Step 10: Create Activity Log Alert for Arc resources\naz monitor activity-log alert create \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "arc-connection-alert" \\\n  --condition \\\n    category=Administrative \\\n    operationName="Microsoft.HybridCompute/machines/write" \\\n  --scope "/subscriptions/$(az account show --query id -o tsv)" \\\n  --location "global" \\\n  --tags ${TAGS}\n\necho ""\necho "=========================================="\necho "Azure Arc Setup Created: ${RESOURCE_GROUP}"\necho "Service Principal: ${SERVICE_PRINCIPAL_NAME}"\necho "=========================================="\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name "${RESOURCE_GROUP}"\n\n# List Arc-connected machines\naz connectedmachine machine list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --output table\n\n# Show machine details\naz connectedmachine machine show \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "hybrid-server-1" 2>/dev/null || echo "Machine not yet connected"\n\n# List extensions deployed\naz connectedmachine extension list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --machine-name "hybrid-server-1" 2>/dev/null || echo "No extensions yet"\n\n# Verify Service Principal\naz ad sp show --id "${SP_CLIENT_ID}"\n\n# Check Key Vault\naz keyvault show --name "${KEYVAULT}"\n\n# List all resources\naz resource list --resource-group "${RESOURCE_GROUP}" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Deploy monitoring extension\necho "To deploy Log Analytics agent to Arc machine:"\necho "az connectedmachine extension create --resource-group ${RESOURCE_GROUP} --machine-name hybrid-server-1 --name AzureMonitorLinuxAgent --type AzureMonitorLinuxAgent --publisher Microsoft.Azure.Monitor --enable-auto-upgrade"\n\n# Operation 2: Check Arc machine connectivity status\nfor machine in $(az connectedmachine machine list --resource-group "${RESOURCE_GROUP}" --query "[].name" -o tsv); do\n  echo "Machine: $machine"\n  az connectedmachine machine show --resource-group "${RESOURCE_GROUP}" --name "$machine" --query "status" -o tsv 2>/dev/null || echo "Status: Not connected"\ndone\n\n# Operation 3: List all extensions\necho "Available Arc extensions:"\naz connectedmachine extension-metadata list --machine-type "Linux" --output table 2>/dev/null || echo "Extension metadata not available"\n\n# Operation 4: Create Azure Policy assignment\necho "To assign policies to Arc resources:"\necho "az policy assignment create --name \'audit-arc-machines\' --policy AuditMachinesWithoutRequiredTools --resource-group ${RESOURCE_GROUP}"\n\n# Operation 5: Monitor Arc machine metrics\naz monitor metrics list \\\n  --resource "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.HybridCompute/machines/hybrid-server-1" \\\n  --metric "CPU%" \\\n  --start-time $(date -u -d \'1 hour ago\' \'+%Y-%m-%dT%H:%M:%SZ\') \\\n  --end-time $(date -u \'+%Y-%m-%dT%H:%M:%SZ\') 2>/dev/null || echo "Metrics not yet available"\n\n# Operation 6: Check Arc agent version\necho "Arc Agent Information:"\necho "For connected machines, check via: azcmagent version"\n\n# Operation 7: List activity logs for Arc\naz monitor activity-log list \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --caller-identity "Microsoft.HybridCompute" \\\n  --output table\n\n# Operation 8: Verify Arc machine tags\naz connectedmachine machine update \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "hybrid-server-1" \\\n  --tags Environment=production Department=IT 2>/dev/null || echo "Update skipped"\n\n# Operation 9: Enable log collection\necho "To enable log collection:"\necho "az connectedmachine extension create --resource-group ${RESOURCE_GROUP} --machine-name hybrid-server-1 --name CustomScriptExtension"\n\n# Operation 10: Review Arc onboarding status\naz connectedmachine machine list-by-resource-group \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --query "[].{Name:name, Status:status, OSName:osProfile.osName}" \\\n  --output table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete registered machines\nfor machine in $(az connectedmachine machine list --resource-group "${RESOURCE_GROUP}" --query "[].name" -o tsv); do\n  az connectedmachine machine delete \\\n    --resource-group "${RESOURCE_GROUP}" \\\n    --name "$machine" \\\n    --yes 2>/dev/null || true\ndone\n\n# Step 2: Delete activity log alert\naz monitor activity-log alert delete \\\n  --resource-group "${RESOURCE_GROUP}" \\\n  --name "arc-connection-alert" \\\n  --yes 2>/dev/null || true\n\n# Step 3: Delete Service Principal\naz ad sp delete --id "${SP_CLIENT_ID}"\n\n# Step 4: Delete the entire resource group\naz group delete \\\n  --name "${RESOURCE_GROUP}" \\\n  --yes \\\n  --no-wait\n\n# Step 5: Verify deletion\nsleep 60\naz group exists --name "${RESOURCE_GROUP}"\n\n# Step 6: Confirm cleanup\necho "Verifying cleanup..."\naz resource list --resource-group "${RESOURCE_GROUP}" 2>&1 | grep "could not be found" && echo "âœ“ Resource group successfully deleted"\n\n# Step 7: Clean up local files\nrm -rf /tmp/arc_*.sh /tmp/arc_*.ps1 /tmp/arc_policy.json\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-hybrid-arc-${UNIQUE_ID}-rg`\n- Service Principal: `azurehaymaker-arc-${UNIQUE_ID}`\n- Machines: `hybrid-server-1`, `hybrid-server-2`, `hybrid-server-3`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Arc Overview](https://learn.microsoft.com/en-us/azure/azure-arc/overview)\n- [Azure Arc Servers](https://learn.microsoft.com/en-us/azure/azure-arc/servers/overview)\n- [Onboarding Connected Machines](https://learn.microsoft.com/en-us/azure/azure-arc/servers/onboard-portal)\n- [Arc Extensions](https://learn.microsoft.com/en-us/azure/azure-arc/servers/manage-extensions)\n- [Azure Arc CLI Reference](https://learn.microsoft.com/en-us/cli/azure/connectedmachine)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI + Shell Scripts\n\n**Rationale**: Azure CLI manages Arc resources while shell scripts handle agent installation on connected servers. This combination enables comprehensive hybrid management.\n\n---\n\n## Estimated Duration\n- **Deployment**: 10-15 minutes (agent installation takes longer on actual servers)\n- **Operations Phase**: 8 hours (with monitoring and policy management)\n- **Cleanup**: 5 minutes\n\n---\n\n## Notes\n- Arc agents enable unified management of on-premises and cloud servers\n- Supports Linux and Windows operating systems\n- Policy compliance enforcement across hybrid infrastructure\n- Centralized monitoring with Azure Monitor\n- All operations scoped to single tenant and subscription\n- Network connectivity required for agent communication\n- Suitable for enterprises with distributed infrastructure\n\n\n## Execution Plan\n\n### Phase 1: Pre-deployment\nPrepare for deployment\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: validation, backup\n\n### Phase 2: Deployment\nDeploy to target environment\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: deployment, monitoring\n**Dependencies**: Pre-deployment\n\n### Phase 3: Verification\nVerify deployment success\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: verification, health-check\n**Dependencies**: Deployment\n\n### Phase 4: Post-deployment\nComplete deployment tasks\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: cleanup, documentation\n**Dependencies**: Verification\n\n## Success Criteria\n- Goal \'Scenario: Azure Arc for Hybrid Server Management...\' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion',
        "working_dir": ".",
        "sdk": "claude",
        "ui_mode": False,
        "success_criteria": [
            "Goal 'Scenario: Azure Arc for Hybrid Server Management...' is achieved"
        ],
        "constraints": [],
    }

    # Read initial prompt
    prompt_path = Path(__file__).parent / "prompt.md"
    if not prompt_path.exists():
        print("Error: prompt.md not found")
        sys.exit(1)

    initial_prompt = prompt_path.read_text()

    # Create auto-mode instance
    auto_mode = AutoMode(
        sdk=config.get("sdk", "claude"),
        prompt=initial_prompt,
        max_turns=config.get("max_turns", 10),
        working_dir=Path(__file__).parent,
        ui_mode=config.get("ui_mode", False),
    )

    # Run agent
    print("Starting deployment-scenario:-azure-arc-agent...")
    print("Goal: Scenario: Azure Arc for Hybrid Server Management")
    print("Estimated duration: 2 hours 36 minutes")
    print()

    exit_code = auto_mode.run()

    if exit_code == 0:
        print("\nGoal achieved successfully!")
    else:
        print(f"\nGoal execution failed with code {exit_code}")

    return exit_code


if __name__ == "__main__":
    sys.exit(main())
