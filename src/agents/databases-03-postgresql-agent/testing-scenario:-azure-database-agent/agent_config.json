{
  "bundle_id": "8009b255-5a08-482d-9dae-c6ad25719ba9",
  "name": "testing-scenario:-azure-database-agent",
  "version": "1.0.0",
  "metadata": {
    "domain": "testing",
    "complexity": "complex",
    "phase_count": 4,
    "skill_count": 2,
    "estimated_duration": "2 hours 36 minutes",
    "required_capabilities": [
      "reporting",
      "test-coding",
      "framework-setup",
      "test-design",
      "automation",
      "test-execution",
      "analysis",
      "planning"
    ],
    "skill_names": [
      "tester",
      "documenter"
    ],
    "parallel_opportunities": 0,
    "risk_factors": [
      "High complexity may require extended execution time"
    ]
  },
  "auto_mode_config": {
    "max_turns": 18,
    "initial_prompt": "# Goal: Scenario: Azure Database for PostgreSQL\n\n## Objective\n# Scenario: Azure Database for PostgreSQL\n\n## Technology Area\nDatabases\n\n## Company Profile\n- **Company Size**: Mid-size technology company\n- **Industry**: SaaS / Analytics\n- **Use Case**: Host PostgreSQL databases for multi-tenant SaaS applications\n\n## Scenario Description\nDeploy Azure Database for PostgreSQL with flexible server, configure high availability, set up read replicas for analytics workloads, and implement backup strategy with point-in-time restore.\n\n## Azure Services Used\n- Azure Database for PostgreSQL (Flexible Server)\n- Azure Virtual Network (network integration)\n- Azure Key Vault (connection strings)\n- Azure Monitor (logging and metrics)\n\n## Prerequisites\n- Azure subscription with Contributor role\n- Azure CLI installed\n- A unique identifier for this scenario run\n\n---\n\n## Phase 1: Deployment and Validation\n\n### Environment Setup\n```bash\n# Set variables\nUNIQUE_ID=$(date +%Y%m%d%H%M%S)\nRESOURCE_GROUP=\"azurehaymaker-db-postgres-${UNIQUE_ID}-rg\"\nLOCATION=\"eastus\"\nPOSTGRES_SERVER=\"azurehaymaker-postgres-${UNIQUE_ID}\"\nPOSTGRES_ADMIN_USER=\"pgadmin\"\nPOSTGRES_ADMIN_PASSWORD=\"P@ssw0rd!${UNIQUE_ID}Aa\"\nVNET_NAME=\"azurehaymaker-vnet-${UNIQUE_ID}\"\nKEYVAULT=\"azurehaymaker-kv-${UNIQUE_ID}\"\n\n# Tags\nTAGS=\"AzureHayMaker-managed=true Scenario=databases-postgres Owner=AzureHayMaker\"\n```\n\n### Deployment Steps\n```bash\n# Step 1: Create Resource Group\naz group create \\\n  --name \"${RESOURCE_GROUP}\" \\\n  --location \"${LOCATION}\" \\\n  --tags ${TAGS}\n\n# Step 2: Create Virtual Network\naz network vnet create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${VNET_NAME}\" \\\n  --address-prefix \"10.0.0.0/16\" \\\n  --subnet-name \"postgres-subnet\" \\\n  --subnet-prefixes \"10.0.0.0/24\" \\\n  --tags ${TAGS}\n\nSUBNET_ID=$(az network vnet subnet show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --vnet-name \"${VNET_NAME}\" \\\n  --name \"postgres-subnet\" \\\n  --query id -o tsv)\n\n# Step 3: Create Key Vault\naz keyvault create \\\n  --name \"${KEYVAULT}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --location \"${LOCATION}\" \\\n  --tags ${TAGS}\n\n# Step 4: Create PostgreSQL Flexible Server\naz postgres flexible-server create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --location \"${LOCATION}\" \\\n  --admin-user \"${POSTGRES_ADMIN_USER}\" \\\n  --admin-password \"${POSTGRES_ADMIN_PASSWORD}\" \\\n  --sku-name \"Standard_B1ms\" \\\n  --tier \"Burstable\" \\\n  --storage-size 32 \\\n  --version 14 \\\n  --vnet \"${VNET_NAME}\" \\\n  --subnet \"postgres-subnet\" \\\n  --high-availability \"Enabled\" \\\n  --backup-retention 7 \\\n  --tags ${TAGS}\n\n# Step 5: Configure firewall rules\naz postgres flexible-server firewall-rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --rule-name \"AllowAzureServices\" \\\n  --start-ip-address 0.0.0.0 \\\n  --end-ip-address 0.0.0.0\n\n# Step 6: Create databases\naz postgres flexible-server db create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --database-name \"tenantdb\"\n\naz postgres flexible-server db create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --database-name \"analyticsdb\"\n\naz postgres flexible-server db create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --database-name \"configdb\"\n\n# Step 7: Configure server parameters\naz postgres flexible-server parameter set \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --name \"max_connections\" \\\n  --value 200\n\naz postgres flexible-server parameter set \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --name \"shared_buffers\" \\\n  --value 262144\n\naz postgres flexible-server parameter set \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --name \"log_statement\" \\\n  --value \"all\"\n\n# Step 8: Get connection string\nPOSTGRES_ENDPOINT=\"${POSTGRES_SERVER}.postgres.database.azure.com\"\nPOSTGRES_CONNECTION_STRING=\"postgresql://${POSTGRES_ADMIN_USER}:${POSTGRES_ADMIN_PASSWORD}@${POSTGRES_ENDPOINT}:5432/tenantdb?sslmode=require\"\n\n# Store in Key Vault\naz keyvault secret set \\\n  --vault-name \"${KEYVAULT}\" \\\n  --name \"postgres-connection-string\" \\\n  --value \"${POSTGRES_CONNECTION_STRING}\"\n\n# Step 9: Create read replica for analytics\naz postgres flexible-server replica create \\\n  --name \"${POSTGRES_SERVER}-replica\" \\\n  --source-server \"${POSTGRES_SERVER}\" \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --location \"${LOCATION}\"\n\n# Step 10: Configure backup retention and PITR\naz postgres flexible-server update \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --backup-retention 7 \\\n  --geo-redundant-backup Disabled\n\necho \"\"\necho \"==========================================\"\necho \"PostgreSQL Server Created: ${POSTGRES_SERVER}\"\necho \"Endpoint: ${POSTGRES_ENDPOINT}\"\necho \"Databases: tenantdb, analyticsdb, configdb\"\necho \"Read Replica: ${POSTGRES_SERVER}-replica\"\necho \"==========================================\"\n```\n\n### Validation\n```bash\n# Verify Resource Group\naz group show --name \"${RESOURCE_GROUP}\"\n\n# Verify PostgreSQL Server\naz postgres flexible-server show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\"\n\n# Check server state\naz postgres flexible-server show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --query \"state\" -o tsv\n\n# List databases\naz postgres flexible-server db list \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --output table\n\n# List parameters\naz postgres flexible-server parameter list \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --output table\n\n# Check read replica\naz postgres flexible-server show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}-replica\"\n\n# List firewall rules\naz postgres flexible-server firewall-rule list \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --output table\n\n# List all resources\naz resource list --resource-group \"${RESOURCE_GROUP}\" --output table\n```\n\n---\n\n## Phase 2: Mid-Day Operations and Management\n\n### Management Operations\n```bash\n# Operation 1: Create new database for new tenant\naz postgres flexible-server db create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --database-name \"tenant_newclient\"\n\n# Operation 2: Update server parameters\naz postgres flexible-server parameter set \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --name \"max_prepared_transactions\" \\\n  --value 100\n\n# Operation 3: Create on-demand backup\naz postgres flexible-server backup create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --backup-name \"manual-backup-$(date +%Y%m%d-%H%M%S)\"\n\n# Operation 4: List available backups\naz postgres flexible-server backup list \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --output table\n\n# Operation 5: Monitor server metrics\naz monitor metrics list \\\n  --resource \"/subscriptions/$(az account show --query id -o tsv)/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.DBforPostgreSQL/flexibleServers/${POSTGRES_SERVER}\" \\\n  --metric \"cpu_percent\" \\\n  --start-time $(date -u -d '1 hour ago' '+%Y-%m-%dT%H:%M:%SZ') \\\n  --end-time $(date -u '+%Y-%m-%dT%H:%M:%SZ')\n\n# Operation 6: Check storage usage\naz postgres flexible-server show \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --query \"{StorageGB:storage.storageSizeGB}\"\n\n# Operation 7: Restart server\naz postgres flexible-server restart \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\"\n\n# Operation 8: Add temporary firewall rule for admin access\nMY_IP=$(curl -s ifconfig.me)\naz postgres flexible-server firewall-rule create \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --rule-name \"AdminAccess-$(date +%Y%m%d)\" \\\n  --start-ip-address \"${MY_IP}\" \\\n  --end-ip-address \"${MY_IP}\"\n\n# Operation 9: Remove temporary firewall rule\naz postgres flexible-server firewall-rule delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --rule-name \"AdminAccess-$(date +%Y%m%d)\" \\\n  --yes 2>/dev/null || true\n\n# Operation 10: List all databases with sizes\naz postgres flexible-server db list \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --server-name \"${POSTGRES_SERVER}\" \\\n  --query \"[].name\" -o table\n```\n\n---\n\n## Phase 3: Cleanup and Tear-Down\n\n### Cleanup Steps\n```bash\n# Step 1: Delete read replica\naz postgres flexible-server delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}-replica\" \\\n  --yes\n\n# Step 2: Wait for replica deletion\nsleep 60\n\n# Step 3: Delete PostgreSQL server\naz postgres flexible-server delete \\\n  --resource-group \"${RESOURCE_GROUP}\" \\\n  --name \"${POSTGRES_SERVER}\" \\\n  --yes\n\n# Step 4: Delete the entire resource group\naz group delete \\\n  --name \"${RESOURCE_GROUP}\" \\\n  --yes \\\n  --no-wait\n\n# Step 5: Verify deletion\nsleep 120\naz group exists --name \"${RESOURCE_GROUP}\"\n\n# Step 6: Confirm cleanup\necho \"Verifying cleanup...\"\naz resource list --resource-group \"${RESOURCE_GROUP}\" 2>&1 | grep \"could not be found\" && echo \"\u2713 Resource group successfully deleted\"\n```\n\n---\n\n## Resource Naming Convention\n- Resource Group: `azurehaymaker-db-postgres-${UNIQUE_ID}-rg`\n- PostgreSQL Server: `azurehaymaker-postgres-${UNIQUE_ID}`\n- Read Replica: `${POSTGRES_SERVER}-replica`\n- Databases: `tenantdb`, `analyticsdb`, `configdb`\n- Virtual Network: `azurehaymaker-vnet-${UNIQUE_ID}`\n- Key Vault: `azurehaymaker-kv-${UNIQUE_ID}`\n\nAll resources tagged with: `AzureHayMaker-managed=true`\n\n---\n\n## Documentation References\n- [Azure Database for PostgreSQL](https://learn.microsoft.com/en-us/azure/postgresql/)\n- [PostgreSQL Flexible Server](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/)\n- [High Availability](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-high-availability)\n- [Read Replicas](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-read-replicas)\n- [PostgreSQL CLI Reference](https://learn.microsoft.com/en-us/cli/azure/postgres)\n\n---\n\n## Automation Tool\n**Recommended**: Azure CLI\n\n**Rationale**: Azure CLI provides comprehensive PostgreSQL management capabilities. Flexible Server model offers better performance and management than previous generations.\n\n---\n\n## Estimated Duration\n- **Deployment**: 20-25 minutes (HA and replica setup)\n- **Operations Phase**: 8 hours (with database management and monitoring)\n- **Cleanup**: 10-15 minutes\n\n---\n\n## Notes\n- High availability provides automatic failover\n- Read replicas enable scaling of read-heavy workloads\n- Point-in-time restore enables disaster recovery\n- Multi-tier backup strategy with geo-redundancy available\n- All operations scoped to single tenant and subscription\n- Supports multi-tenant database patterns\n- Flexible server tier offers better performance\n\n\n## Execution Plan\n\n### Phase 1: Test Planning\nPlan test strategy\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-design, planning\n\n### Phase 2: Test Implementation\nImplement test cases\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-coding, framework-setup\n**Dependencies**: Test Planning\n\n### Phase 3: Test Execution\nRun test suite\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: test-execution, automation\n**Dependencies**: Test Implementation\n\n### Phase 4: Results Analysis\nAnalyze test results\n**Estimated Duration**: 30 minutes\n**Required Capabilities**: analysis, reporting\n**Dependencies**: Test Execution\n\n## Success Criteria\n- Goal 'Scenario: Azure Database for PostgreSQL...' is achieved\n\n## Instructions\nExecute the plan above autonomously:\n1. Follow each phase in sequence\n2. Use available skills and tools\n3. Verify success criteria are met\n4. Report progress and completion",
    "working_dir": ".",
    "sdk": "claude",
    "ui_mode": false,
    "success_criteria": [
      "Goal 'Scenario: Azure Database for PostgreSQL...' is achieved"
    ],
    "constraints": []
  }
}
