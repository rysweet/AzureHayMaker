name: Deploy to Development

on:
  push:
    branches:
      - develop
    paths:
      - 'src/**'
      - 'infra/**'
      - '.github/workflows/deploy-dev.yml'
  workflow_dispatch:

permissions:
  id-token: write  # Required for OIDC authentication
  contents: read

env:
  ENVIRONMENT: dev
  AZURE_REGION: ${{ secrets.AZURE_LOCATION }}

jobs:
  validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep templates
        run: |
          az bicep build --file infra/bicep/main.bicep
          echo "Bicep templates compiled successfully"

      - name: Validate deployment
        run: |
          # Get the Object ID for the service principal (required for RBAC)
          SP_OBJECT_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)

          VALIDATION_NAME="haymaker-dev-validation-$(date +%Y%m%d-%H%M%S)"
          az deployment sub validate \
            --name "$VALIDATION_NAME" \
            --location ${{ env.AZURE_REGION }} \
            --template-file infra/bicep/main.bicep \
            --parameters infra/bicep/parameters/dev.bicepparam \
            --parameters adminObjectIds="['$SP_OBJECT_ID']" \
            --parameters githubOidcClientId="${{ secrets.AZURE_CLIENT_ID }}"

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Setup Python
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv python install 3.13

      - name: Install dependencies
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv sync --all-extras

      - name: Run tests
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run pytest tests/ -v --tb=short

      - name: Run linting
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv run ruff check src/

  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: [validate, test]
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      functionAppName: ${{ steps.deploy.outputs.functionAppName }}
      keyVaultName: ${{ steps.deploy.outputs.keyVaultName }}
      resourceGroupName: ${{ steps.deploy.outputs.resourceGroupName }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create resource group
        run: |
          RG_NAME="haymaker-dev-rg"
          echo "Creating resource group: $RG_NAME in ${{ env.AZURE_REGION }}"
          az group create \
            --name "$RG_NAME" \
            --location ${{ env.AZURE_REGION }} \
            --tags Environment=dev ManagedBy=GitHubActions Project=AzureHayMaker || echo "Resource group may already exist"

      - name: Deploy Bicep infrastructure
        id: deploy
        run: |
          echo "Deploying infrastructure to dev environment..."
          RG_NAME="haymaker-dev-rg"

          # Get the Object ID for the service principal (required for RBAC)
          echo "Looking up Service Principal Object ID..."
          SP_OBJECT_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)
          echo "Service Principal Object ID: $SP_OBJECT_ID"

          DEPLOYMENT_NAME="haymaker-dev-$(date +%Y%m%d-%H%M%S)"
          echo "Deployment name: $DEPLOYMENT_NAME"

          DEPLOYMENT_OUTPUT=$(az deployment group create \
            --name "$DEPLOYMENT_NAME" \
            --resource-group "$RG_NAME" \
            --template-file infra/bicep/main.bicep \
            --parameters infra/bicep/parameters/dev.bicepparam \
            --parameters adminObjectIds="['$SP_OBJECT_ID']" \
            --parameters githubOidcClientId="${{ secrets.AZURE_CLIENT_ID }}" \
            --output json)

          echo "Deployment complete. Extracting outputs..."

          FUNCTION_APP_NAME=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.functionAppName.value')
          KEY_VAULT_NAME=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.keyVaultName.value')
          RESOURCE_GROUP_NAME=$(echo $DEPLOYMENT_OUTPUT | jq -r '.properties.outputs.resourceGroupName.value')

          # Mask sensitive resource names to prevent exposure in logs
          echo "::add-mask::$FUNCTION_APP_NAME"
          echo "::add-mask::$KEY_VAULT_NAME"
          echo "::add-mask::$RESOURCE_GROUP_NAME"

          echo "functionAppName=$FUNCTION_APP_NAME" >> $GITHUB_OUTPUT
          echo "keyVaultName=$KEY_VAULT_NAME" >> $GITHUB_OUTPUT
          echo "resourceGroupName=$RESOURCE_GROUP_NAME" >> $GITHUB_OUTPUT

          echo "Deployment complete. Resource details masked for security."

      - name: Grant Key Vault Secrets Officer role
        run: |
          echo "Ensuring service principal has Key Vault Secrets Officer role..."

          # Get the Object ID again
          SP_OBJECT_ID=$(az ad sp show --id ${{ secrets.AZURE_CLIENT_ID }} --query id -o tsv)

          # Get Key Vault resource ID
          KEY_VAULT_ID=$(az keyvault show \
            --name ${{ steps.deploy.outputs.keyVaultName }} \
            --query id -o tsv)

          # Grant Key Vault Secrets Officer role (if not already assigned)
          # Role: Key Vault Secrets Officer (b86a8fe4-44ce-4948-aee5-eccb2c155cd7)
          echo "Assigning Key Vault Secrets Officer role to SP..."
          az role assignment create \
            --role "b86a8fe4-44ce-4948-aee5-eccb2c155cd7" \
            --assignee-object-id "$SP_OBJECT_ID" \
            --assignee-principal-type ServicePrincipal \
            --scope "$KEY_VAULT_ID" \
            --output none 2>/dev/null || echo "Role may already be assigned"

          echo "Role assignment complete"

      - name: Inject secrets to Key Vault
        run: |
          echo "Injecting secrets to Key Vault: ${{ steps.deploy.outputs.keyVaultName }}"
          echo "Waiting 60 seconds for RBAC role assignments to propagate..."
          sleep 60

          # Retry logic for secret injection (RBAC propagation can take time)
          MAX_RETRIES=3
          RETRY_DELAY=30

          for secret_name in "main-sp-client-secret" "anthropic-api-key" "log-analytics-workspace-key"; do
            echo "Setting secret: $secret_name"

            case $secret_name in
              "main-sp-client-secret")
                SECRET_VALUE="${{ secrets.MAIN_SP_CLIENT_SECRET }}"
                ;;
              "anthropic-api-key")
                SECRET_VALUE="${{ secrets.ANTHROPIC_API_KEY }}"
                ;;
              "log-analytics-workspace-key")
                SECRET_VALUE="${{ secrets.LOG_ANALYTICS_WORKSPACE_KEY }}"
                ;;
            esac

            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if az keyvault secret set \
                --vault-name ${{ steps.deploy.outputs.keyVaultName }} \
                --name $secret_name \
                --value "$SECRET_VALUE" \
                --output none 2>/dev/null; then
                echo "✓ Successfully set $secret_name"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "Failed to set $secret_name (attempt $RETRY_COUNT/$MAX_RETRIES). Waiting ${RETRY_DELAY}s before retry..."
                  sleep $RETRY_DELAY
                else
                  echo "ERROR: Failed to set $secret_name after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          done

          echo "All secrets injected successfully"

  deploy-function:
    name: Deploy Function App
    needs: [deploy-infrastructure]
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Setup Python
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          uv python install 3.13

      - name: Install dependencies
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cd src
          uv sync --no-dev

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Function App
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ needs.deploy-infrastructure.outputs.functionAppName }}
          package: ./src
          respect-funcignore: true

      - name: Verify deployment
        run: |
          echo "Waiting 30 seconds for Function App to initialize..."
          sleep 30

          FUNCTION_APP_URL="https://${{ needs.deploy-infrastructure.outputs.functionAppName }}.azurewebsites.net"
          echo "Testing Function App at: $FUNCTION_APP_URL"

          # Try to get status (may fail if endpoint doesn't exist yet, that's okay)
          curl -f -s "$FUNCTION_APP_URL/api/status" || echo "Status endpoint not yet available (expected for initial deployment)"

          echo "Deployment verified"

  smoke-tests:
    name: Run Smoke Tests
    needs: [deploy-infrastructure, deploy-function]
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify infrastructure resources
        run: |
          echo "Verifying Azure resources in ${{ needs.deploy-infrastructure.outputs.resourceGroupName }}..."

          # Check Function App
          az functionapp show \
            --name ${{ needs.deploy-infrastructure.outputs.functionAppName }} \
            --resource-group ${{ needs.deploy-infrastructure.outputs.resourceGroupName }} \
            --output none
          echo "✓ Function App exists"

          # Check Key Vault
          az keyvault show \
            --name ${{ needs.deploy-infrastructure.outputs.keyVaultName }} \
            --output none
          echo "✓ Key Vault exists"

          echo "All smoke tests passed!"
